<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_mixed_layer_restrat Module Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,'Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d4/de7/namespacemom__mixed__layer__restrat.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_mixed_layer_restrat Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>This module implements a parameterization of unresolved viscous mixed layer restratification of the mixed layer as described in Fox-Kemper, Ferrari and Hallberg (JPO, 2008), and whose impacts are described in Fox-Kemper et al. (Ocean Modelling).  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Control structure for module.  <a href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a27efc1d26cdf8b66108c3dad047bbb91"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#a27efc1d26cdf8b66108c3dad047bbb91">mixedlayer_restrat</a> (h, uhtr, vhtr, tv, fluxes, dt, MLD, G, GV, CS)</td></tr>
<tr class="memdesc:a27efc1d26cdf8b66108c3dad047bbb91"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability.  <a href="#a27efc1d26cdf8b66108c3dad047bbb91">More...</a><br /></td></tr>
<tr class="separator:a27efc1d26cdf8b66108c3dad047bbb91"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c3660ca67ff94ff55449ce75e362e32"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#a8c3660ca67ff94ff55449ce75e362e32">mixedlayer_restrat_general</a> (h, uhtr, vhtr, tv, fluxes, dt, MLD, G, GV, CS)</td></tr>
<tr class="memdesc:a8c3660ca67ff94ff55449ce75e362e32"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability.  <a href="#a8c3660ca67ff94ff55449ce75e362e32">More...</a><br /></td></tr>
<tr class="separator:a8c3660ca67ff94ff55449ce75e362e32"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa7bc0bffcb1f179da48339460555c343"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#aa7bc0bffcb1f179da48339460555c343">mixedlayer_restrat_bml</a> (h, uhtr, vhtr, tv, fluxes, dt, G, GV, CS)</td></tr>
<tr class="memdesc:aa7bc0bffcb1f179da48339460555c343"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability.  <a href="#aa7bc0bffcb1f179da48339460555c343">More...</a><br /></td></tr>
<tr class="separator:aa7bc0bffcb1f179da48339460555c343"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab6b9dc8021ca35426a71ede7cab7cdc7"><td class="memItemLeft" align="right" valign="top">logical function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#ab6b9dc8021ca35426a71ede7cab7cdc7">mixedlayer_restrat_init</a> (Time, G, GV, param_file, diag, CS)</td></tr>
<tr class="memdesc:ab6b9dc8021ca35426a71ede7cab7cdc7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the mixedlayer restratification module.  <a href="#ab6b9dc8021ca35426a71ede7cab7cdc7">More...</a><br /></td></tr>
<tr class="separator:ab6b9dc8021ca35426a71ede7cab7cdc7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aea597553dfa98cc7c972784f476ad3fc"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#aea597553dfa98cc7c972784f476ad3fc">mixedlayer_restrat_register_restarts</a> (HI, param_file, CS, restart_CS)</td></tr>
<tr class="memdesc:aea597553dfa98cc7c972784f476ad3fc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Allocate and regsiter fields in the mixedlayer restratification structure for restarts.  <a href="#aea597553dfa98cc7c972784f476ad3fc">More...</a><br /></td></tr>
<tr class="separator:aea597553dfa98cc7c972784f476ad3fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a6152d967622f3220bcf140dcf5f7b1fd"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=40)&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html#a6152d967622f3220bcf140dcf5f7b1fd">mod</a> = &quot;MOM_mixed_layer_restrat&quot;</td></tr>
<tr class="separator:a6152d967622f3220bcf140dcf5f7b1fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This module implements a parameterization of unresolved viscous mixed layer restratification of the mixed layer as described in Fox-Kemper, Ferrari and Hallberg (JPO, 2008), and whose impacts are described in Fox-Kemper et al. (Ocean Modelling). </p>
<p>The subroutine in this file implements a parameterization of unresolved viscous mixed layer restratification of the mixed layer as described in Fox-Kemper, Ferrari and Hallberg (JPO, 2008), and whose impacts are described in Fox-Kemper et al. (Ocean Modelling, 2011). This is derived in part from the older parameterizaton that is described in Hallberg (Aha Hulikoa, 2003), which this new parameterization surpasses, which in turn is based on the subinertial mixed layer theory of Young (JPO, 1994). There is no net horizontal volume transport due to this parameterization, and no direct effect below the mixed layer.</p>
<p>This parameterization sets the restratification timescale to agree high-resolution studies of mixed layer restratification. The run-time parameter FOX_KEMPER_ML_RESTRAT_COEF is a nondimensional number of order a few tens, proportional to the ratio of the deformation radius or the gridscale (whichever is smaller to the dominant horizontal lengthscale of the submesoscale mixed layer instabilities.</p>
<p>Macros written all in capital letters are defined in MOM_memory.h.</p>
<h1><a class="anchor" id="section_gridlayout"></a>
MOM grid layout</h1>
<p>A small fragment of the grid is shown below:</p>
<pre class="fragment">    j+1  x ^ x ^ x

    j+1  &gt; o &gt; o &gt;

    j    x ^ x ^ x

    j    &gt; o &gt; o &gt;

    j-1  x ^ x ^ x

        i-1  i  i+1

           i  i+1</pre><p>Fields at each point</p><ul>
<li>x = q, CoriolisBu</li>
<li>^ = v, PFv, CAv, vh, diffv, tauy, vbt, vhtr</li>
<li>&gt; = u, PFu, CAu, uh, diffu, taux, ubt, uhtr</li>
<li>o = h, bathyT, eta, T, S, tr</li>
</ul>
<p>The boundaries always run through q grid points (x). </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a27efc1d26cdf8b66108c3dad047bbb91"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_mixed_layer_restrat::mixedlayer_restrat </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>MLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>layer thickness (H units = m or kg/m2)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>accumulated zonal mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>accumulated merid mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>thermodynamic variables structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time increment (sec)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">mld</td><td>Mixed layer depth provided by PBL (H units)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00080">80</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>References <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00411">mixedlayer_restrat_bml()</a>, <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00107">mixedlayer_restrat_general()</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                     <span class="keywordtype">intent(inout)</span> :: g<span class="comment">      !&lt; ocean grid structure</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: h<span class="comment">      !&lt; layer thickness (H units = m or kg/m2)</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: uhtr<span class="comment">   !&lt; accumulated zonal mass flux (m3 or kg)</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: vhtr<span class="comment">   !&lt; accumulated merid mass flux (m3 or kg)</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                     <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">     !&lt; thermodynamic variables structure</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">type</span>(forcing),                             <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment"> !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; time increment (sec)</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,                      <span class="keywordtype">pointer</span>       :: mld<span class="comment">    !&lt; Mixed layer depth provided by PBL (H units)</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">type</span>(mixedlayer_restrat_cs),               <span class="keywordtype">pointer</span>       :: cs<span class="comment">     !&lt; module control structure</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordflow">if</span> (gv%nkml&gt;0) <span class="keywordflow">then</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keyword">call </span>mixedlayer_restrat_bml(h, uhtr, vhtr, tv, fluxes, dt, g, gv, cs)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keyword">call </span>mixedlayer_restrat_general(h, uhtr, vhtr, tv, fluxes, dt, mld, g, gv, cs)</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_a27efc1d26cdf8b66108c3dad047bbb91_cgraph.svg" width="100%" height="528"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="aa7bc0bffcb1f179da48339460555c343"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_mixed_layer_restrat::mixedlayer_restrat_bml </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>layer thickness (H units = m or kg/m2)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>accumulated zonal mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>accumulated merid mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>thermodynamic variables structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time increment (sec)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00411">411</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>References <a class="el" href="../../db/da5/MOM__diag__mediator_8F90_source.html#l00830">mom_diag_mediator::diag_update_target_grids()</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00080">mixedlayer_restrat()</a>.</p>
<div class="fragment"><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                     <span class="keywordtype">intent(in)</span>    :: g<span class="comment">      !&lt; ocean grid structure</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: h<span class="comment">      !&lt; layer thickness (H units = m or kg/m2)</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: uhtr<span class="comment">   !&lt; accumulated zonal mass flux (m3 or kg)</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: vhtr<span class="comment">   !&lt; accumulated merid mass flux (m3 or kg)</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                     <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">     !&lt; thermodynamic variables structure</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">type</span>(forcing),                             <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment"> !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">     !&lt; time increment (sec)</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordtype">type</span>(mixedlayer_restrat_cs),               <span class="keywordtype">pointer</span>       :: cs<span class="comment">     !&lt; module control structure</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keywordtype">real</span> :: uhml(szib_(g),szj_(g),szk_(g)) <span class="comment">! zonal mixed layer transport (m3/s or kg/s)</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordtype">real</span> :: vhml(szi_(g),szjb_(g),szk_(g)) <span class="comment">! merid mixed layer transport (m3/s or kg/s)</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    h_avail               <span class="comment">! The volume available for diffusion out of each face of each</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                          <span class="comment">! sublayer of the mixed layer, divided by dt, in units</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                          <span class="comment">! of H m2 s-1 (i.e., m3 s-1 or kg s-1).</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    htot, &amp;               <span class="comment">! The sum of the thicknesses of layers in the mixed layer (H units)</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    rml_av                <span class="comment">! g_Rho0 times the average mixed layer density (m s-2)</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordtype">real</span> :: g_rho0          <span class="comment">! G_Earth/Rho0 (m4 s-2 kg-1)</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keywordtype">real</span> :: rho0(szi_(g))   <span class="comment">! Potential density relative to the surface (kg m-3)</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keywordtype">real</span> :: p0(szi_(g))     <span class="comment">! A pressure of 0 (Pa)</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordtype">real</span> :: h_vel           <span class="comment">! htot interpolated onto velocity points (meter; not H)</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordtype">real</span> :: absf            <span class="comment">! absolute value of f, interpolated to velocity points (s-1)</span></div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="keywordtype">real</span> :: u_star          <span class="comment">! surface friction velocity, interpolated to velocity points (m s-1)</span></div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="keywordtype">real</span> :: mom_mixrate     <span class="comment">! rate at which momentum is homogenized within mixed layer (s-1)</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="keywordtype">real</span> :: timescale       <span class="comment">! mixing growth timescale (sec)</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="keywordtype">real</span> :: h_neglect       <span class="comment">! tiny thickness usually lost in roundoff and can be neglected (H units)</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="keywordtype">real</span> :: dz_neglect      <span class="comment">! tiny thickness (in m) that usually lost in roundoff and can be neglected (meter)</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordtype">real</span> :: i4dt            <span class="comment">! 1/(4 dt)</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="keywordtype">real</span> :: i2htot          <span class="comment">! Twice the total mixed layer thickness at velocity points (H units)</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="keywordtype">real</span> :: z_topx2         <span class="comment">! depth of the top of a layer at velocity points (H units)</span></div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">real</span> :: hx2             <span class="comment">! layer thickness at velocity points (H units)</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordtype">real</span> :: a(szk_(g))      <span class="comment">! A nondimensional value relating the overall flux</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                          <span class="comment">! magnitudes (uDml &amp; vDml) to the realized flux in a</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;                          <span class="comment">! layer.  The vertical sum of a() through the pieces of</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;                          <span class="comment">! the mixed layer must be 0.</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">real</span> :: udml(szib_(g))  <span class="comment">! The zonal and meridional volume fluxes in the upper</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">real</span> :: vdml(szi_(g))   <span class="comment">! half of the mixed layer in H m2 s-1 (m3 s-1 or kg s-1).</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">real</span> :: utimescale_diag(szib_(g),szj_(g)) <span class="comment">! The restratification timescales</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">real</span> :: vtimescale_diag(szi_(g),szjb_(g)) <span class="comment">! in the zonal and meridional</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                                            <span class="comment">! directions (sec), stored in 2-D</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                                            <span class="comment">! arrays for diagnostic purposes.</span></div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordtype">real</span> :: udml_diag(szib_(g),szj_(g)), vdml_diag(szi_(g),szjb_(g))</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordtype">logical</span> :: use_eos    <span class="comment">! If true, density is calculated from T &amp; S using an equation of state.</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isq, ieq, jsq, jeq, nz, nkml</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  is  = g%isc  ; ie  = g%iec  ; js  = g%jsc  ; je  = g%jec ; nz = g%ke</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB ; nkml = gv%nkml</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;         <span class="stringliteral">&quot;Module must be initialized before it is used.&quot;</span>)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordflow">if</span> ((nkml&lt;2) .or. (cs%ml_restrat_coef&lt;=0.0)) <span class="keywordflow">return</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  udml(:)    = 0.0 ; vdml(:) = 0.0</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  i4dt       = 0.25 / dt</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  g_rho0     = g%g_Earth/gv%Rho0</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  use_eos    = <span class="keyword">associated</span>(tv%eqn_of_state)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  h_neglect  = gv%H_subroundoff</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  dz_neglect = gv%H_subroundoff*gv%H_to_m</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <span class="keywordflow">if</span> (.not.use_eos) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;         <span class="stringliteral">&quot;An equation of state must be used with this module.&quot;</span>)</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  <span class="comment">! Fix this later for nkml &gt;= 3.</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  p0(:) = 0.0</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,G,GV,htot,Rml_av,tv,p0,h,h_avail,         &amp;</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">!$OMP                               h_neglect,g_Rho0,I4dt,CS,uhml,uhtr,dt,vhml,vhtr,   &amp;</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">!$OMP                               utimescale_diag,vtimescale_diag,fluxes,dz_neglect, &amp;</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">!$OMP                               uDml_diag,vDml_diag,nkml)                          &amp;</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="comment">!$OMP                       private(Rho0,h_vel,u_star,absf,mom_mixrate,timescale,uDml, &amp;</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;<span class="comment">!$OMP                               I2htot,z_topx2,hx2,a,vDml)</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      htot(i,j) = 0.0 ; rml_av(i,j) = 0.0</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keywordflow">do</span> k=1,nkml</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,k),tv%S(:,j,k),p0,rho0(:),is-1,ie-is+3,tv%eqn_of_state)</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        rml_av(i,j) = rml_av(i,j) + h(i,j,k)*rho0(i)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        htot(i,j) = htot(i,j) + h(i,j,k)</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        h_avail(i,j,k) = max(i4dt*g%areaT(i,j)*(h(i,j,k)-gv%Angstrom),0.0)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;      rml_av(i,j) = (g_rho0*rml_av(i,j)) / (htot(i,j) + h_neglect)</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">! TO DO:</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">!   1. Mixing extends below the mixing layer to the mixed layer.  Find it!</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;<span class="comment">!   2. Add exponential tail to streamfunction?</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">!   U - Component</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; utimescale_diag(i,j) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keywordflow">do</span> i=is,ie ; vtimescale_diag(i,j) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      h_vel = 0.5*(htot(i,j) + htot(i+1,j)) * gv%H_to_m</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      u_star = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i+1,j))</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;      absf = 0.5*(abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      <span class="comment">! peak ML visc: u_star * 0.41 * (h_ml*u_star)/(absf*h_ml + 4.0*u_star)</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;      <span class="comment">! momentum mixing rate: pi^2*visc/h_ml^2</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;      <span class="comment">! 0.41 is the von Karmen constant, 9.8696 = pi^2.</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;      mom_mixrate = (0.41*9.8696)*u_star**2 / &amp;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                    (absf*h_vel**2 + 4.0*(h_vel+dz_neglect)*u_star)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;      timescale = 0.0625 * (absf + 2.0*mom_mixrate) / (absf**2 + mom_mixrate**2)</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      timescale = timescale * cs%ml_restrat_coef</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">!        timescale = timescale*(2?)*(L_def/L_MLI)*min(EKE/MKE,1.0 + G%dyCv(i,j)**2/L_def**2))</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;      utimescale_diag(i,j) = timescale</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;      udml(i) = timescale * g%mask2dCu(i,j)*g%dyCu(i,j)* &amp;</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;          g%IdxCu(i,j)*(rml_av(i+1,j)-rml_av(i,j)) * (h_vel**2 * gv%m_to_H)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;      <span class="keywordflow">if</span> (udml(i) == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="keywordflow">do</span> k=1,nkml ; uhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        i2htot = 1.0 / (htot(i,j) + htot(i+1,j) + h_neglect)</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        z_topx2 = 0.0</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="comment">! a(k) relates the sublayer transport to uDml with a linear profile.</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="comment">! The sum of a(k) through the mixed layers must be 0.</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="keywordflow">do</span> k=1,nkml</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;          hx2 = (h(i,j,k) + h(i+1,j,k) + h_neglect)</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;          a(k) = (hx2 * i2htot) * (2.0 - 4.0*(z_topx2+0.5*hx2)*i2htot)</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;          z_topx2 = z_topx2 + hx2</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;          <span class="keywordflow">if</span> (a(k)*udml(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;            <span class="keywordflow">if</span> (a(k)*udml(i) &gt; h_avail(i,j,k)) udml(i) = h_avail(i,j,k) / a(k)</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;            <span class="keywordflow">if</span> (-a(k)*udml(i) &gt; h_avail(i+1,j,k)) udml(i) = -h_avail(i+1,j,k)/a(k)</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="keywordflow">do</span> k=1,nkml</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;          uhml(i,j,k) = a(k)*udml(i)</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;          uhtr(i,j,k) = uhtr(i,j,k) + uhml(i,j,k)*dt</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    udml_diag(is:ie,j) = udml(is:ie)</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">!  V- component</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    h_vel = 0.5*(htot(i,j) + htot(i,j+1)) * gv%H_to_m</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    u_star = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i,j+1))</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    absf = 0.5*(abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="comment">! peak ML visc: u_star * 0.41 * (h_ml*u_star)/(absf*h_ml + 4.0*u_star)</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="comment">! momentum mixing rate: pi^2*visc/h_ml^2</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    <span class="comment">! 0.41 is the von Karmen constant, 9.8696 = pi^2.</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    mom_mixrate = (0.41*9.8696)*u_star**2 / &amp;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                  (absf*h_vel**2 + 4.0*(h_vel+dz_neglect)*u_star)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    timescale = 0.0625 * (absf + 2.0*mom_mixrate) / (absf**2 + mom_mixrate**2)</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    timescale = timescale * cs%ml_restrat_coef</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="comment">!        timescale = timescale*(2?)*(L_def/L_MLI)*min(EKE/MKE,1.0 + G%dyCv(i,j)**2/L_def**2))</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;    vtimescale_diag(i,j) = timescale</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    vdml(i) = timescale * g%mask2dCv(i,j)*g%dxCv(i,j)* &amp;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        g%IdyCv(i,j)*(rml_av(i,j+1)-rml_av(i,j)) * (h_vel**2 * gv%m_to_H)</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    <span class="keywordflow">if</span> (vdml(i) == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;      <span class="keywordflow">do</span> k=1,nkml ; vhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;      i2htot = 1.0 / (htot(i,j) + htot(i,j+1) + h_neglect)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      z_topx2 = 0.0</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;      <span class="comment">! a(k) relates the sublayer transport to uDml with a linear profile.</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      <span class="comment">! The sum of a(k) through the mixed layers must be 0.</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;      <span class="keywordflow">do</span> k=1,nkml</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;        hx2 = (h(i,j,k) + h(i,j+1,k) + h_neglect)</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        a(k) = (hx2 * i2htot) * (2.0 - 4.0*(z_topx2+0.5*hx2)*i2htot)</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        z_topx2 = z_topx2 + hx2</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">if</span> (a(k)*vdml(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;          <span class="keywordflow">if</span> (a(k)*vdml(i) &gt; h_avail(i,j,k)) vdml(i) = h_avail(i,j,k) / a(k)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;          <span class="keywordflow">if</span> (-a(k)*vdml(i) &gt; h_avail(i,j+1,k)) vdml(i) = -h_avail(i,j+1,k)/a(k)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      <span class="keywordflow">do</span> k=1,nkml</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        vhml(i,j,k) = a(k)*vdml(i)</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        vhtr(i,j,k) = vhtr(i,j,k) + vhml(i,j,k)*dt</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    vdml_diag(is:ie,j) = vdml(is:ie)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> k=1,nkml ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    h(i,j,k) = h(i,j,k) - dt*g%IareaT(i,j) * &amp;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        ((uhml(i,j,k) - uhml(i-1,j,k)) + (vhml(i,j,k) - vhml(i,j-1,k)))</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;  <span class="comment">! Whenever thickness changes let the diag manager know, target grids</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  <span class="comment">! for vertical remapping may need to be regenerated.</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keyword">call </span>diag_update_target_grids(cs%diag)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;  <span class="comment">! Offer diagnostic fields for averaging.</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  <span class="keywordflow">if</span> (query_averaging_enabled(cs%diag) .and. &amp;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    ((cs%id_urestrat_time &gt; 0)  .or. (cs%id_vrestrat_time &gt; 0))) <span class="keywordflow">then</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="keyword">call </span>post_data(cs%id_urestrat_time, utimescale_diag, cs%diag)</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="keyword">call </span>post_data(cs%id_vrestrat_time, vtimescale_diag, cs%diag)</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <span class="keywordflow">if</span> (query_averaging_enabled(cs%diag) .and. &amp;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      ((cs%id_uhml&gt;0) .or. (cs%id_vhml&gt;0))) <span class="keywordflow">then</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="keywordflow">do</span> k=nkml+1,nz</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq ; uhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie ; vhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">if</span> (cs%id_uhml &gt; 0) <span class="keyword">call </span>post_data(cs%id_uhml, uhml,      cs%diag)</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">if</span> (cs%id_vhml &gt; 0) <span class="keyword">call </span>post_data(cs%id_vhml, vhml,      cs%diag)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;    <span class="keywordflow">if</span> (cs%id_MLD  &gt; 0) <span class="keyword">call </span>post_data(cs%id_MLD,  htot,      cs%diag)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    <span class="keywordflow">if</span> (cs%id_Rml  &gt; 0) <span class="keyword">call </span>post_data(cs%id_Rml,  rml_av,    cs%diag)</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keywordflow">if</span> (cs%id_uDml &gt; 0) <span class="keyword">call </span>post_data(cs%id_uDml, udml_diag, cs%diag)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordflow">if</span> (cs%id_vDml &gt; 0) <span class="keyword">call </span>post_data(cs%id_vDml, vdml_diag, cs%diag)</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_aa7bc0bffcb1f179da48339460555c343_cgraph.svg" width="100%" height="462"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_aa7bc0bffcb1f179da48339460555c343_icgraph.svg" width="352" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a8c3660ca67ff94ff55449ce75e362e32"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_mixed_layer_restrat::mixedlayer_restrat_general </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing), intent(in)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), pointer&#160;</td>
          <td class="paramname"><em>MLD</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does interface depth diffusion. The fluxes are limited to give positive definiteness, and the diffusivities are limited to guarantee stability. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>layer thickness (H units = m or kg/m2)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">uhtr</td><td>accumulated zonal mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">vhtr</td><td>accumulated merid mass flux (m3 or kg)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>thermodynamic variables structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fluxes</td><td>pointers to forcing fields</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time increment (sec)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">mld</td><td>Mixed layer depth provided by PBL (H units)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00107">107</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>References <a class="el" href="../../db/da5/MOM__diag__mediator_8F90_source.html#l00830">mom_diag_mediator::diag_update_target_grids()</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00080">mixedlayer_restrat()</a>.</p>
<div class="fragment"><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                     <span class="keywordtype">intent(inout)</span> :: g<span class="comment">       !&lt; ocean grid structure</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span> :: h<span class="comment">       !&lt; layer thickness (H units = m or kg/m2)</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: uhtr<span class="comment">    !&lt; accumulated zonal mass flux (m3 or kg)</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span> :: vhtr<span class="comment">    !&lt; accumulated merid mass flux (m3 or kg)</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                     <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">      !&lt; thermodynamic variables structure</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordtype">type</span>(forcing),                             <span class="keywordtype">intent(in)</span>    :: fluxes<span class="comment">  !&lt; pointers to forcing fields</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">      !&lt; time increment (sec)</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,                      <span class="keywordtype">pointer</span>       :: mld<span class="comment">     !&lt; Mixed layer depth provided by PBL (H units)</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordtype">type</span>(mixedlayer_restrat_cs),               <span class="keywordtype">pointer</span>       :: cs<span class="comment">      !&lt; module control structure</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keywordtype">real</span> :: uhml(szib_(g),szj_(g),szk_(g)) <span class="comment">! zonal mixed layer transport (m3/s or kg/s)</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="keywordtype">real</span> :: vhml(szi_(g),szjb_(g),szk_(g)) <span class="comment">! merid mixed layer transport (m3/s or kg/s)</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    h_avail               <span class="comment">! The volume available for diffusion out of each face of each</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;                          <span class="comment">! sublayer of the mixed layer, divided by dt, in units</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;                          <span class="comment">! of H * m2 s-1 (i.e., m3 s-1 or kg s-1).</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    htot, &amp;               <span class="comment">! The sum of the thicknesses of layers in the mixed layer (H units)</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    rml_av                <span class="comment">! g_Rho0 times the average mixed layer density (m s-2)</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keywordtype">real</span> :: g_rho0          <span class="comment">! G_Earth/Rho0 (m4 s-2 kg-1)</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keywordtype">real</span> :: rho0(szi_(g))   <span class="comment">! Potential density relative to the surface (kg m-3)</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordtype">real</span> :: p0(szi_(g))     <span class="comment">! A pressure of 0 (Pa)</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordtype">real</span> :: h_vel           <span class="comment">! htot interpolated onto velocity points in metre (not H).</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keywordtype">real</span> :: absf            <span class="comment">! absolute value of f, interpolated to velocity points (s-1)</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordtype">real</span> :: u_star          <span class="comment">! surface friction velocity, interpolated to velocity points (m s-1)</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <span class="keywordtype">real</span> :: mom_mixrate     <span class="comment">! rate at which momentum is homogenized within mixed layer (s-1)</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="keywordtype">real</span> :: timescale       <span class="comment">! mixing growth timescale (sec)</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="keywordtype">real</span> :: h_neglect       <span class="comment">! tiny thickness usually lost in roundoff so can be neglected (H units)</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="keywordtype">real</span> :: dz_neglect      <span class="comment">! A tiny thickness (in m) that is usually lost in roundoff so can be neglected</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordtype">real</span> :: i4dt            <span class="comment">! 1/(4 dt) (sec-1)</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordtype">real</span> :: ihtot           <span class="comment">! total mixed layer thickness</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordtype">real</span> :: a(szk_(g))      <span class="comment">! A nondimensional value relating the overall flux</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;                          <span class="comment">! magnitudes (uDml &amp; vDml) to the realized flux in a</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                          <span class="comment">! layer.  The vertical sum of a() through the pieces of</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;                          <span class="comment">! the mixed layer must be 0.</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordtype">real</span> :: udml(szib_(g))  <span class="comment">! The zonal and meridional volume fluxes in the upper</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keywordtype">real</span> :: vdml(szi_(g))   <span class="comment">! half of the mixed layer in H m2 s-1 (m3 s-1 or kg s-1).</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordtype">real</span> :: utimescale_diag(szib_(g),szj_(g)) <span class="comment">! restratification timescales</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keywordtype">real</span> :: vtimescale_diag(szi_(g),szjb_(g)) <span class="comment">! in the zonal and meridional</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;                                            <span class="comment">! directions, in s, stored in 2-D</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;                                            <span class="comment">! arrays for diagnostic purposes.</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="keywordtype">real</span> :: udml_diag(szib_(g),szj_(g)), vdml_diag(szi_(g),szjb_(g))</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isq, ieq, jsq, jeq, nz</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: rhosurf, deltarhoatkm1, deltarhoatk, dk, dkm1, pref_mld <span class="comment">! Used for MLD</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span> :: rhoatk, rho1, d1, pref_n2 <span class="comment">! Used for N2</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordtype">real</span> :: afac, bfac, ddrho</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="keywordtype">real</span> :: hatvel, zihabovevel, zihbelowvel</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordtype">real</span> :: psi, psi1, z <span class="comment">! For statement function</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">! Stream function as a function of non-dimensional position within mixed-layer (F77 statement function)</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="comment">!PSI(z) = max(0., (1. - (2.*z+1.)**2 ) )</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  psi1(z) = max(0., (1. - (2.*z+1.)**2 ) * (1. + (5./21.)*(2.*z+1.)**2) )</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="keywordtype">real</span> :: bottop, xp, psic, dd</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  bottop(z) = 0.5*(1.-sign(1.,z+0.5)) <span class="comment">! =0 for z&gt;-0.5, =1 for z&lt;-0.5</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  xp(z) = max(0., min(1., (-z-0.5)*2./(1.+2.*cs%MLE_tail_dh) ) )</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  dd(z) = (1.-3.*(xp(z)**2)+2.*(xp(z)**3))**(1.+2.*cs%MLE_tail_dh)</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  psic(z) = max( psi1(z), dd(z)*bottop(z) )</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  psi(z) = psic(z)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  is  = g%isc  ; ie  = g%iec  ; js  = g%jsc  ; je  = g%jec ; nz = g%ke</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  isq = g%IscB ; ieq = g%IecB ; jsq = g%JscB ; jeq = g%JecB</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(tv%eqn_of_state)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;         <span class="stringliteral">&quot;An equation of state must be used with this module.&quot;</span>)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="keywordflow">if</span> (cs%MLE_density_diff &gt; 0.) <span class="keywordflow">then</span> <span class="comment">! We need to calculate a mixed layer depth, MLD.</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">!! TODO: use derivatives and mid-MLD pressure. Currently this is sigma-0. -AJA</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    pref_mld(:) = 0.</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <span class="keywordflow">do</span> j = js-1, je+1</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      dk(:) = 0.5 * h(:,j,1) * gv%H_to_m <span class="comment">! Depth of center of surface layer</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,1), tv%S(:,j,1), pref_mld, rhosurf, is-1, ie-is+3, tv%eqn_of_state)</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      deltarhoatk(:) = 0.</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      cs%MLD(:,j) = 0.</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      <span class="keywordflow">do</span> k = 2, nz</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        dkm1(:) = dk(:) <span class="comment">! Depth of center of layer K-1</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        dk(:) = dk(:) + 0.5 * ( h(:,j,k) + h(:,j,k-1) ) * gv%H_to_m <span class="comment">! Depth of center of layer K</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="comment">! Mixed-layer depth, using sigma-0 (surface reference pressure)</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        deltarhoatkm1(:) = deltarhoatk(:) <span class="comment">! Store value from previous iteration of K</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="keyword">call </span>calculate_density(tv%T(:,j,k), tv%S(:,j,k), pref_mld, deltarhoatk, is-1, ie-is+3, tv%eqn_of_state)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        deltarhoatk(:) = deltarhoatk(:) - rhosurf(:) <span class="comment">! Density difference between layer K and surface</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keywordflow">do</span> i = is-1, ie+1</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;          ddrho = deltarhoatk(i) - deltarhoatkm1(i)</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;          <span class="keywordflow">if</span> ((cs%MLD(i,j)==0.) .and. (ddrho&gt;0.) .and. &amp;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;              (deltarhoatkm1(i)&lt;cs%MLE_density_diff) .and. (deltarhoatk(i)&gt;=cs%MLE_density_diff)) <span class="keywordflow">then</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;            afac = ( cs%MLE_density_diff - deltarhoatkm1(i) ) / ddrho</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;            cs%MLD(i,j) = dk(i) * afac + dkm1(i) * (1. - afac)</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! i-loop</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! k-loop</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="keywordflow">do</span> i = is-1, ie+1</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        <span class="keywordflow">if</span> ((cs%MLD(i,j)==0.) .and. (deltarhoatk(i)&lt;cs%MLE_density_diff)) cs%MLD(i,j) = dk(i) <span class="comment">! Assume mixing to the bottom</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! j-loop</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="keywordflow">elseif</span> (cs%MLE_use_PBL_MLD .and. cs%MLE_MLD_decay_time&gt;=0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(mld)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;         <span class="stringliteral">&quot;Argument MLD was not associated!&quot;</span>)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      <span class="keyword">call </span>hchksum(cs%MLD_filtered,<span class="stringliteral">&#39;mixed_layer_restrat: MLD_filtered&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      <span class="keyword">call </span>hchksum(mld,<span class="stringliteral">&#39;mixed_layer_restrat: MLD in&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    afac = cs%MLE_MLD_decay_time / ( dt + cs%MLE_MLD_decay_time )</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    bfac = dt / ( dt + cs%MLE_MLD_decay_time )</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordflow">do</span> j = js-1, je+1 ; <span class="keywordflow">do</span> i = is-1, ie+1</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      <span class="comment">! Expression bFac*MLD(i,j) + aFac*CS%MLD_filtered(i,j) is the time-filtered</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      <span class="comment">! (running mean) of MLD. The max() allows the &quot;running mean&quot; to be reset</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      <span class="comment">! instantly to a deeper MLD.</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      cs%MLD_filtered(i,j) = max( mld(i,j), bfac*mld(i,j) + afac*cs%MLD_filtered(i,j) )</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      cs%MLD(i,j) = cs%MLD_filtered(i,j)</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_mixedlayer_restrat: &quot;</span>// &amp;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;         <span class="stringliteral">&quot;No MLD to use for MLE parameterization.&quot;</span>)</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  udml(:) = 0.0 ; vdml(:) = 0.0</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  i4dt = 0.25 / dt</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  g_rho0 = g%g_Earth/gv%Rho0</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  dz_neglect = gv%H_subroundoff*gv%H_to_m</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  p0(:) = 0.0</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,G,GV,htot,Rml_av,tv,p0,h,h_avail,         &amp;</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">!$OMP                               h_neglect,g_Rho0,I4dt,CS,uhml,uhtr,dt,vhml,vhtr,   &amp;</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">!$OMP                               utimescale_diag,vtimescale_diag,fluxes,dz_neglect, &amp;</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">!$OMP                               nz,MLD,uDml_diag,vDml_diag)                        &amp;</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">!$OMP                       private(Rho0,h_vel,u_star,absf,mom_mixrate,timescale,uDml, &amp;</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">!$OMP                               a,vDml,IhTot,zIHbelowVel,hAtVel,zIHaboveVel)</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      htot(i,j) = 0.0 ; rml_av(i,j) = 0.0</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;      <span class="keyword">call </span>calculate_density(tv%T(:,j,k),tv%S(:,j,k),p0,rho0(:),is-1,ie-is+3,tv%eqn_of_state)</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">if</span> (htot(i,j) &lt; cs%MLD(i,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          rml_av(i,j) = rml_av(i,j) + h(i,j,k)*rho0(i)</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;          htot(i,j) = htot(i,j) + h(i,j,k)</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        h_avail(i,j,k) = max(i4dt*g%areaT(i,j)*(h(i,j,k)-gv%Angstrom),0.0)</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;      rml_av(i,j) = -(g_rho0*rml_av(i,j)) / (htot(i,j) + h_neglect)</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    <span class="keyword">call </span>hchksum(h,<span class="stringliteral">&#39;mixed_layer_restrat: h&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keyword">call </span>hchksum(fluxes%ustar,<span class="stringliteral">&#39;mixed_layer_restrat: u*&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    <span class="keyword">call </span>hchksum(cs%MLD,<span class="stringliteral">&#39;mixed_layer_restrat: MLD&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keyword">call </span>hchksum(rml_av,<span class="stringliteral">&#39;mixed_layer_restrat: rml&#39;</span>,g,haloshift=1)</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">! TO DO:</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">!   1. Mixing extends below the mixing layer to the mixed layer.  Find it!</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">!   2. Add exponential tail to streamfunction?</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">!   U - Component</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    h_vel = 0.5*((htot(i,j) + htot(i+1,j)) + h_neglect) * gv%H_to_m</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    u_star = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i+1,j))</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    absf = 0.5*(abs(g%CoriolisBu(i,j-1)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="comment">! peak ML visc: u_star * 0.41 * (h_ml*u_star)/(absf*h_ml + 4.0*u_star)</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="comment">! momentum mixing rate: pi^2*visc/h_ml^2</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="comment">! 0.41 is the von Karmen constant, 9.8696 = pi^2.</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    mom_mixrate = (0.41*9.8696)*u_star**2 / &amp;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                  (absf*h_vel**2 + 4.0*(h_vel+dz_neglect)*u_star)</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    timescale = 0.0625 * (absf + 2.0*mom_mixrate) / (absf**2 + mom_mixrate**2)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    timescale = timescale * cs%ml_restrat_coef</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">!     timescale = timescale*(2?)*(L_def/L_MLI)*min(EKE/MKE,1.0 + G%dyCv(i,j)**2/L_def**2))</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    udml(i) = timescale * g%mask2dCu(i,j)*g%dyCu(i,j)* &amp;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        g%IdxCu(i,j)*(rml_av(i+1,j)-rml_av(i,j)) * (h_vel**2 * gv%m_to_H)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">if</span> (udml(i) == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; uhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;      ihtot = 2.0 / ((htot(i,j) + htot(i+1,j)) + h_neglect)</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      zihbelowvel = 0.0</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="comment">! a(k) relates the sublayer transport to uDml with a linear profile.</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;      <span class="comment">! The sum of a(k) through the mixed layers must be 0.</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        hatvel = 0.5*(h(i,j,k) + h(i+1,j,k))</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        zihabovevel = zihbelowvel                    <span class="comment">! z/H for upper interface</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        zihbelowvel = zihbelowvel - (hatvel * ihtot) <span class="comment">! z/H for lower interface</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        a(k) = psi( zihabovevel ) - psi( zihbelowvel )</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        <span class="keywordflow">if</span> (a(k)*udml(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;          <span class="keywordflow">if</span> (a(k)*udml(i) &gt; h_avail(i,j,k)) udml(i) = h_avail(i,j,k) / a(k)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="keywordflow">elseif</span> (a(k)*udml(i) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;          <span class="keywordflow">if</span> (-a(k)*udml(i) &gt; h_avail(i+1,j,k)) udml(i) = -h_avail(i+1,j,k) / a(k)</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        uhml(i,j,k) = a(k)*udml(i)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        uhtr(i,j,k) = uhtr(i,j,k) + uhml(i,j,k)*dt</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    utimescale_diag(i,j) = timescale</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    udml_diag(i,j) = udml(i)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">!  V- component</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    h_vel = 0.5*((htot(i,j) + htot(i,j+1)) + h_neglect) * gv%H_to_m</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    u_star = 0.5*(fluxes%ustar(i,j) + fluxes%ustar(i,j+1))</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    absf = 0.5*(abs(g%CoriolisBu(i-1,j)) + abs(g%CoriolisBu(i,j)))</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="comment">! peak ML visc: u_star * 0.41 * (h_ml*u_star)/(absf*h_ml + 4.0*u_star)</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    <span class="comment">! momentum mixing rate: pi^2*visc/h_ml^2</span></div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">! 0.41 is the von Karmen constant, 9.8696 = pi^2.</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    mom_mixrate = (0.41*9.8696)*u_star**2 / &amp;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                  (absf*h_vel**2 + 4.0*(h_vel+dz_neglect)*u_star)</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    timescale = 0.0625 * (absf + 2.0*mom_mixrate) / (absf**2 + mom_mixrate**2)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    timescale = timescale * cs%ml_restrat_coef</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">!     timescale = timescale*(2?)*(L_def/L_MLI)*min(EKE/MKE,1.0 + G%dyCv(i,j)**2/L_def**2))</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    vdml(i) = timescale * g%mask2dCv(i,j)*g%dxCv(i,j)* &amp;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        g%IdyCv(i,j)*(rml_av(i,j+1)-rml_av(i,j)) * (h_vel**2 * gv%m_to_H)</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">if</span> (vdml(i) == 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; vhml(i,j,k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      ihtot = 2.0 / ((htot(i,j) + htot(i,j+1)) + h_neglect)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;      zihbelowvel = 0.0</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      <span class="comment">! a(k) relates the sublayer transport to uDml with a linear profile.</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      <span class="comment">! The sum of a(k) through the mixed layers must be 0.</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        hatvel = 0.5*(h(i,j,k) + h(i,j+1,k))</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        zihabovevel = zihbelowvel                    <span class="comment">! z/H for upper interface</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        zihbelowvel = zihbelowvel - (hatvel * ihtot) <span class="comment">! z/H for lower interface</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        a(k) = psi( zihabovevel ) - psi( zihbelowvel )</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        <span class="keywordflow">if</span> (a(k)*vdml(i) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;          <span class="keywordflow">if</span> (a(k)*vdml(i) &gt; h_avail(i,j,k)) vdml(i) = h_avail(i,j,k) / a(k)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="keywordflow">elseif</span> (a(k)*vdml(i) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;          <span class="keywordflow">if</span> (-a(k)*vdml(i) &gt; h_avail(i,j+1,k)) vdml(i) = -h_avail(i,j+1,k) / a(k)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        vhml(i,j,k) = a(k)*vdml(i)</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        vhtr(i,j,k) = vhtr(i,j,k) + vhml(i,j,k)*dt</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    vtimescale_diag(i,j) = timescale</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    vdml_diag(i,j) = vdml(i)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    h(i,j,k) = h(i,j,k) - dt*g%IareaT(i,j) * &amp;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        ((uhml(i,j,k) - uhml(i-1,j,k)) + (vhml(i,j,k) - vhml(i,j-1,k)))</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="comment">! Whenever thickness changes let the diag manager know, target grids</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="comment">! for vertical remapping may need to be regenerated.</span></div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <span class="comment">! This needs to happen after the H update and before the next post_data.</span></div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  <span class="keyword">call </span>diag_update_target_grids(cs%diag)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="comment">! Offer diagnostic fields for averaging.</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordflow">if</span> (query_averaging_enabled(cs%diag)) <span class="keywordflow">then</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">if</span> (cs%id_urestrat_time &gt; 0) <span class="keyword">call </span>post_data(cs%id_urestrat_time, utimescale_diag, cs%diag)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">if</span> (cs%id_vrestrat_time &gt; 0) <span class="keyword">call </span>post_data(cs%id_vrestrat_time, vtimescale_diag, cs%diag)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keywordflow">if</span> (cs%id_uhml          &gt; 0) <span class="keyword">call </span>post_data(cs%id_uhml, uhml, cs%diag)</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">if</span> (cs%id_vhml          &gt; 0) <span class="keyword">call </span>post_data(cs%id_vhml, vhml, cs%diag)</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">if</span> (cs%id_MLD           &gt; 0) <span class="keyword">call </span>post_data(cs%id_MLD, cs%MLD, cs%diag)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordflow">if</span> (cs%id_Rml           &gt; 0) <span class="keyword">call </span>post_data(cs%id_Rml, rml_av, cs%diag)</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordflow">if</span> (cs%id_uDml          &gt; 0) <span class="keyword">call </span>post_data(cs%id_uDml, udml_diag, cs%diag)</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keywordflow">if</span> (cs%id_vDml          &gt; 0) <span class="keyword">call </span>post_data(cs%id_vDml, vdml_diag, cs%diag)</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">if</span> (cs%id_uml &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        h_vel = 0.5*((htot(i,j) + htot(i+1,j)) + h_neglect)</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;        udml_diag(i,j) = udml_diag(i,j) / (0.01*h_vel) * g%IdyCu(i,j) * (psi(0.)-psi(-.01))</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      <span class="keyword">call </span>post_data(cs%id_uml, udml_diag, cs%diag)</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <span class="keywordflow">if</span> (cs%id_vml &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        h_vel = 0.5*((htot(i,j) + htot(i,j+1)) + h_neglect)</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        vdml_diag(i,j) = vdml_diag(i,j) / (0.01*h_vel) * g%IdxCv(i,j) * (psi(0.)-psi(-.01))</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      <span class="keyword">call </span>post_data(cs%id_vml, vdml_diag, cs%diag)</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_a8c3660ca67ff94ff55449ce75e362e32_cgraph.svg" width="100%" height="462"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_a8c3660ca67ff94ff55449ce75e362e32_icgraph.svg" width="364" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ab6b9dc8021ca35426a71ede7cab7cdc7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical function, public mom_mixed_layer_restrat::mixedlayer_restrat_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the mixedlayer restratification module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>parameter file to parse</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>regulate diagnostics</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00642">642</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>References <a class="el" href="../../d6/ddb/MOM__file__parser_8F90_source.html#l01185">mom_file_parser::log_version()</a>, <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00072">mod</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>
<div class="fragment"><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="keywordtype">type</span>(time_type),             <span class="keywordtype">intent(in)</span>    :: time<span class="comment">       !&lt; current model time</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),       <span class="keywordtype">intent(inout)</span> :: g<span class="comment">          !&lt; ocean grid structure</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),     <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">         !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="keywordtype">type</span>(param_file_type),       <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; parameter file to parse</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>,     <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">       !&lt; regulate diagnostics</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="keywordtype">type</span>(mixedlayer_restrat_cs), <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; module control structure</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=48)</span>  :: flux_units</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keyword">call </span>log_version(param_file, mod, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MIXEDLAYER_RESTRAT&quot;</span>, mixedlayer_restrat_init, &amp;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;             <span class="stringliteral">&quot;If true, a density-gradient dependent re-stratifying \n&quot;</span>//&amp;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;             <span class="stringliteral">&quot;flow is imposed in the mixed layer. Can be used in ALE mode\n&quot;</span>//&amp;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;             <span class="stringliteral">&quot;without restriction but in layer mode can only be used if\n&quot;</span>//&amp;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;             <span class="stringliteral">&quot;BULKMIXEDLAYER is true.&quot;</span>, default=.false.)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordflow">if</span> (.not. mixedlayer_restrat_init) <span class="keywordflow">return</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;mixedlayer_restrat_init called without an &quot;</span>// &amp;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;                            <span class="stringliteral">&quot;associated control structure.&quot;</span>)</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="comment">! Nonsense values to cause problems when these parameters are not used</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  cs%MLE_MLD_decay_time = -9.e9</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  cs%MLE_density_diff = -9.e9</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  cs%MLE_tail_dh = -9.e9</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  cs%MLE_use_PBL_MLD = .false.</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, default=.false., do_not_log=.true.)</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;FOX_KEMPER_ML_RESTRAT_COEF&quot;</span>, cs%ml_restrat_coef, &amp;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;             <span class="stringliteral">&quot;A nondimensional coefficient that is proportional to \n&quot;</span>//&amp;</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;             <span class="stringliteral">&quot;the ratio of the deformation radius to the dominant \n&quot;</span>//&amp;</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;             <span class="stringliteral">&quot;lengthscale of the submesoscale mixed layer \n&quot;</span>//&amp;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;             <span class="stringliteral">&quot;instabilities, times the minimum of the ratio of the \n&quot;</span>//&amp;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;             <span class="stringliteral">&quot;mesoscale eddy kinetic energy to the large-scale \n&quot;</span>//&amp;</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;             <span class="stringliteral">&quot;geostrophic kinetic energy or 1 plus the square of the \n&quot;</span>//&amp;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;             <span class="stringliteral">&quot;grid spacing over the deformation radius, as detailed \n&quot;</span>//&amp;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;             <span class="stringliteral">&quot;by Fox-Kemper et al. (2010)&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="comment">! We use GV%nkml to distinguish between the old and new implementation of MLE.</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="comment">! The old implementation only works for the layer model with nkml&gt;0.</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordflow">if</span> (gv%nkml==0) <span class="keywordflow">then</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MLE_USE_PBL_MLD&quot;</span>, cs%MLE_use_PBL_MLD, &amp;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;             <span class="stringliteral">&quot;If true, the MLE parameterization will use the mixed-layer\n&quot;</span>//&amp;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;             <span class="stringliteral">&quot;depth provided by the active PBL parameterization. If false,\n&quot;</span>//&amp;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;             <span class="stringliteral">&quot;MLE will estimate a MLD based on a density difference with the\n&quot;</span>//&amp;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;             <span class="stringliteral">&quot;surface using the parameter MLE_DENSITY_DIFF.&quot;</span>, default=.false.)</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keywordflow">if</span> (cs%MLE_use_PBL_MLD) <span class="keywordflow">then</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MLE_MLD_DECAY_TIME&quot;</span>, cs%MLE_MLD_decay_time, &amp;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;             <span class="stringliteral">&quot;When MLE_USE_PBL_MLD is true, the PBL provided active miing layer\n&quot;</span>//&amp;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;             <span class="stringliteral">&quot;depth is running mean average with this time-scale when the MLD\n&quot;</span>//&amp;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;             <span class="stringliteral">&quot;is retreating. When the MLD deepens below the current running-mean\n&quot;</span>//&amp;</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;             <span class="stringliteral">&quot;the runn-mean is instantaneously set to the current MLD.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>, default=0.)</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MLE_DENSITY_DIFF&quot;</span>, cs%MLE_density_diff, &amp;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;             <span class="stringliteral">&quot;Density difference used to detect the mixed-layer\n&quot;</span>//&amp;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;             <span class="stringliteral">&quot;depth used for the mixed-layer eddy parameterization\n&quot;</span>//&amp;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;             <span class="stringliteral">&quot;by Fox-Kemper et al. (2010)&quot;</span>, units=<span class="stringliteral">&quot;kg/m3&quot;</span>, default=0.03)</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MLE_TAIL_DH&quot;</span>, cs%MLE_tail_dh, &amp;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;             <span class="stringliteral">&quot;Fraction by which to extend the mixed-layer restratification\n&quot;</span>//&amp;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;             <span class="stringliteral">&quot;depth used for a smoother stream function at the base of\n&quot;</span>//&amp;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;             <span class="stringliteral">&quot;the mixed-layer.&quot;</span>, units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="keywordflow">if</span> (gv%Boussinesq) <span class="keywordflow">then</span> ; flux_units = <span class="stringliteral">&quot;meter3 second-1&quot;</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="keywordflow">else</span> ; flux_units = <span class="stringliteral">&quot;kilogram second-1&quot;</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  cs%id_uhml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhml&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;      <span class="stringliteral">&#39;Zonal Thickness Flux to Restratify Mixed Layer&#39;</span>, flux_units)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  cs%id_vhml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhml&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;      <span class="stringliteral">&#39;Meridional Thickness Flux to Restratify Mixed Layer&#39;</span>, flux_units)</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  cs%id_urestrat_time = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MLu_restrat_time&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;      <span class="stringliteral">&#39;Mixed Layer Zonal Restratification Timescale&#39;</span>, <span class="stringliteral">&#39;second&#39;</span>)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  cs%id_vrestrat_time = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MLv_restrat_time&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;      <span class="stringliteral">&#39;Mixed Layer Meridional Restratification Timescale&#39;</span>, <span class="stringliteral">&#39;second&#39;</span>)</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  cs%id_MLD = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;MLD_restrat&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;      <span class="stringliteral">&#39;Mixed Layer Depth as used in the mixed-layer restratification parameterization&#39;</span>, <span class="stringliteral">&#39;meter&#39;</span>)</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  cs%id_Rml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ML_buoy_restrat&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;      <span class="stringliteral">&#39;Mixed Layer Buoyancy as used in the mixed-layer restratification parameterization&#39;</span>, <span class="stringliteral">&#39;m/s^2&#39;</span>)</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  cs%id_uDml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;udml_restrat&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      <span class="stringliteral">&#39;Transport stream function amplitude for zonal restratification of mixed layer&#39;</span>, <span class="stringliteral">&#39;m3/s&#39;</span>)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  cs%id_vDml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vdml_restrat&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;      <span class="stringliteral">&#39;Transport stream function amplitude for meridional restratification of mixed layer&#39;</span>, <span class="stringliteral">&#39;m3/s&#39;</span>)</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  cs%id_uml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uml_restrat&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <span class="stringliteral">&#39;Surface zonal velocity component of mixed layer restratification&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  cs%id_vml = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vml_restrat&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;      <span class="stringliteral">&#39;Surface meridional velocity component of mixed layer restratification&#39;</span>, <span class="stringliteral">&#39;m/s&#39;</span>)</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="comment">! If MLD_filtered is being used, we need to update halo regions after a restart</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%MLD_filtered)) <span class="keyword">call </span>pass_var(cs%MLD_filtered, g%domain)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_ab6b9dc8021ca35426a71ede7cab7cdc7_cgraph.svg" width="502" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aea597553dfa98cc7c972784f476ad3fc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_mixed_layer_restrat::mixedlayer_restrat_register_restarts </td>
          <td>(</td>
          <td class="paramtype">type(hor_index_type), intent(in)&#160;</td>
          <td class="paramname"><em>HI</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d8/d91/structmom__mixed__layer__restrat_1_1mixedlayer__restrat__cs.html">mixedlayer_restrat_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(mom_restart_cs), pointer&#160;</td>
          <td class="paramname"><em>restart_CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Allocate and regsiter fields in the mixedlayer restratification structure for restarts. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">hi</td><td>Horizontal index structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>Parameter file to parse</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>Module control structure</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">restart_cs</td><td>Restart structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00742">742</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>References <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00072">mod</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="../../d7/dde/MOM__io_8F90_source.html#l00537">mom_io::var_desc()</a>.</p>

<p>Referenced by <a class="el" href="../../d8/da7/MOM_8F90_source.html#l01360">mom::initialize_mom()</a>.</p>
<div class="fragment"><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;  <span class="keywordtype">type</span>(hor_index_type),        <span class="keywordtype">intent(in)</span>    :: hi<span class="comment">         !&lt; Horizontal index structure</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <span class="keywordtype">type</span>(param_file_type),       <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; Parameter file to parse</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordtype">type</span>(mixedlayer_restrat_cs), <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; Module control structure</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  <span class="keywordtype">type</span>(mom_restart_cs),        <span class="keywordtype">pointer</span>       :: restart_cs<span class="comment"> !&lt; Restart structure</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordtype">type</span>(vardesc) :: vd</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  <span class="keywordtype">logical</span> :: mixedlayer_restrat_init</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="comment">! Check to see if this module will be used</span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MIXEDLAYER_RESTRAT&quot;</span>, mixedlayer_restrat_init, &amp;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;             default=.false., do_not_log=.true.)</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keywordflow">if</span> (.not. mixedlayer_restrat_init) <span class="keywordflow">return</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="comment">! Allocate the control structure. CS will be later populated by mixedlayer_restrat_init()</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;       <span class="stringliteral">&quot;mixedlayer_restrat_register_restarts called with an associated control structure.&quot;</span>)</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="comment">! CS%MLD is used either for the internally diagnosed MLD or</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="comment">! for keep a running mean of the PBL&#39;s actively mixed MLD.</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  <span class="keyword">allocate</span>(cs%MLD(hi%isd:hi%ied,hi%jsd:hi%jed)) ; cs%MLD(:,:) = 0.</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;MLE_USE_PBL_MLD&quot;</span>, cs%MLE_use_PBL_MLD, &amp;</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;             default=.false., do_not_log=.true.)</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordflow">if</span> (cs%MLE_use_PBL_MLD) <span class="keywordflow">then</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keyword">allocate</span>(cs%MLD_filtered(hi%isd:hi%ied,hi%jsd:hi%jed)) ; cs%MLD_filtered(:,:) = 0.</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    vd = var_desc(<span class="stringliteral">&quot;MLD_MLE_filtered&quot;</span>,<span class="stringliteral">&quot;m&quot;</span>,<span class="stringliteral">&quot;Time-filtered MLD for use in MLE&quot;</span>, &amp;</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                  hor_grid=<span class="stringliteral">&#39;h&#39;</span>, z_grid=<span class="stringliteral">&#39;1&#39;</span>)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    <span class="keyword">call </span>register_restart_field(cs%MLD_filtered, vd, .false., restart_cs)</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_aea597553dfa98cc7c972784f476ad3fc_cgraph.svg" width="100%" height="371"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d4/de7/namespacemom__mixed__layer__restrat_aea597553dfa98cc7c972784f476ad3fc_icgraph.svg" width="459" height="67"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a6152d967622f3220bcf140dcf5f7b1fd"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=40) mom_mixed_layer_restrat::mod = &quot;MOM_mixed_layer_restrat&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00072">72</a> of file <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html">MOM_mixed_layer_restrat.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00642">mixedlayer_restrat_init()</a>, and <a class="el" href="../../d9/d41/MOM__mixed__layer__restrat_8F90_source.html#l00742">mixedlayer_restrat_register_restarts()</a>.</p>
<div class="fragment"><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">character(len=40)  :: mod = &quot;MOM_mixed_layer_restrat&quot;  ! This module&#39;s name.</span></div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d4/de7/namespacemom__mixed__layer__restrat.html">mom_mixed_layer_restrat</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
