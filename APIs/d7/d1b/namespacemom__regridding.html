<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_regridding Module Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,'Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/d1b/namespacemom__regridding.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_regridding Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Generates vertical grids as part of the ALE algorithm.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Regridding control structure.  <a href="../../d9/d41/structmom__regridding_1_1regridding__cs.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a44ba264b71ed6239e0016708a0f58fe9"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a44ba264b71ed6239e0016708a0f58fe9">initialize_regridding</a> (nk, coordMode, interpScheme, CS, compressibility_fraction)</td></tr>
<tr class="memdesc:a44ba264b71ed6239e0016708a0f58fe9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialization of regridding.  <a href="#a44ba264b71ed6239e0016708a0f58fe9">More...</a><br /></td></tr>
<tr class="separator:a44ba264b71ed6239e0016708a0f58fe9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f55ab3a80ab1202b7664e9c65ebf08b"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a9f55ab3a80ab1202b7664e9c65ebf08b">end_regridding</a> (CS)</td></tr>
<tr class="memdesc:a9f55ab3a80ab1202b7664e9c65ebf08b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deallocation of regridding memory.  <a href="#a9f55ab3a80ab1202b7664e9c65ebf08b">More...</a><br /></td></tr>
<tr class="separator:a9f55ab3a80ab1202b7664e9c65ebf08b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1a4ef08eafeb47fe9c96d08d736b16b1"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a1a4ef08eafeb47fe9c96d08d736b16b1">regridding_main</a> (remapCS, CS, G, GV, h, tv, h_new, dzInterface)</td></tr>
<tr class="separator:a1a4ef08eafeb47fe9c96d08d736b16b1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a25136915d797aa14491ca778370f46f8"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a25136915d797aa14491ca778370f46f8">calc_h_new_by_dz</a> (G, GV, h, dzInterface, h_new)</td></tr>
<tr class="memdesc:a25136915d797aa14491ca778370f46f8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates h_new from h + delta_k dzInterface.  <a href="#a25136915d797aa14491ca778370f46f8">More...</a><br /></td></tr>
<tr class="separator:a25136915d797aa14491ca778370f46f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a810d6a0658d645ac7a9e2b6680ce819c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a810d6a0658d645ac7a9e2b6680ce819c">check_remapping_grid</a> (G, GV, h, dzInterface, msg)</td></tr>
<tr class="memdesc:a810d6a0658d645ac7a9e2b6680ce819c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check that the total thickness of two grids match.  <a href="#a810d6a0658d645ac7a9e2b6680ce819c">More...</a><br /></td></tr>
<tr class="separator:a810d6a0658d645ac7a9e2b6680ce819c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab2a6be87039f49176d91a494126d8430"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ab2a6be87039f49176d91a494126d8430">check_grid_column</a> (nk, depth, h, dzInterface, msg)</td></tr>
<tr class="memdesc:ab2a6be87039f49176d91a494126d8430"><td class="mdescLeft">&#160;</td><td class="mdescRight">Check that the total thickness of new and old grids are consistent.  <a href="#ab2a6be87039f49176d91a494126d8430">More...</a><br /></td></tr>
<tr class="separator:ab2a6be87039f49176d91a494126d8430"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9dddf53999f90d1a4edc79179c5b5da4"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a9dddf53999f90d1a4edc79179c5b5da4">filtered_grid_motion</a> (CS, nk, z_old, z_new, dz_g)</td></tr>
<tr class="memdesc:a9dddf53999f90d1a4edc79179c5b5da4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Returns the change in interface position motion after filtering and assuming the top and bottom interfaces do not move. The filtering is a function of depth, and is applied as the integrated average filtering over the trajectory of the interface. By design, this code can not give tangled interfaces provided that z_old and z_new are not already tangled.  <a href="#a9dddf53999f90d1a4edc79179c5b5da4">More...</a><br /></td></tr>
<tr class="separator:a9dddf53999f90d1a4edc79179c5b5da4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae49eb6807ab2559382afe3a56f0c8793"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ae49eb6807ab2559382afe3a56f0c8793">build_zstar_grid</a> (CS, G, GV, h, dzInterface)</td></tr>
<tr class="memdesc:ae49eb6807ab2559382afe3a56f0c8793"><td class="mdescLeft">&#160;</td><td class="mdescRight">Builds a z*-ccordinate grid with partial steps (Adcroft and Campin, 2004). z* is defined as z* = (z-eta)/(H+eta)*H s.t. z*=0 when z=eta and z*=-H when z=-H .  <a href="#ae49eb6807ab2559382afe3a56f0c8793">More...</a><br /></td></tr>
<tr class="separator:ae49eb6807ab2559382afe3a56f0c8793"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1fe77f09d8e5ea5eae1a0cff087d5464"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a1fe77f09d8e5ea5eae1a0cff087d5464">build_zstar_column</a> (CS, nz, depth, total_thickness, zInterface, z_rigid_top, eta_orig)</td></tr>
<tr class="memdesc:a1fe77f09d8e5ea5eae1a0cff087d5464"><td class="mdescLeft">&#160;</td><td class="mdescRight">Builds a z* coordinate with a minimum thickness.  <a href="#a1fe77f09d8e5ea5eae1a0cff087d5464">More...</a><br /></td></tr>
<tr class="separator:a1fe77f09d8e5ea5eae1a0cff087d5464"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a455d807ccfbbfd109be231321bec1038"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a455d807ccfbbfd109be231321bec1038">build_sigma_grid</a> (CS, G, GV, h, dzInterface)</td></tr>
<tr class="separator:a455d807ccfbbfd109be231321bec1038"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a58a19305bbdab26bfa4f336dfac8c4f8"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a58a19305bbdab26bfa4f336dfac8c4f8">build_rho_grid</a> (G, GV, h, tv, dzInterface, remapCS, CS)</td></tr>
<tr class="separator:a58a19305bbdab26bfa4f336dfac8c4f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3375da62433b875eed537feeba1ae1b3"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a3375da62433b875eed537feeba1ae1b3">build_grid_hycom1</a> (G, GV, h, tv, dzInterface, remapCS, CS)</td></tr>
<tr class="memdesc:a3375da62433b875eed537feeba1ae1b3"><td class="mdescLeft">&#160;</td><td class="mdescRight">Builds a simple HyCOM-like grid with the deepest location of potential density interpolated from the column profile and a clipping of depth for each interface to a fixed z* or p* grid. This should probably be (optionally?) changed to find the nearest location of the target density.  <a href="#a3375da62433b875eed537feeba1ae1b3">More...</a><br /></td></tr>
<tr class="separator:a3375da62433b875eed537feeba1ae1b3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adbdde4ab6606ab76f64f57b7ee5dfdeb"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#adbdde4ab6606ab76f64f57b7ee5dfdeb">build_grid_slight</a> (G, GV, h, tv, dzInterface, remapCS, CS)</td></tr>
<tr class="memdesc:adbdde4ab6606ab76f64f57b7ee5dfdeb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Builds a grid that tracks density interfaces for water that is denser than the surface density plus an increment of some number of layers, and uses all lighter layers uniformly above this location. Note that this amounts to interpolating to find the depth of an arbitrary (non-integer) interface index which should make the results vary smoothly in space to the extent that the surface density and interior stratification vary smoothly in space. Over shallow topography, this will tend to give a uniform sigma-like coordinate. For sufficiently shallow water, a minimum grid spacing is used to avoid certain instabilities.  <a href="#adbdde4ab6606ab76f64f57b7ee5dfdeb">More...</a><br /></td></tr>
<tr class="separator:adbdde4ab6606ab76f64f57b7ee5dfdeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aacf680ddf88e9c41a340dd426272906d"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aacf680ddf88e9c41a340dd426272906d">rho_interfaces_col</a> (rho_col, h_col, z_col, rho_tgt, nz, z_col_new, CS, reliable, debug)</td></tr>
<tr class="memdesc:aacf680ddf88e9c41a340dd426272906d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Finds the new interface locations in a column of water that match the prescribed target densities.  <a href="#aacf680ddf88e9c41a340dd426272906d">More...</a><br /></td></tr>
<tr class="separator:aacf680ddf88e9c41a340dd426272906d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab18f7ea3cfa3c3892cb69086e3a4baef"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ab18f7ea3cfa3c3892cb69086e3a4baef">adjust_interface_motion</a> (nk, min_thickness, h_old, dz_int)</td></tr>
<tr class="memdesc:ab18f7ea3cfa3c3892cb69086e3a4baef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Adjust dz_Interface to ensure non-negative future thicknesses.  <a href="#ab18f7ea3cfa3c3892cb69086e3a4baef">More...</a><br /></td></tr>
<tr class="separator:ab18f7ea3cfa3c3892cb69086e3a4baef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53fe5957610e488f1fb9052ff69007ec"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a53fe5957610e488f1fb9052ff69007ec">build_grid_arbitrary</a> (G, GV, h, dzInterface, h_new, CS)</td></tr>
<tr class="separator:a53fe5957610e488f1fb9052ff69007ec"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a580e775df53e4bb61f118fcab44a3f92"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a580e775df53e4bb61f118fcab44a3f92">regridding_set_ppolys</a> (densities, CS, n0, h0, ppoly0_E, ppoly0_S, ppoly0_coefficients, degree)</td></tr>
<tr class="memdesc:a580e775df53e4bb61f118fcab44a3f92"><td class="mdescLeft">&#160;</td><td class="mdescRight">Given the set of target values and cell densities, this routine builds an interpolated profile for the densities within each grid cell. It may happen that, given a high-order interpolator, the number of available layers is insufficient (e.g., there are two available layers for a third-order PPM ih4 scheme). In these cases, we resort to the simplest continuous linear scheme (P1M h2).  <a href="#a580e775df53e4bb61f118fcab44a3f92">More...</a><br /></td></tr>
<tr class="separator:a580e775df53e4bb61f118fcab44a3f92"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a12dff5ec4c479e77db1813a8d53db7c2"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a12dff5ec4c479e77db1813a8d53db7c2">interpolate_grid</a> (n0, h0, x0, ppoly0_E, ppoly0_coefficients, target_values, degree, n1, h1, x1)</td></tr>
<tr class="separator:a12dff5ec4c479e77db1813a8d53db7c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ec0dea34ca979892fcaf54a2c676c5e"><td class="memItemLeft" align="right" valign="top">real function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a6ec0dea34ca979892fcaf54a2c676c5e">get_polynomial_coordinate</a> (N, h, x_g, ppoly_E, ppoly_coefficients, target_value, degree)</td></tr>
<tr class="separator:a6ec0dea34ca979892fcaf54a2c676c5e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aeb36a31003c4887ea1af82c11c627f2f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aeb36a31003c4887ea1af82c11c627f2f">inflate_vanished_layers_old</a> (CS, G, GV, h)</td></tr>
<tr class="separator:aeb36a31003c4887ea1af82c11c627f2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a392230123ef4347e6fe6c0b847be60bc"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a392230123ef4347e6fe6c0b847be60bc">old_inflate_layers_1d</a> (minThickness, N, h)</td></tr>
<tr class="separator:a392230123ef4347e6fe6c0b847be60bc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aac58190f39678cb94e0f918455804f43"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aac58190f39678cb94e0f918455804f43">convective_adjustment</a> (G, GV, h, tv)</td></tr>
<tr class="separator:aac58190f39678cb94e0f918455804f43"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8b3b0c1555006f196d9bb1baededd9e6"><td class="memItemLeft" align="right" valign="top">real function, dimension(nk), public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a8b3b0c1555006f196d9bb1baededd9e6">uniformresolution</a> (nk, coordMode, maxDepth, rhoLight, rhoHeavy)</td></tr>
<tr class="separator:a8b3b0c1555006f196d9bb1baededd9e6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4f0b5a0e798c4cf8e70a63ed3bc62c6f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a4f0b5a0e798c4cf8e70a63ed3bc62c6f">setcoordinateresolution</a> (dz, CS)</td></tr>
<tr class="separator:a4f0b5a0e798c4cf8e70a63ed3bc62c6f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d0d0a1095ab370feb260753e1c25ffa"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a8d0d0a1095ab370feb260753e1c25ffa">set_target_densities_from_gv</a> (GV, CS)</td></tr>
<tr class="memdesc:a8d0d0a1095ab370feb260753e1c25ffa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set target densities based on the old Rlay variable.  <a href="#a8d0d0a1095ab370feb260753e1c25ffa">More...</a><br /></td></tr>
<tr class="separator:a8d0d0a1095ab370feb260753e1c25ffa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae7eade38ab8e2adb0797a7191ddebb18"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ae7eade38ab8e2adb0797a7191ddebb18">set_target_densities</a> (CS, rho_int)</td></tr>
<tr class="memdesc:ae7eade38ab8e2adb0797a7191ddebb18"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set target densities based on vector of interface values.  <a href="#ae7eade38ab8e2adb0797a7191ddebb18">More...</a><br /></td></tr>
<tr class="separator:ae7eade38ab8e2adb0797a7191ddebb18"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aac547ec199090852d539c7aefc44dfa7"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aac547ec199090852d539c7aefc44dfa7">set_regrid_max_depths</a> (CS, max_depths, units_to_H)</td></tr>
<tr class="memdesc:aac547ec199090852d539c7aefc44dfa7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set maximum interface depths based on a vector of input values.  <a href="#aac547ec199090852d539c7aefc44dfa7">More...</a><br /></td></tr>
<tr class="separator:aac547ec199090852d539c7aefc44dfa7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae91ca3f1376b3c72940268b5d9f87bb4"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ae91ca3f1376b3c72940268b5d9f87bb4">set_regrid_max_thickness</a> (CS, max_h, units_to_H)</td></tr>
<tr class="memdesc:ae91ca3f1376b3c72940268b5d9f87bb4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set maximum layer thicknesses based on a vector of input values.  <a href="#ae91ca3f1376b3c72940268b5d9f87bb4">More...</a><br /></td></tr>
<tr class="separator:ae91ca3f1376b3c72940268b5d9f87bb4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aea8e51bd450503f56264f7bd468a51fc"><td class="memItemLeft" align="right" valign="top">real function, dimension(cs%nk), public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aea8e51bd450503f56264f7bd468a51fc">getcoordinateresolution</a> (CS)</td></tr>
<tr class="separator:aea8e51bd450503f56264f7bd468a51fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abfaa6d8cb64908f5bd1f39f517fa491d"><td class="memItemLeft" align="right" valign="top">real function, dimension(cs%nk+1), public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#abfaa6d8cb64908f5bd1f39f517fa491d">getcoordinateinterfaces</a> (CS)</td></tr>
<tr class="memdesc:abfaa6d8cb64908f5bd1f39f517fa491d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Query the target coordinate interface positions.  <a href="#abfaa6d8cb64908f5bd1f39f517fa491d">More...</a><br /></td></tr>
<tr class="separator:abfaa6d8cb64908f5bd1f39f517fa491d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad693fbb3424bb0ba9d0ad8878828e604"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=20) function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ad693fbb3424bb0ba9d0ad8878828e604">getcoordinateunits</a> (CS)</td></tr>
<tr class="separator:ad693fbb3424bb0ba9d0ad8878828e604"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac1e1f08a6d33ab71e6a3c5008c519ee6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=20) function, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ac1e1f08a6d33ab71e6a3c5008c519ee6">getcoordinateshortname</a> (CS)</td></tr>
<tr class="separator:ac1e1f08a6d33ab71e6a3c5008c519ee6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac384596d1d07e413bbed37c71e0571e0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ac384596d1d07e413bbed37c71e0571e0">set_regrid_params</a> (CS, boundary_extrapolation, min_thickness, old_grid_weight, depth_of_time_filter_shallow, depth_of_time_filter_deep, compress_fraction, dz_min_surface, nz_fixed_surface, Rho_ML_avg_depth, nlay_ML_to_interior, fix_haloclines, halocline_filt_len, halocline_strat_tol, integrate_downward_for_e, height_of_rigid_surface)</td></tr>
<tr class="memdesc:ac384596d1d07e413bbed37c71e0571e0"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine can be used to set many of the parameters for MOM_regridding.  <a href="#ac384596d1d07e413bbed37c71e0571e0">More...</a><br /></td></tr>
<tr class="separator:ac384596d1d07e413bbed37c71e0571e0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1587a58d8fe87432c3f7817952014584"><td class="memItemLeft" align="right" valign="top">real function, dimension(cs%nk), public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a1587a58d8fe87432c3f7817952014584">getstaticthickness</a> (CS, SSH, depth)</td></tr>
<tr class="separator:a1587a58d8fe87432c3f7817952014584"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1e43d303ef28350aec4021c82d4a871c"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a1e43d303ef28350aec4021c82d4a871c">allocate_regridding</a> (CS)</td></tr>
<tr class="separator:a1e43d303ef28350aec4021c82d4a871c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad568490b3c428e17fa5ce90ec95ac681"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ad568490b3c428e17fa5ce90ec95ac681">regridding_memory_deallocation</a> (CS)</td></tr>
<tr class="memdesc:ad568490b3c428e17fa5ce90ec95ac681"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deallocate memory for regridding.  <a href="#ad568490b3c428e17fa5ce90ec95ac681">More...</a><br /></td></tr>
<tr class="separator:ad568490b3c428e17fa5ce90ec95ac681"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:aa3774cbe40d09c83979b47d1c65abb9e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=320), parameter, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aa3774cbe40d09c83979b47d1c65abb9e">regriddingcoordinatemodedoc</a> = &quot; LAYER - Isopycnal or stacked shallow water layers\n&quot;// &quot; Z* - stetched geopotential z*\n&quot;// &quot; SIGMA - terrain following coordinates\n&quot;// &quot; RHO - continuous isopycnal\n&quot;// &quot; HYCOM1 - HyCOM-like hybrid coordinate\n&quot;// &quot; SLIGHT - stretched coordinates above continuous isopycnal&quot;</td></tr>
<tr class="memdesc:aa3774cbe40d09c83979b47d1c65abb9e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Documentation for coordinate options.  <a href="#aa3774cbe40d09c83979b47d1c65abb9e">More...</a><br /></td></tr>
<tr class="separator:aa3774cbe40d09c83979b47d1c65abb9e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a027751c5d8c22c800460f8197df1f4c5"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=338), parameter, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a027751c5d8c22c800460f8197df1f4c5">regriddinginterpschemedoc</a> = &quot; P1M_H2 (2nd-order accurate)\n&quot;// &quot; P1M_H4 (2nd-order accurate)\n&quot;// &quot; P1M_IH4 (2nd-order accurate)\n&quot;// &quot; PLM (2nd-order accurate)\n&quot;// &quot; PPM_H4 (3rd-order accurate)\n&quot;// &quot; PPM_IH4 (3rd-order accurate)\n&quot;// &quot; P3M_IH4IH3 (4th-order accurate)\n&quot;// &quot; P3M_IH6IH5 (4th-order accurate)\n&quot;// &quot; PQM_IH4IH3 (4th-order accurate)\n&quot;// &quot; PQM_IH6IH5 (5th-order accurate)&quot;</td></tr>
<tr class="separator:a027751c5d8c22c800460f8197df1f4c5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4c5f1f52df457e8ee30d68919e1de8e7"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=6), parameter, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a4c5f1f52df457e8ee30d68919e1de8e7">regriddingdefaultinterpscheme</a> = &quot;P1M_H2&quot;</td></tr>
<tr class="separator:a4c5f1f52df457e8ee30d68919e1de8e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace083ec9749efc2bcb7d3a33b97c0678"><td class="memItemLeft" align="right" valign="top">logical, parameter, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#ace083ec9749efc2bcb7d3a33b97c0678">regriddingdefaultboundaryextrapolation</a> = .false.</td></tr>
<tr class="separator:ace083ec9749efc2bcb7d3a33b97c0678"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a219230a6fd36ab9b6ec19109f60fdcee"><td class="memItemLeft" align="right" valign="top">real, parameter, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a219230a6fd36ab9b6ec19109f60fdcee">regriddingdefaultminthickness</a> = 1.e-3</td></tr>
<tr class="separator:a219230a6fd36ab9b6ec19109f60fdcee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7eda7ea8fdd3798039f9d6522eccf9c0"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a7eda7ea8fdd3798039f9d6522eccf9c0">interpolation_p1m_h2</a> = 0</td></tr>
<tr class="memdesc:a7eda7ea8fdd3798039f9d6522eccf9c0"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^2)  <a href="#a7eda7ea8fdd3798039f9d6522eccf9c0">More...</a><br /></td></tr>
<tr class="separator:a7eda7ea8fdd3798039f9d6522eccf9c0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a039c1e7c026255de9a9b3d99c990d36d"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a039c1e7c026255de9a9b3d99c990d36d">interpolation_p1m_h4</a> = 1</td></tr>
<tr class="memdesc:a039c1e7c026255de9a9b3d99c990d36d"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^2)  <a href="#a039c1e7c026255de9a9b3d99c990d36d">More...</a><br /></td></tr>
<tr class="separator:a039c1e7c026255de9a9b3d99c990d36d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e15f9dd8d3efba9829d7744832cfdda"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a4e15f9dd8d3efba9829d7744832cfdda">interpolation_p1m_ih4</a> = 2</td></tr>
<tr class="memdesc:a4e15f9dd8d3efba9829d7744832cfdda"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^2)  <a href="#a4e15f9dd8d3efba9829d7744832cfdda">More...</a><br /></td></tr>
<tr class="separator:a4e15f9dd8d3efba9829d7744832cfdda"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53b032a6eaf0888d71c53b27e319fd2c"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a53b032a6eaf0888d71c53b27e319fd2c">interpolation_plm</a> = 3</td></tr>
<tr class="memdesc:a53b032a6eaf0888d71c53b27e319fd2c"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^2)  <a href="#a53b032a6eaf0888d71c53b27e319fd2c">More...</a><br /></td></tr>
<tr class="separator:a53b032a6eaf0888d71c53b27e319fd2c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a189db45b112ccae6ce5d5490c6918ed3"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a189db45b112ccae6ce5d5490c6918ed3">interpolation_ppm_h4</a> = 4</td></tr>
<tr class="memdesc:a189db45b112ccae6ce5d5490c6918ed3"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^3)  <a href="#a189db45b112ccae6ce5d5490c6918ed3">More...</a><br /></td></tr>
<tr class="separator:a189db45b112ccae6ce5d5490c6918ed3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaa80921eae24c6441c43d9bb21db4f00"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aaa80921eae24c6441c43d9bb21db4f00">interpolation_ppm_ih4</a> = 5</td></tr>
<tr class="memdesc:aaa80921eae24c6441c43d9bb21db4f00"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^3)  <a href="#aaa80921eae24c6441c43d9bb21db4f00">More...</a><br /></td></tr>
<tr class="separator:aaa80921eae24c6441c43d9bb21db4f00"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a63511fbcf190d2e7e339c93b2e9719f4"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a63511fbcf190d2e7e339c93b2e9719f4">interpolation_p3m_ih4ih3</a> = 6</td></tr>
<tr class="memdesc:a63511fbcf190d2e7e339c93b2e9719f4"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^4)  <a href="#a63511fbcf190d2e7e339c93b2e9719f4">More...</a><br /></td></tr>
<tr class="separator:a63511fbcf190d2e7e339c93b2e9719f4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abd33f3410142055d6ee03073d8c6a90e"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#abd33f3410142055d6ee03073d8c6a90e">interpolation_p3m_ih6ih5</a> = 7</td></tr>
<tr class="memdesc:abd33f3410142055d6ee03073d8c6a90e"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^4)  <a href="#abd33f3410142055d6ee03073d8c6a90e">More...</a><br /></td></tr>
<tr class="separator:abd33f3410142055d6ee03073d8c6a90e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaa3636bd6128ccf9511d4efccc81e920"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aaa3636bd6128ccf9511d4efccc81e920">interpolation_pqm_ih4ih3</a> = 8</td></tr>
<tr class="memdesc:aaa3636bd6128ccf9511d4efccc81e920"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^4)  <a href="#aaa3636bd6128ccf9511d4efccc81e920">More...</a><br /></td></tr>
<tr class="separator:aaa3636bd6128ccf9511d4efccc81e920"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf9e92418c890836cf597f05dbae52b4"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#aaf9e92418c890836cf597f05dbae52b4">interpolation_pqm_ih6ih5</a> = 9</td></tr>
<tr class="memdesc:aaf9e92418c890836cf597f05dbae52b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">O(h^5)  <a href="#aaf9e92418c890836cf597f05dbae52b4">More...</a><br /></td></tr>
<tr class="separator:aaf9e92418c890836cf597f05dbae52b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39adf48fc3f4b7ef0f544875a82d8c45"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a39adf48fc3f4b7ef0f544875a82d8c45">degree_1</a> = 1</td></tr>
<tr class="memdesc:a39adf48fc3f4b7ef0f544875a82d8c45"><td class="mdescLeft">&#160;</td><td class="mdescRight">List of interpolant degrees.  <a href="#a39adf48fc3f4b7ef0f544875a82d8c45">More...</a><br /></td></tr>
<tr class="separator:a39adf48fc3f4b7ef0f544875a82d8c45"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:addfbfd13132d03a95234401d57f92588"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#addfbfd13132d03a95234401d57f92588">degree_2</a> = 2</td></tr>
<tr class="separator:addfbfd13132d03a95234401d57f92588"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a205badfdb7b08797cfb9f35f7161bafd"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a205badfdb7b08797cfb9f35f7161bafd">degree_3</a> = 3</td></tr>
<tr class="separator:a205badfdb7b08797cfb9f35f7161bafd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c1281f32ff39edbbfb94238159dc6c8"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a7c1281f32ff39edbbfb94238159dc6c8">degree_4</a> = 4</td></tr>
<tr class="separator:a7c1281f32ff39edbbfb94238159dc6c8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af80ba52a718b4b7436beec1e3a92f454"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#af80ba52a718b4b7436beec1e3a92f454">nb_regridding_iterations</a> = 1</td></tr>
<tr class="memdesc:af80ba52a718b4b7436beec1e3a92f454"><td class="mdescLeft">&#160;</td><td class="mdescRight">Maximum number of regridding iterations.  <a href="#af80ba52a718b4b7436beec1e3a92f454">More...</a><br /></td></tr>
<tr class="separator:af80ba52a718b4b7436beec1e3a92f454"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a858621246c78b04149096007e6e40d5b"><td class="memItemLeft" align="right" valign="top">real, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a858621246c78b04149096007e6e40d5b">deviation_tolerance</a> = 1e-10</td></tr>
<tr class="memdesc:a858621246c78b04149096007e6e40d5b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Deviation tolerance between succesive grids in regridding iterations.  <a href="#a858621246c78b04149096007e6e40d5b">More...</a><br /></td></tr>
<tr class="separator:a858621246c78b04149096007e6e40d5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acb96fc79b15d793e517e0300168097ce"><td class="memItemLeft" align="right" valign="top">integer, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#acb96fc79b15d793e517e0300168097ce">nr_iterations</a> = 8</td></tr>
<tr class="memdesc:acb96fc79b15d793e517e0300168097ce"><td class="mdescLeft">&#160;</td><td class="mdescRight">Maximum number of Newton-Raphson iterations. Newton-Raphson iterations are used to build the new grid by finding the coordinates associated with target densities and interpolations of degree larger than 1.  <a href="#acb96fc79b15d793e517e0300168097ce">More...</a><br /></td></tr>
<tr class="separator:acb96fc79b15d793e517e0300168097ce"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a87fc44e8cb46bda54d63605e01f1465a"><td class="memItemLeft" align="right" valign="top">real, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a87fc44e8cb46bda54d63605e01f1465a">nr_tolerance</a> = 1e-12</td></tr>
<tr class="memdesc:a87fc44e8cb46bda54d63605e01f1465a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Tolerance for Newton-Raphson iterations (stop when increment falls below this)  <a href="#a87fc44e8cb46bda54d63605e01f1465a">More...</a><br /></td></tr>
<tr class="separator:a87fc44e8cb46bda54d63605e01f1465a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a78720368751f79b0c7124203784c8d62"><td class="memItemLeft" align="right" valign="top">real, parameter&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d1b/namespacemom__regridding.html#a78720368751f79b0c7124203784c8d62">nr_offset</a> = 1e-6</td></tr>
<tr class="memdesc:a78720368751f79b0c7124203784c8d62"><td class="mdescLeft">&#160;</td><td class="mdescRight">When the N-R algorithm produces an estimate that lies outside [0,1], the estimate is set to be equal to the boundary location, 0 or 1, plus or minus an offset, respectively, when the derivative is zero at the boundary.  <a href="#a78720368751f79b0c7124203784c8d62">More...</a><br /></td></tr>
<tr class="separator:a78720368751f79b0c7124203784c8d62"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Generates vertical grids as part of the ALE algorithm. </p>
<p>A vertical grid is defined solely by the cell thicknesses, \(h\). Most calculations in this module start with the coordinate at the bottom of the column set to -depth, and use a increasing value of coordinate with decreasing k. This is consistent with the rest of MOM6 that uses position, f$z. </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="ab18f7ea3cfa3c3892cb69086e3a4baef"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::adjust_interface_motion </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>min_thickness</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk), intent(in)&#160;</td>
          <td class="paramname"><em>h_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dz_int</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Adjust dz_Interface to ensure non-negative future thicknesses. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nk</td><td>Number of layers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">min_thickness</td><td>Minium allowed thickness of h (H units)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_old</td><td>Minium allowed thickness of h (H units)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dz_int</td><td>Minium allowed thickness of h (H units) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01726">1726</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">build_grid_hycom1()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01151">build_grid_slight()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00574">build_zstar_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nk<span class="comment"> !&lt; Number of layers</span></div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span>    :: min_thickness<span class="comment"> !&lt; Minium allowed thickness of h (H units)</span></div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk)</span>,   <span class="keywordtype">intent(in)</span>    :: h_old<span class="comment"> !&lt; Minium allowed thickness of h (H units)</span></div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span>, <span class="keywordtype">intent(inout)</span> :: dz_int<span class="comment"> !&lt; Minium allowed thickness of h (H units)</span></div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;  <span class="keywordtype">real</span> :: h_new, eps, h_total, h_err</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;  eps = 1. ; eps = epsilon(eps)</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  h_total = 0. ; h_err = 0.</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;  <span class="keywordflow">do</span> k = 1, nk</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;    h_total = h_total + h_old(k)</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;    h_err = h_err + max( h_old(k), abs(dz_int(k)), abs(dz_int(k+1)) )*eps</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    h_new = h_old(k) + ( dz_int(k) - dz_int(k+1) )</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    <span class="keywordflow">if</span> (h_new &lt; -3.0*h_err) <span class="keywordflow">then</span></div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;h&lt;0 at k=&#39;</span>,k,<span class="stringliteral">&#39;h_old=&#39;</span>,h_old(k), &amp;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        <span class="stringliteral">&#39;wup=&#39;</span>,dz_int(k),<span class="stringliteral">&#39;wdn=&#39;</span>,dz_int(k+1),<span class="stringliteral">&#39;dw_dz=&#39;</span>,dz_int(k) - dz_int(k+1), &amp;</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        <span class="stringliteral">&#39;h_new=&#39;</span>,h_new,<span class="stringliteral">&#39;h_err=&#39;</span>,h_err</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;      <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding: adjust_interface_motion() - &#39;</span>//&amp;</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;                     <span class="stringliteral">&#39;implied h&lt;0 is larger than roundoff!&#39;</span>)</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;  <span class="keywordflow">do</span> k = nk,2,-1</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;    h_new = h_old(k) + ( dz_int(k) - dz_int(k+1) )</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;    <span class="keywordflow">if</span> (h_new&lt;min_thickness) dz_int(k) = ( dz_int(k+1) - h_old(k) ) + min_thickness <span class="comment">! Implies next h_new = min_thickness</span></div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;    h_new = h_old(k) + ( dz_int(k) - dz_int(k+1) )</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="keywordflow">if</span> (h_new&lt;0.) dz_int(k) = ( 1. - eps ) * ( dz_int(k+1) - h_old(k) ) <span class="comment">! Backup in case min_thickness==0</span></div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    h_new = h_old(k) + ( dz_int(k) - dz_int(k+1) )</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;    <span class="keywordflow">if</span> (h_new&lt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;h&lt;0 at k=&#39;</span>,k,<span class="stringliteral">&#39;h_old=&#39;</span>,h_old(k), &amp;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;        <span class="stringliteral">&#39;wup=&#39;</span>,dz_int(k),<span class="stringliteral">&#39;wdn=&#39;</span>,dz_int(k+1),<span class="stringliteral">&#39;dw_dz=&#39;</span>,dz_int(k) - dz_int(k+1), &amp;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        <span class="stringliteral">&#39;h_new=&#39;</span>,h_new</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;      stop <span class="stringliteral">&#39;Still did not work!&#39;</span></div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;      <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding: adjust_interface_motion() - &#39;</span>//&amp;</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;                     <span class="stringliteral">&#39;Repeated adjustment for roundoff h&lt;0 failed!&#39;</span>)</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160; <span class="comment">!if (dz_int(1)/=0.) stop &#39;MOM_regridding: adjust_interface_motion() surface moved&#39;</span></div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ab18f7ea3cfa3c3892cb69086e3a4baef_icgraph.svg" width="552" height="183"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1e43d303ef28350aec4021c82d4a871c"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::allocate_regridding </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02738">2738</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>.</p>
<div class="fragment"><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;<span class="comment">! In this routine, we allocate the memory needed to carry out regridding</span></div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;<span class="comment">! steps in the course of the simulation.</span></div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;<span class="comment">! For example, to compute implicit edge-value estimates, a tridiagonal system</span></div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;<span class="comment">! must be solved. We allocate the needed memory at the beginning of the</span></div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;<span class="comment">! simulation because the number of layers never changes.</span></div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(inout)</span> :: cs</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;</div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;  <span class="comment">! Target values</span></div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;  <span class="keyword">allocate</span>( cs%target_density(cs%nk+1) )</div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;</div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;  <span class="comment">! Target resolution (for fixed coordinates)</span></div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;  <span class="keyword">allocate</span>( cs%coordinateResolution(cs%nk) ); cs%coordinateResolution(:) = -1.e30</div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a1e43d303ef28350aec4021c82d4a871c_icgraph.svg" width="344" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a53fe5957610e488f1fb9052ff69007ec"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_grid_arbitrary </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(inout)&#160;</td>
          <td class="paramname"><em>h_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Original ayer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>The change in interface depth in H</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_new</td><td>New layer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01772">1772</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment">! This routine builds a grid based on arbitrary rules</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                        <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Ocean grid structure</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                      <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Original ayer thicknesses, in H</span></div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; The change in interface depth in H</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;  <span class="keywordtype">real</span>,                                         <span class="keywordtype">intent(inout)</span> :: h_new<span class="comment"> !&lt; New layer thicknesses, in H</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                          <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;  <span class="keywordtype">integer</span>   :: i, j, k</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;  <span class="keywordtype">integer</span>   :: nz</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;  <span class="keywordtype">real</span>      :: z_inter(szk_(gv)+1)</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;  <span class="keywordtype">real</span>      :: total_height</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;  <span class="keywordtype">real</span>      :: delta_h</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;  <span class="keywordtype">real</span>      :: max_depth</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;  <span class="keywordtype">real</span>      :: min_thickness</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;  <span class="keywordtype">real</span>      :: eta              <span class="comment">! local elevation</span></div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;  <span class="keywordtype">real</span>      :: local_depth</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;  <span class="keywordtype">real</span>      :: x1, y1, x2, y2</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;  <span class="keywordtype">real</span>      :: x, t</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;  nz = gv%ke</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;  max_depth = g%max_depth</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;  min_thickness = cs%min_thickness</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;    <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;      <span class="comment">! Local depth</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;      local_depth = g%bathyT(i,j)*gv%m_to_H</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;      <span class="comment">! Determine water column height</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;      total_height = 0.0</div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;      <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;        total_height = total_height + h(i,j,k)</div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;</div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;      eta = total_height - local_depth</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;</div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;      <span class="comment">! Compute new thicknesses based on stretched water column</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;      delta_h = (max_depth + eta) / nz</div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;      <span class="comment">! Define interfaces</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;      z_inter(1) = eta</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;      <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;        z_inter(k+1) = z_inter(k) - delta_h</div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;      <span class="comment">! Refine grid in the middle</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;      <span class="keywordflow">do</span> k = 1,nz+1</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;        x1 = 0.35; y1 = 0.45; x2 = 0.65; y2 = 0.55</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;        x = - ( z_inter(k) - eta ) / max_depth</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;        <span class="keywordflow">if</span> ( x &lt;= x1 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;          t = y1*x/x1</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (x &gt; x1 ) .and. ( x &lt; x2 )) <span class="keywordflow">then</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;          t = y1 + (y2-y1) * (x-x1) / (x2-x1)</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;          t = y2 + (1.0-y2) * (x-x2) / (1.0-x2)</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;</div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;        z_inter(k) = -t * max_depth + eta</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;      <span class="comment">! Modify interface heights to account for topography</span></div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;      z_inter(nz+1) = - local_depth</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;      <span class="comment">! Modify interface heights to avoid layers of zero thicknesses</span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;      <span class="keywordflow">do</span> k = nz,1,-1</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;        <span class="keywordflow">if</span> ( z_inter(k) &lt; (z_inter(k+1) + min_thickness) ) <span class="keywordflow">then</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;          z_inter(k) = z_inter(k+1) + min_thickness</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;      <span class="comment">! Chnage in interface position</span></div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;      x = 0. <span class="comment">! Left boundary at x=0</span></div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;      dzinterface(i,j,1) = 0.</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;      <span class="keywordflow">do</span> k = 2,nz</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        x = x + h(i,j,k)</div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;        dzinterface(i,j,k) = z_inter(k) - x</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;      dzinterface(i,j,nz+1) = 0.</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;<span class="keywordflow">    end do</span></div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;stop <span class="stringliteral">&#39;OOOOOOPS&#39;</span> <span class="comment">! For some reason the gnu compiler will not let me delete this</span></div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;                <span class="comment">! routine????</span></div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a53fe5957610e488f1fb9052ff69007ec_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a3375da62433b875eed537feeba1ae1b3"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_grid_hycom1 </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(remapping_cs), intent(in)&#160;</td>
          <td class="paramname"><em>remapCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Builds a simple HyCOM-like grid with the deepest location of potential density interpolated from the column profile and a clipping of depth for each interface to a fixed z* or p* grid. This should probably be (optionally?) changed to find the nearest location of the target density. </p>
<dl class="section remark"><dt>Remarks</dt><dd>{ Based on Bleck, 2002: An oceanice general circulation model framed in hybrid isopycnic-Cartesian coordinates, Ocean Modelling 37, 55-88. <a href="http://dx.doi.org/10.1016/S1463-5003(01)00012-9">http://dx.doi.org/10.1016/S1463-5003(01)00012-9</a> }</dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Existing model thickness, in H units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamics structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>Changes in interface position</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">remapcs</td><td>Remapping control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">1045</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01726">adjust_interface_motion()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">filtered_grid_motion()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02054">interpolate_grid()</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                       <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Grid structure</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                     <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Existing model thickness, in H units</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                       <span class="keywordtype">intent(in)</span>    :: tv<span class="comment"> !&lt; Thermodynamics structure</span></div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; Changes in interface position</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">remapping_cs</a>),                          <span class="keywordtype">intent(in)</span>    :: remapcs<span class="comment"> !&lt; Remapping control structure</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                         <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;  <span class="keywordtype">integer</span>   :: i, j, k, nz</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: t_col, s_col, p_col, rho_col, h_col_new <span class="comment">! Layer quantities</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: z_col, z_col_new <span class="comment">! Interface positions relative to the surface in H units (m or kg m-2)</span></div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: dz_col  <span class="comment">! The realized change in z_col in H units (m or kg m-2)</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,2)</span> :: ppoly_i_e <span class="comment">! Edge value of polynomial</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,2)</span> :: ppoly_i_s <span class="comment">! Edge slope of polynomial</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,CS%degree_i+1)</span> :: ppoly_i_coefficients <span class="comment">! Coefficients of polynomial</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;  <span class="keywordtype">real</span> :: nominal_z <span class="comment">! Nominal depth of interface is using z* (m or Pa)</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  <span class="keywordtype">real</span> :: stretching <span class="comment">! z* stretching, converts z* to z.</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordtype">real</span> :: hnew</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  <span class="keywordtype">logical</span> :: maximum_depths_set <span class="comment">! If true, the maximum depths of interface have been set.</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordtype">logical</span> :: maximum_h_set      <span class="comment">! If true, the maximum layer thicknesses have been set.</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  <span class="keywordtype">integer</span> :: ppoly_degree</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  nz = gv%ke</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;  maximum_depths_set = <span class="keyword">allocated</span>(cs%max_interface_depths)</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;  maximum_h_set = <span class="keyword">allocated</span>(cs%max_layer_thickness)</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  <span class="keywordflow">if</span> (.not.cs%target_density_set) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;build_grid_HyCOM1 : &quot;</span>//&amp;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        <span class="stringliteral">&quot;Target densities must be set before build_grid_HyCOM1 is called.&quot;</span>)</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="comment">! Build grid based on target interface densities</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1 ; <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;      <span class="comment">! Copy T and S onto new variables so as to not alter the original values</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;      <span class="comment">! of T and S (these are remapped at the end of the regridding iterations</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;      <span class="comment">! once the final grid has been determined).</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;      t_col(:) = tv%T(i,j,:)</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;      s_col(:) = tv%S(i,j,:)</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      z_col(1) = 0. <span class="comment">! Work downward rather than bottom up</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      <span class="keywordflow">do</span> k = 1, nz</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        z_col(k+1) = z_col(k) + h(i,j,k) <span class="comment">! Work in units of h (m or Pa)</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        p_col(k) = cs%ref_pressure + cs%compressibility_fraction * &amp;</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;             ( 0.5 * ( z_col(k) + z_col(k+1) ) * gv%H_to_Pa - cs%ref_pressure )</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;      <span class="comment">! Work bottom recording potential density</span></div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;      <span class="keyword">call </span>calculate_density(t_col, s_col, p_col, &amp;</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                             rho_col, 1, nz, tv%eqn_of_state )</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;      <span class="comment">! This ensures the potential density profile is monotonic</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;      <span class="comment">! although not necessarily single valued.</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;      <span class="keywordflow">do</span> k = nz-1, 1, -1</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        rho_col(k) = min( rho_col(k), rho_col(k+1) )</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;      <span class="comment">! Interpolates for the target interface position with the rho_col profile</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;      <span class="keyword">call </span>regridding_set_ppolys(rho_col, cs, nz, h(i,j,:), ppoly_i_e, ppoly_i_s, &amp;</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                                 ppoly_i_coefficients, ppoly_degree)</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      <span class="comment">! Based on global density profile, interpolate to generate a new grid</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      <span class="keyword">call </span>interpolate_grid(nz, h(i,j,:), z_col, ppoly_i_e, ppoly_i_coefficients, &amp;</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                            cs%target_density, ppoly_degree, nz, h_col_new, z_col_new)</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      <span class="comment">! Sweep down the interfaces and make sure that the interface is at least</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;      <span class="comment">! as deep as a nominal target z* grid</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;      nominal_z = 0.</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;      stretching = z_col(nz+1) / g%bathyT(i,j) * gv%m_to_H <span class="comment">! Stretches z* to z</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;      <span class="keywordflow">do</span> k = 2, nz+1</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;        nominal_z = nominal_z + cs%coordinateResolution(k-1) * stretching</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        z_col_new(k) = max( z_col_new(k), nominal_z )</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        z_col_new(k) = min( z_col_new(k), z_col(nz+1) )</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;      <span class="keywordflow">if</span> (maximum_depths_set .and. maximum_h_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;        <span class="comment">! The loop bounds are 2 &amp; nz so the top and bottom interfaces do not move.</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        <span class="comment">! Recall that z_col_new is positive downward.</span></div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        z_col_new(k) = min(z_col_new(k), cs%max_interface_depths(k), &amp;</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                           z_col_new(k-1) + cs%max_layer_thickness(k-1))</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;<span class="keywordflow">      enddo</span> ; <span class="keywordflow">elseif</span> (maximum_depths_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        z_col_new(k) = min(z_col_new(k), cs%max_interface_depths(k))</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;<span class="keywordflow">      enddo</span> ; <span class="keywordflow">elseif</span> (maximum_h_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        z_col_new(k) = min(z_col_new(k), z_col_new(k-1) + cs%max_layer_thickness(k-1))</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;      <span class="comment">! Calculate the final change in grid position after blending new and old grids</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;      <span class="keyword">call </span>filtered_grid_motion( cs, nz, z_col, z_col_new, dz_col )</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; dzinterface(i,j,k) = -dz_col(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;      <span class="comment">! This adjusts things robust to round-off errors</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;      <span class="keyword">call </span>adjust_interface_motion( nz, cs%min_thickness, h(i,j,:), dzinterface(i,j,:) )</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! on land</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;      dzinterface(i,j,:) = 0.</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! mask2dT</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="keyword">  end</span>do; enddo <span class="comment">! i,j</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div><div class="ttc" id="structmom__remapping_1_1remapping__cs_html"><div class="ttname"><a href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">mom_remapping::remapping_cs</a></div><div class="ttdoc">Container for remapping parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d8b/MOM__remapping_8F90_source.html#l00022">MOM_remapping.F90:22</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a3375da62433b875eed537feeba1ae1b3_cgraph.svg" width="100%" height="514"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a3375da62433b875eed537feeba1ae1b3_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="adbdde4ab6606ab76f64f57b7ee5dfdeb"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_grid_slight </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(remapping_cs), intent(in)&#160;</td>
          <td class="paramname"><em>remapCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Builds a grid that tracks density interfaces for water that is denser than the surface density plus an increment of some number of layers, and uses all lighter layers uniformly above this location. Note that this amounts to interpolating to find the depth of an arbitrary (non-integer) interface index which should make the results vary smoothly in space to the extent that the surface density and interior stratification vary smoothly in space. Over shallow topography, this will tend to give a uniform sigma-like coordinate. For sufficiently shallow water, a minimum grid spacing is used to avoid certain instabilities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Existing model thickness, in H units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamics structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>Changes in interface position</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">remapcs</td><td>Remapping control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01151">1151</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01726">adjust_interface_motion()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">filtered_grid_motion()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01484">rho_interfaces_col()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                       <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Grid structure</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                     <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Existing model thickness, in H units</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                       <span class="keywordtype">intent(in)</span>    :: tv<span class="comment"> !&lt; Thermodynamics structure</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; Changes in interface position</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">remapping_cs</a>),                          <span class="keywordtype">intent(in)</span>    :: remapcs<span class="comment"> !&lt; Remapping control structure</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                         <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: t_col, s_col, p_col, rho_col <span class="comment">! Layer quantities</span></div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: h_col     <span class="comment">! A column of layer thicknesses on the original grid in H units.</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: t_f, s_f  <span class="comment">! Filtered ayer quantities</span></div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: z_col, z_col_new <span class="comment">! Interface positions relative to the surface in H units (m or kg m-2)</span></div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: dz_col  <span class="comment">! The realized change in z_col in H units (m or kg m-2)</span></div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: reliable  <span class="comment">! If true, this interface is in a reliable position.</span></div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: t_int, s_int <span class="comment">! Temperature and salinity interpolated to interfaces.</span></div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: rho_tmp, drho_dp, p_is, p_r</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: drhois_dt, drhois_ds</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: drhor_dt, drhor_ds</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: strat_rat</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="keywordtype">real</span> :: h_to_cpa</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="keywordtype">real</span> :: dris, drr, fn_now, i_hstol, fn_zero_val</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  <span class="keywordtype">real</span> :: z_int_unst</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  <span class="keywordtype">real</span> :: dz      <span class="comment">! A uniform layer thickness in very shallow water, in H.</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;  <span class="keywordtype">real</span> :: dz_ur   <span class="comment">! The total thickness of an unstable region, in H.</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  <span class="keywordtype">real</span> :: wgt, cowgt  <span class="comment">! A weight and its complement, nondim.</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  <span class="keywordtype">real</span> :: rho_ml_av <span class="comment">! The average potential density in a near-surface region, in kg m-3.</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;  <span class="keywordtype">real</span> :: h_ml_av <span class="comment">! A thickness to try to use in taking the near-surface average, in H.</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="keywordtype">real</span> :: rho_x_z <span class="comment">! A cumulative integral of a density, in kg m-3 H.</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="keywordtype">real</span> :: z_wt    <span class="comment">! The thickness actually used in taking the near-surface average, in H.</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  <span class="keywordtype">real</span> :: k_interior  <span class="comment">! The (real) value of k where the interior grid starts.</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="keywordtype">real</span> :: k_int2      <span class="comment">! The (real) value of k where the interior grid starts.</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <span class="keywordtype">real</span> :: z_interior  <span class="comment">! The depth where the interior grid starts, in H.</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  <span class="keywordtype">real</span> :: z_ml_fix    <span class="comment">! The depth at which the fixed-thickness near-surface layers end, in H.</span></div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="keywordtype">real</span> :: dz_dk       <span class="comment">! The thickness of layers between the fixed-thickness</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                      <span class="comment">! near-surface layars and the interior, in H.</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  <span class="keywordtype">real</span> :: lfilt       <span class="comment">! A filtering lengthscale, in H.</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keywordtype">logical</span> :: maximum_depths_set <span class="comment">! If true, the maximum depths of interface have been set.</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;  <span class="keywordtype">logical</span> :: maximum_h_set      <span class="comment">! If true, the maximum layer thicknesses have been set.</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  <span class="keywordtype">real</span> :: k2_used, k2here, dz_sum, z_max</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordtype">integer</span> :: k2</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  <span class="keywordtype">real</span> :: h_tr, b_denom_1, b1, d1 <span class="comment">! Temporary variables used by the tridiagonal solver.</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: c1  <span class="comment">! Temporary variables used by the tridiagonal solver.</span></div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="keywordtype">integer</span> :: kur1, kur2  <span class="comment">! The indicies at the top and bottom of an unreliable region.</span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  <span class="keywordtype">integer</span> :: kur_ss      <span class="comment">! The index to start with in the search for the next unstable region.</span></div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, nz, nkml</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  nz = gv%ke</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  maximum_depths_set = <span class="keyword">allocated</span>(cs%max_interface_depths)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  maximum_h_set = <span class="keyword">allocated</span>(cs%max_layer_thickness)</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <span class="keywordflow">if</span> (.not.cs%target_density_set) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;build_grid_SLight : &quot;</span>//&amp;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="stringliteral">&quot;Target densities must be set before build_grid_SLight is called.&quot;</span>)</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;  <span class="comment">! Build grid based on target interface densities</span></div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1 ; <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;      <span class="comment">! Copy T and S onto new variables so as to not alter the original values</span></div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;      <span class="comment">! of T and S (these are remapped at the end of the regridding iterations</span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;      <span class="comment">! once the final grid has been determined).</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        t_col(k) = tv%T(i,j,k) ; s_col(k) = tv%S(i,j,k)</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        h_col(k) = h(i,j,k)</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;      z_col(1) = 0. <span class="comment">! Work downward rather than bottom up</span></div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;        z_col(k+1) = z_col(k) + h_col(k) <span class="comment">! Work in units of h (m or Pa)</span></div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;        p_col(k) = cs%ref_pressure + cs%compressibility_fraction * &amp;</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;             ( 0.5 * ( z_col(k) + z_col(k+1) ) * gv%H_to_Pa - cs%ref_pressure )</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;      <span class="keywordflow">if</span> (z_col(nz+1) - z_col(1) &lt; nz*cs%min_thickness) <span class="keywordflow">then</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        <span class="comment">! This is a nearly massless total depth, so distribute the water evenly.</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        dz = (z_col(nz+1) - z_col(1)) / <span class="keywordtype">real</span>(nz)</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        <span class="keywordflow">do</span> k=2,nz ; z_col_new(k) = z_col(1) + dz*<span class="keywordtype">real(K-1)</span> ; enddo</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <span class="keyword">call </span>calculate_density(t_col, s_col, p_col, rho_col, 1, nz, &amp;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                               tv%eqn_of_state)</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        <span class="comment">! Find the locations of the target potential densities, flagging</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;        <span class="comment">! locations in apparently unstable regions as not reliable.</span></div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        <span class="keyword">call </span>rho_interfaces_col(rho_col, h_col, z_col, cs%target_density, nz, &amp;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                                z_col_new, cs, reliable, debug=.true.)</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;        <span class="comment">! Ensure that the interfaces are at least CS%min_thickness apart.</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;        <span class="keywordflow">if</span> (cs%min_thickness &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;          <span class="comment">! Move down interfaces below overly thin layers.</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;          <span class="keywordflow">do</span> k=2,nz ; <span class="keywordflow">if</span> (z_col_new(k) &lt; z_col_new(k-1) + cs%min_thickness) <span class="keywordflow">then</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;            z_col_new(k) = z_col_new(k-1) + cs%min_thickness</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;          <span class="comment">! Now move up any interfaces that are too close to the bottom.</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;          <span class="keywordflow">do</span> k=nz,2,-1 ; <span class="keywordflow">if</span> (z_col_new(k) &gt; z_col_new(k+1) - cs%min_thickness) <span class="keywordflow">then</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;            z_col_new(k) = z_col_new(k+1) - cs%min_thickness</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;            <span class="keywordflow">exit</span> <span class="comment">! No more interfaces can be too close to the bottom.</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        <span class="comment">! Fix up the unreliable regions.</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        kur_ss = 2 <span class="comment">! reliable(1) and reliable(nz+1) must always be true.</span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;        <span class="keywordflow">do</span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;          <span class="comment">! Search for the uppermost unreliable interface postion.</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;          kur1 = nz+2</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;          <span class="keywordflow">do</span> k=kur_ss,nz ; <span class="keywordflow">if</span> (.not.reliable(k)) <span class="keywordflow">then</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            kur1 = k ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;          <span class="keywordflow">if</span> (kur1 &gt; nz) <span class="keywordflow">exit</span> <span class="comment">! Everything is now reliable.</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;          kur2 = kur1-1 <span class="comment">! For error checking.</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;          <span class="keywordflow">do</span> k=kur1+1,nz+1 ; <span class="keywordflow">if</span> (reliable(k)) <span class="keywordflow">then</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            kur2 = k-1 ; kur_ss = k ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;          <span class="keywordflow">if</span> (kur2 &lt; kur1) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;Bad unreliable range.&quot;</span>)</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;          dz_ur = z_col_new(kur2+1) - z_col_new(kur1-1)</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;  <span class="comment">!        drho = CS%target_density(kur2+1) - CS%target_density(kur1-1)</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;          <span class="comment">! Perhaps reset the wgt and cowgt depending on how bad the old interface</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;          <span class="comment">! locations were.</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;          wgt = 1.0 ; cowgt = 0.0 <span class="comment">! = 1.0-wgt</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;          <span class="keywordflow">do</span> k=kur1,kur2</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;            z_col_new(k) = cowgt*z_col_new(k) + &amp;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;                  wgt * (z_col_new(kur1-1) + dz_ur*(k - (kur1-1)) / ((kur2 - kur1) + 2))</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;        <span class="comment">! Determine which interfaces are in the s-space region and the depth extent</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        <span class="comment">! of this region.</span></div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        z_wt = 0.0 ; rho_x_z = 0.0</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        h_ml_av = gv%m_to_H*cs%Rho_ml_avg_depth</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;          <span class="keywordflow">if</span> (z_wt + h_col(k) &gt;= h_ml_av) <span class="keywordflow">then</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;            rho_x_z = rho_x_z + rho_col(k) * (h_ml_av - z_wt)</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            z_wt = h_ml_av</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            <span class="keywordflow">exit</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            rho_x_z =  rho_x_z + rho_col(k) * h_col(k)</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            z_wt = z_wt + h_col(k)</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;        <span class="keywordflow">if</span> (z_wt &gt; 0.0) rho_ml_av = rho_x_z / z_wt</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;        nkml = cs%nz_fixed_surface</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        <span class="comment">! Find the interface that matches rho_ml_av.</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordflow">if</span> (rho_ml_av &lt;= cs%target_density(nkml)) <span class="keywordflow">then</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;          k_interior = cs%nlay_ml_offset + <span class="keywordtype">real</span>(nkml)</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        <span class="keywordflow">elseif</span> (rho_ml_av &gt; cs%target_density(nz+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;          k_interior = <span class="keywordtype">real</span>(nz+1)</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        <span class="keywordflow">else</span> ; <span class="keywordflow">do</span> k=nkml,nz</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;          <span class="keywordflow">if</span> ((rho_ml_av &gt;= cs%target_density(k)) .and. &amp;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;              (rho_ml_av &lt;  cs%target_density(k+1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            k_interior = (cs%nlay_ml_offset + k) + &amp;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                    (rho_ml_av - cs%target_density(k)) / &amp;</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                    (cs%target_density(k+1) - cs%target_density(k))</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;            <span class="keywordflow">exit</span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        <span class="keywordflow">if</span> (k_interior &gt; <span class="keywordtype">real</span>(nz+1)) k_interior = real(nz+1)</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;        <span class="comment">! Linearly interpolate to find z_interior.  This could be made more sophisticated.</span></div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        k = int(ceiling(k_interior))</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;        z_interior = (k-k_interior)*z_col_new(k-1) + (1.0+(k_interior-k))*z_col_new(k)</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        <span class="keywordflow">if</span> (cs%fix_haloclines) <span class="keywordflow">then</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment">!       ! Identify regions above the reference pressure where the chosen</span></div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="comment">!       ! potential density significantly underestimates the actual</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment">!       ! stratification, and use these to find a second estimate of</span></div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="comment">!       ! z_int_unst and k_interior.</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;          <span class="keywordflow">if</span> (cs%halocline_filter_length &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;            lfilt = cs%halocline_filter_length*gv%m_to_H</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;            <span class="comment">! Filter the temperature and salnity with a fixed lengthscale.</span></div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;            h_tr = h_col(1) + gv%H_subroundoff</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;            b1 = 1.0 / (h_tr + lfilt) ; d1 = h_tr * b1</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;            t_f(1) = (b1*h_tr)*t_col(1) ;  s_f(1) = (b1*h_tr)*s_col(1)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;              c1(k) = lfilt * b1</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;              h_tr = h_col(k) + gv%H_subroundoff ; b_denom_1 = h_tr + d1*lfilt</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;              b1 = 1.0 / (b_denom_1 + lfilt) ; d1 = b_denom_1 * b1</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;              t_f(k) = b1 * (h_tr*t_col(k) + lfilt*t_f(k-1))</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;              s_f(k) = b1 * (h_tr*s_col(k) + lfilt*s_f(k-1))</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;            <span class="keywordflow">do</span> k=nz-1,1,-1</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;              t_f(k) = t_f(k) + c1(k+1)*t_f(k+1) ; s_f(k) = s_f(k) + c1(k+1)*s_f(k+1)</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;            <span class="keywordflow">do</span> k=1,nz ; t_f(k) = t_col(k) ; s_f(k) = s_col(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;          t_int(1) = t_f(1) ; s_int(1) = s_f(1)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;          <span class="keywordflow">do</span> k=2,nz </div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;            t_int(k) = 0.5*(t_f(k-1) + t_f(k)) ; s_int(k) = 0.5*(s_f(k-1) + s_f(k))</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;            p_is(k) = z_col(k) * gv%H_to_Pa</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;            p_r(k) = cs%ref_pressure + cs%compressibility_fraction * ( p_is(k) - cs%ref_pressure )</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;          t_int(nz+1) = t_f(nz) ; s_int(nz+1) = s_f(nz)</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;          p_is(nz+1) = z_col(nz+1) * gv%H_to_Pa</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;          <span class="keyword">call </span>calculate_density_derivs(t_int, s_int, p_is, drhois_dt, drhois_ds, 2, nz-1, &amp;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;                                        tv%eqn_of_state)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;          <span class="keyword">call </span>calculate_density_derivs(t_int, s_int, p_r, drhor_dt, drhor_ds, 2, nz-1, &amp;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;                                        tv%eqn_of_state)</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;          <span class="keywordflow">if</span> (cs%compressibility_fraction &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;            <span class="keyword">call </span>calculate_compress(t_int, s_int, p_r, rho_tmp, drho_dp, 2, nz-1, &amp;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;                                          tv%eqn_of_state)</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;            <span class="keywordflow">do</span> k=2,nz ; drho_dp(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;          </div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;          h_to_cpa = cs%compressibility_fraction*gv%H_to_Pa</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;          strat_rat(1) = 1.0</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;          <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;            dris = drhois_dt(k) * (t_f(k) - t_f(k-1)) + &amp;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                   drhois_ds(k) * (s_f(k) - s_f(k-1))</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;            drr = (drhor_dt(k) * (t_f(k) - t_f(k-1)) + &amp;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                   drhor_ds(k) * (s_f(k) - s_f(k-1))) + &amp;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                  drho_dp(k) * (h_to_cpa*0.5*(h_col(k) + h_col(k-1)))</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;            <span class="keywordflow">if</span> (dris &lt;= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;              strat_rat(k) = 2.0 <span class="comment">! Maybe do this? =&gt; ; if (drR &lt; 0.0) strat_rat(K) = -2.0</span></div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;              strat_rat(k) = 2.0*max(drr,0.0) / (dris + abs(drr))</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;          strat_rat(nz+1) = 1.0</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;          z_int_unst = 0.0 ; fn_now = 0.0</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;          fn_zero_val = min(2.0*cs%halocline_strat_tol, &amp;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;                            0.5*(1.0 + cs%halocline_strat_tol))</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;          <span class="keywordflow">if</span> (cs%halocline_strat_tol &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;            <span class="comment">! Use Adcroft&#39;s reciprocal rule.</span></div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            i_hstol = 0.0 ; <span class="keywordflow">if</span> (fn_zero_val - cs%halocline_strat_tol &gt; 0.0) &amp;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;              i_hstol = 1.0 / (fn_zero_val - cs%halocline_strat_tol)</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">if</span> (cs%ref_pressure &gt; p_is(k+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;              z_int_unst = z_int_unst + fn_now * h_col(k)</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;              <span class="keywordflow">if</span> (strat_rat(k) &lt;= fn_zero_val) <span class="keywordflow">then</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                <span class="keywordflow">if</span> (strat_rat(k) &lt;= cs%halocline_strat_tol) <span class="keywordflow">then</span> ; fn_now = 1.0</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                <span class="keywordflow">else</span></div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;                  fn_now = max(fn_now, (fn_zero_val - strat_rat(k)) * i_hstol)</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;<span class="keywordflow">                endif</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;            <span class="keywordflow">do</span> k=nz,1,-1 ; <span class="keywordflow">if</span> (cs%ref_pressure &gt; p_is(k+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;              z_int_unst = z_int_unst + fn_now * h_col(k)</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;              <span class="keywordflow">if</span> (strat_rat(k) &lt;= cs%halocline_strat_tol) fn_now = 1.0</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;<span class="keywordflow">            endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;          <span class="keywordflow">if</span> (z_interior &lt; z_int_unst) <span class="keywordflow">then</span></div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;            <span class="comment">! Find a second estimate of the extent of the s-coordinate region.</span></div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;            kur1 = max(int(ceiling(k_interior)),2)</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;            <span class="keywordflow">if</span> (z_col_new(kur1-1) &lt; z_interior) <span class="keywordflow">then</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;              k_int2 = kur1</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;              <span class="keywordflow">do</span> k = kur1,nz+1 ; <span class="keywordflow">if</span> (z_col_new(k) &gt;= z_int_unst) <span class="keywordflow">then</span></div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                <span class="comment">! This is linear interpolation again.</span></div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                <span class="keywordflow">if</span> (z_col_new(k-1) &gt;= z_int_unst) &amp;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                  <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&quot;build_grid_SLight, bad halocline structure.&quot;</span>)</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                k_int2 = <span class="keywordtype">real(K-1)</span> + (z_int_unst - z_col_new(k-1)) / &amp;</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                                         (z_col_new(k) - z_col_new(k-1))</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                <span class="keywordflow">exit</span></div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;<span class="keywordflow">              endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;              <span class="keywordflow">if</span> (z_col_new(nz+1) &lt; z_int_unst) <span class="keywordflow">then</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                <span class="comment">! This should be unnecessary.</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                z_int_unst = z_col_new(nz+1) ; k_int2 = <span class="keywordtype">real</span>(nz+1)</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;              </div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;              <span class="comment">! Now take the larger values.</span></div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;              <span class="keywordflow">if</span> (k_int2 &gt; k_interior) <span class="keywordflow">then</span></div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;                k_interior = k_int2 ; z_interior = z_int_unst</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;<span class="keywordflow">        endif</span>  <span class="comment">! fix_haloclines</span></div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        z_col_new(1) = 0.0</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="keywordflow">do</span> k=2,nkml+1</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;          z_col_new(k) = min((k-1)*cs%dz_ml_min, &amp;</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;                             z_col_new(nz+1) - cs%min_thickness*(nz+1-k))</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        z_ml_fix = z_col_new(nkml+1)</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        <span class="keywordflow">if</span> (z_interior &gt; z_ml_fix) <span class="keywordflow">then</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;          dz_dk = (z_interior - z_ml_fix) / (k_interior - (nkml+1))</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;          <span class="keywordflow">do</span> k=nkml+2,int(floor(k_interior))</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;            z_col_new(k) = z_ml_fix + dz_dk * (k - (nkml+1))</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        <span class="keywordflow">else</span> <span class="comment">! The fixed-thickness z-region penetrates into the interior.</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;          <span class="keywordflow">do</span> k=nkml+2,nz</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;            <span class="keywordflow">if</span> (z_col_new(k) &lt;= z_col_new(cs%nz_fixed_surface+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;              z_col_new(k) = z_col_new(cs%nz_fixed_surface+1)</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;            <span class="keywordflow">else</span> ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        <span class="keywordflow">if</span> (maximum_depths_set .and. maximum_h_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;          <span class="comment">! The loop bounds are 2 &amp; nz so the top and bottom interfaces do not move.</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;          <span class="comment">! Recall that z_col_new is positive downward.</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;          z_col_new(k) = min(z_col_new(k), cs%max_interface_depths(k), &amp;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;                                z_col_new(k-1) + cs%max_layer_thickness(k-1))</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="keywordflow">        enddo</span> ; <span class="keywordflow">elseif</span> (maximum_depths_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;          z_col_new(k) = min(z_col_new(k), cs%max_interface_depths(k))</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;<span class="keywordflow">        enddo</span> ; <span class="keywordflow">elseif</span> (maximum_h_set) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;          z_col_new(k) = min(z_col_new(k), z_col_new(k-1) + cs%max_layer_thickness(k-1))</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;<span class="keywordflow">      endif</span> <span class="comment">! Total thickness exceeds nz*CS%min_thickness.</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;      <span class="comment">! Calculate the final change in grid position after blending new and old grids</span></div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;      <span class="keyword">call </span>filtered_grid_motion( cs, nz, z_col, z_col_new, dz_col )</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;      <span class="keywordflow">do</span> k=1,nz+1 ; dzinterface(i,j,k) = -dz_col(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">if</span> (dzinterface(i,j,1) /= 0.) stop <span class="stringliteral">&#39;build_grid_SLight: Surface moved?!&#39;</span></div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;      <span class="keywordflow">if</span> (dzinterface(i,j,nz+1) /= 0.) stop <span class="stringliteral">&#39;build_grid_SLight: Bottom moved?!&#39;</span></div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;      <span class="comment">! This adjusts things robust to round-off errors</span></div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;      <span class="keyword">call </span>adjust_interface_motion( nz, cs%min_thickness, h(i,j,:), dzinterface(i,j,:) )</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! on land</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;      dzinterface(i,j,:) = 0.</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="keywordflow">    endif</span> <span class="comment">! mask2dT</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="keyword">  end</span>do; enddo <span class="comment">! i,j</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div><div class="ttc" id="structmom__remapping_1_1remapping__cs_html"><div class="ttname"><a href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">mom_remapping::remapping_cs</a></div><div class="ttdoc">Container for remapping parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d8b/MOM__remapping_8F90_source.html#l00022">MOM_remapping.F90:22</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_adbdde4ab6606ab76f64f57b7ee5dfdeb_cgraph.svg" width="100%" height="437"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_adbdde4ab6606ab76f64f57b7ee5dfdeb_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a58a19305bbdab26bfa4f336dfac8c4f8"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_rho_grid </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(remapping_cs), intent(in)&#160;</td>
          <td class="paramname"><em>remapCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>Thermodynamics structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>The change in interface depth in H</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">remapcs</td><td>The remapping control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">806</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00202">deviation_tolerance</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">filtered_grid_motion()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02054">interpolate_grid()</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00200">nb_regridding_iterations</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02298">old_inflate_layers_1d()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;<span class="comment">! This routine builds a new grid based on a given set of target interface</span></div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;<span class="comment">! densities (these target densities are computed by taking the mean value</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">! of given layer densities). The algorithn operates as follows within each</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">! column:</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="comment">! 1. Given T &amp; S within each layer, the layer densities are computed.</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;<span class="comment">! 2. Based on these layer densities, a global density profile is reconstructed</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="comment">!    (this profile is monotonically increasing and may be discontinuous)</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;<span class="comment">! 3. The new grid interfaces are determined based on the target interface</span></div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="comment">!    densities.</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="comment">! 4. T &amp; S are remapped onto the new grid.</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment">! 5. Return to step 1 until convergence or until the maximum number of</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;<span class="comment">!    iterations is reached, whichever comes first.</span></div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                        <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Ocean grid structure</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                      <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Layer thicknesses, in H</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                        <span class="keywordtype">intent(in)</span>    :: tv<span class="comment"> !&lt; Thermodynamics structure </span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; The change in interface depth in H</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">remapping_cs</a>),                           <span class="keywordtype">intent(in)</span>    :: remapcs<span class="comment"> !&lt; The remapping control structure</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                          <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="keywordtype">integer</span>   :: i, j, k, m</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;  <span class="keywordtype">integer</span>   :: map_index</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;  <span class="keywordtype">integer</span>   :: nz</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;  <span class="keywordtype">integer</span>   :: k_found</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;  <span class="keywordtype">integer</span>   :: count_nonzero_layers</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;  <span class="keywordtype">real</span>      :: deviation            <span class="comment">! When iterating to determine the final</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;                                    <span class="comment">! grid, this is the deviation between two</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;                                    <span class="comment">! successive grids.</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;  <span class="keywordtype">real</span>      :: threshold</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;  <span class="keywordtype">real</span>      :: max_thickness</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;  <span class="keywordtype">real</span>      :: correction</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,2)</span> :: ppoly_i_e            <span class="comment">!Edge value of polynomial</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,2)</span> :: ppoly_i_s            <span class="comment">!Edge slope of polynomial</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk,CS%degree_i+1)</span> :: ppoly_i_coefficients <span class="comment">!Coefficients of polynomial</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;  <span class="keywordtype">integer</span>   :: ppoly_degree         <span class="comment">! The actual degree of the polynomials.</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: p_col, densities, t_col, s_col, tmp_col</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: mapping</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;  <span class="keywordtype">real</span>    :: nominaldepth, totalthickness, dh</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: zold, znew</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV))</span> :: h0, h1, htmp</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: x0, x1, xtmp</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  nz = gv%ke</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;  threshold = cs%min_thickness</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;  p_col(:) = cs%ref_pressure</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  <span class="keywordflow">if</span> (.not.cs%target_density_set) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;build_rho_grid: &quot;</span>//&amp;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="stringliteral">&quot;Target densities must be set before build_rho_grid is called.&quot;</span>)</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  <span class="comment">! Build grid based on target interface densities</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      <span class="comment">! Copy T and S onto new variables so as to not alter the original values</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      <span class="comment">! of T and S (these are remapped at the end of the regridding iterations</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      <span class="comment">! once the final grid has been determined).</span></div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;      t_col = tv%T(i,j,:)</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      s_col = tv%S(i,j,:)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;      <span class="comment">! Copy original grid</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;      h0(1:nz) = h(i,j,1:nz)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;      <span class="comment">! Start iterations to build grid</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;      m = 1</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;      deviation = 1e10</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;      <span class="keywordflow">do</span> <span class="keywordflow">while</span> ( ( m &lt;= nb_regridding_iterations ) .and. &amp;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;                 ( deviation &gt; deviation_tolerance ) )</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        <span class="comment">! Count number of nonzero layers within current water column</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        count_nonzero_layers = 0</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;          <span class="keywordflow">if</span> ( h0(k) &gt; threshold ) <span class="keywordflow">then</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;            count_nonzero_layers = count_nonzero_layers + 1</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="keywordflow">          end if</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="comment">! If there is at most one nonzero layer, stop here (no regridding)</span></div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <span class="keywordflow">if</span> ( count_nonzero_layers &lt;= 1 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;          h1(1:nz) = h0(1:nz)</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;          <span class="keywordflow">exit</span>  <span class="comment">! stop iterations here</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        <span class="comment">! Build new grid containing only nonzero layers</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        map_index = 1</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        correction = 0.0</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;          <span class="keywordflow">if</span> ( h0(k) &gt; threshold ) <span class="keywordflow">then</span></div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;            mapping(map_index) = k</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;            htmp(map_index) = h0(k)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            map_index = map_index + 1</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;            correction = correction + h0(k)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">          end if</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;        max_thickness = htmp(1)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        k_found = 1</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        <span class="keywordflow">do</span> k = 1,count_nonzero_layers</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;          <span class="keywordflow">if</span> ( htmp(k) &gt; max_thickness ) <span class="keywordflow">then</span></div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;            max_thickness = htmp(k)</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;            k_found = k</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="keywordflow">          end if</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        htmp(k_found) = htmp(k_found) + correction</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        xtmp(1) = 0.0</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        <span class="keywordflow">do</span> k = 1,count_nonzero_layers</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;          xtmp(k+1) = xtmp(k) + htmp(k)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="comment">! Compute densities within current water column</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        <span class="keyword">call </span>calculate_density( t_col, s_col, p_col, densities,&amp;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                                 1, nz, tv%eqn_of_state )</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        <span class="keywordflow">do</span> k = 1,count_nonzero_layers</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;          densities(k) = densities(mapping(k))</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        <span class="comment">! One regridding iteration</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="keyword">call </span>regridding_set_ppolys(densities, cs, count_nonzero_layers, htmp, &amp;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;                                   ppoly_i_e, ppoly_i_s, ppoly_i_coefficients, ppoly_degree)</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="comment">! Based on global density profile, interpolate to generate a new grid</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="keyword">call </span>interpolate_grid(count_nonzero_layers, htmp, xtmp, ppoly_i_e, ppoly_i_coefficients, &amp;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;                              cs%target_density, ppoly_degree, nz, h1, x1 )</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        <span class="keyword">call </span>old_inflate_layers_1d( cs%min_thickness, nz, h1 )</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        x1(1) = 0.0 ; <span class="keywordflow">do</span> k = 1,nz ; x1(k+1) = x1(k) + h1(k) ;<span class="keywordflow"> end do</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        <span class="comment">! Remap T and S from previous grid to new grid</span></div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;          h1(k) = x1(k+1) - x1(k)</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="keyword">call </span>remapping_core_h(nz, h0, s_col, nz, h1, tmp_col, remapcs)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        s_col(:) = tmp_col(:)</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;        <span class="keyword">call </span>remapping_core_h(nz, h0, t_col, nz, h1, tmp_col, remapcs)</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        t_col(:) = tmp_col(:)</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        <span class="comment">! Compute the deviation between two successive grids</span></div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        deviation = 0.0</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        x0(1) = 0.0</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        x1(1) = 0.0</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="keywordflow">do</span> k = 2,nz</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;          x0(k) = x0(k-1) + h0(k-1)</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;          x1(k) = x1(k-1) + h1(k-1)</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;          deviation = deviation + (x0(k)-x1(k))**2</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keywordflow">        end do</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        deviation = sqrt( deviation / (nz-1) )</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        m = m + 1</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="comment">! Copy final grid onto start grid for next iteration</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        h0(:) = h1(:)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;<span class="keywordflow">      end do</span> <span class="comment">! end regridding iterations</span></div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      <span class="comment">! Local depth (G%bathyT is positive)</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;      nominaldepth = g%bathyT(i,j)*gv%m_to_H</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;      totalthickness = 0.0</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;      <span class="keywordflow">if</span> (cs%integrate_downward_for_e) <span class="keywordflow">then</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        zold(1) = 0.</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        znew(1) = 0.</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;          totalthickness = totalthickness + h(i,j,k)</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;          znew(k+1) = znew(k) - h1(k)</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;          <span class="comment">! Adjust interface position to accomodate inflating layers</span></div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;          <span class="comment">! without disturbing the interface above</span></div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;          zold(k+1) = zold(k) - h(i,j,k)</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="comment">! The rest of the model defines grids integrating up from the bottom</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        zold(nz+1) = - nominaldepth</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        znew(nz+1) = - nominaldepth</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        <span class="keywordflow">do</span> k = nz,1,-1</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;          totalthickness = totalthickness + h(i,j,k)</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;          znew(k) = znew(k+1) + h1(k)</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;          <span class="comment">! Adjust interface position to accomodate inflating layers</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;          <span class="comment">! without disturbing the interface above</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;          zold(k) = zold(k+1) + h(i,j,k)</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;      <span class="comment">! Calculate the final change in grid position after blending new and old grids</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;      <span class="keyword">call </span>filtered_grid_motion( cs, nz, zold, znew, dzinterface(i,j,:) )</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;<span class="preprocessor"></span>      <span class="keywordflow">do</span> k = 2,nz</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        <span class="keywordflow">if</span> (znew(k) &gt; zold(1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;zOld=&#39;</span>,zold</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;zNew=&#39;</span>,znew</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;          <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding, build_rho_grid: &#39;</span>//&amp;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;               <span class="stringliteral">&#39;interior interface above surface!&#39;</span> )</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="keywordflow">if</span> (znew(k) &gt; znew(k-1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;zOld=&#39;</span>,zold</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;          <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;zNew=&#39;</span>,znew</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;          <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding, build_rho_grid: &#39;</span>//&amp;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;               <span class="stringliteral">&#39;interior interfaces cross!&#39;</span> )</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;<span class="preprocessor"></span>      dh=max(nominaldepth,totalthickness)</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;      <span class="keywordflow">if</span> (abs(znew(1)-zold(1))&gt;(nz-1)*0.5*epsilon(dh)*dh) <span class="keywordflow">then</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;min_thickness=&#39;</span>,cs%min_thickness</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;nominalDepth=&#39;</span>,nominaldepth,<span class="stringliteral">&#39;totalThickness=&#39;</span>,totalthickness</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;zNew(1)-zOld(1) = &#39;</span>,znew(1)-zold(1),epsilon(dh),nz</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;          <span class="keyword">write</span>(0,*) k,zold(k),znew(k)</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;          <span class="keyword">write</span>(0,*) k,h(i,j,k),znew(k)-znew(k+1)</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;        <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;               <span class="stringliteral">&#39;MOM_regridding, build_rho_grid: top surface has moved!!!&#39;</span> )</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keywordflow">    end do</span>  <span class="comment">! end loop on i</span></div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="keywordflow">  end do</span>  <span class="comment">! end loop on j</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="ttc" id="structmom__remapping_1_1remapping__cs_html"><div class="ttname"><a href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">mom_remapping::remapping_cs</a></div><div class="ttdoc">Container for remapping parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d8b/MOM__remapping_8F90_source.html#l00022">MOM_remapping.F90:22</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a58a19305bbdab26bfa4f336dfac8c4f8_cgraph.svg" width="100%" height="514"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a58a19305bbdab26bfa4f336dfac8c4f8_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a455d807ccfbbfd109be231321bec1038"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_sigma_grid </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>The change in interface depth in H. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00729">729</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">filtered_grid_motion()</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;<span class="comment">! This routine builds a grid based on terrain-following coordinates.</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;<span class="comment">! The module parameter coordinateResolution(:) determines the resolution in</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="comment">! sigma coordinate, dSigma(:). sigma-coordinates are defined by</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="comment">!   sigma = (eta-z)/(H+eta)  s.t. sigma=0 at z=eta and sigma=1 at z=-H .</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                          <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                        <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Ocean grid structure</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                      <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Layer thicknesses, in H</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; The change in interface depth in H.</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  <span class="keywordtype">integer</span> :: nz</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;  <span class="keywordtype">real</span>    :: nominaldepth, totalthickness, dh</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: zold, znew</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  nz = gv%ke</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;      <span class="comment">! Determine water column height</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;      totalthickness = 0.0</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;      <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        totalthickness = totalthickness + h(i,j,k)</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;      <span class="comment">! The rest of the model defines grids integrating up from the bottom</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      nominaldepth = g%bathyT(i,j)*gv%m_to_H</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;      zold(nz+1) = - nominaldepth</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;      znew(nz+1) = - nominaldepth</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;      <span class="keywordflow">do</span> k = nz,1,-1</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;        znew(k) = znew(k+1) + ( totalthickness * cs%coordinateResolution(k) )</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="comment">! Adjust interface position to accomodate inflating layers</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        <span class="comment">! without disturbing the interface above</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;        <span class="keywordflow">if</span> ( znew(k) &lt; (znew(k+1) + cs%min_thickness) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;          znew(k) = znew(k+1) + cs%min_thickness</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;        zold(k) = zold(k+1) + h(i,j,k)</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <span class="comment">! Calculate the final change in grid position after blending new and old grids</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;      <span class="keyword">call </span>filtered_grid_motion( cs, nz, zold, znew, dzinterface(i,j,:) )</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="preprocessor"></span>      dh=max(nominaldepth,totalthickness)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      <span class="keywordflow">if</span> (abs(znew(1)-zold(1))&gt;(nz-1)*0.5*epsilon(dh)*dh) <span class="keywordflow">then</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;min_thickness=&#39;</span>,cs%min_thickness</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;nominalDepth=&#39;</span>,nominaldepth,<span class="stringliteral">&#39;totalThickness=&#39;</span>,totalthickness</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;dzInterface(1) = &#39;</span>,dzinterface(i,j,1),epsilon(dh),nz</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;          <span class="keyword">write</span>(0,*) k,zold(k),znew(k)</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;          <span class="keyword">write</span>(0,*) k,h(i,j,k),znew(k)-znew(k+1),totalthickness*cs%coordinateResolution(k),cs%coordinateResolution(k)</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;               <span class="stringliteral">&#39;MOM_regridding, build_sigma_grid: top surface has moved!!!&#39;</span> )</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;      dzinterface(i,j,1) = 0.</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;      dzinterface(i,j,nz+1) = 0.</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="keywordflow">    end do</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a455d807ccfbbfd109be231321bec1038_cgraph.svg" width="100%" height="361"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a455d807ccfbbfd109be231321bec1038_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1fe77f09d8e5ea5eae1a0cff087d5464"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::build_zstar_column </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>total_thickness</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(inout)&#160;</td>
          <td class="paramname"><em>zInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>z_rigid_top</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>eta_orig</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Builds a z* coordinate with a minimum thickness. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nz</td><td>Number of levels</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">depth</td><td>Depth of ocean bottom (positive in m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">total_thickness</td><td>Column thickness (positive in m)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">zinterface</td><td>Absolute positions of interfaces</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">z_rigid_top</td><td>The height of a rigid top (negative in m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">eta_orig</td><td>The actual original height of the top (m) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00654">654</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00574">build_zstar_grid()</a>, and <a class="el" href="../../db/da5/MOM__diag__mediator_8F90_source.html#l00830">mom_diag_mediator::diag_update_target_grids()</a>.</p>
<div class="fragment"><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),   <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nz<span class="comment"> !&lt; Number of levels</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span>    :: depth<span class="comment"> !&lt; Depth of ocean bottom (positive in m)</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span>    :: total_thickness<span class="comment"> !&lt; Column thickness (positive in m)</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(inout)</span> :: zinterface<span class="comment"> !&lt; Absolute positions of interfaces</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,        <span class="keywordtype">intent(in)</span>    :: z_rigid_top<span class="comment"> !&lt; The height of a rigid top (negative in m)</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,        <span class="keywordtype">intent(in)</span>    :: eta_orig<span class="comment"> !&lt; The actual original height of the top (m)</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  <span class="keywordtype">real</span> :: eta, stretching, dh, min_thickness, z0_top, z_star</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;  <span class="keywordtype">logical</span> :: new_zstar_def</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  new_zstar_def = .false.</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  min_thickness = min( cs%min_thickness, total_thickness/<span class="keywordtype">real(nz)</span> )</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  z0_top = 0.</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(z_rigid_top)) <span class="keywordflow">then</span></div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    z0_top = z_rigid_top</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    new_zstar_def = .true.</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  <span class="comment">! Position of free-surface (or the rigid top, for which eta ~ z0_top)</span></div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  eta = total_thickness - depth</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(eta_orig)) eta = eta_orig</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <span class="comment">! Conventional z* coordinate:</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="comment">!   z* = (z-eta) / stretching   where stretching = (H+eta)/H</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  <span class="comment">!   z = eta + stretching * z*</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="comment">! The above gives z*(z=eta) = 0, z*(z=-H) = -H.</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  <span class="comment">! With a rigid top boundary at eta = z0_top then</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="comment">!   z* = z0 + (z-eta) / stretching   where stretching = (H+eta)/(H+z0)</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="comment">!   z = eta + stretching * (z*-z0) * stretching</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  stretching = total_thickness / ( depth + z0_top )</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  <span class="keywordflow">if</span> (new_zstar_def) <span class="keywordflow">then</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="comment">! z_star is the notional z* coordinate in absence of upper/lower topography</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    z_star = 0. <span class="comment">! z*=0 at the free-surface</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    zinterface(1) = eta <span class="comment">! The actual position of the top of the column</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="keywordflow">do</span> k = 2,nz</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      z_star = z_star - cs%coordinateResolution(k-1)</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      <span class="comment">! This ensures that z is below a rigid upper surface (ice shelf bottom)</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      zinterface(k) = min( eta + stretching * ( z_star - z0_top ), z0_top )</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;      <span class="comment">! This ensures that the layer in inflated</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;      zinterface(k) = min( zinterface(k), zinterface(k-1) - min_thickness )</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      <span class="comment">! This ensures that z is above or at the topography</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      zinterface(k) = max( zinterface(k), -depth + <span class="keywordtype">real(nz+1-k)</span> * min_thickness )</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    zinterface(nz+1) = -depth</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    <span class="comment">! Integrate down from the top for a notional new grid, ignoring topography</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    <span class="comment">! The starting position is offset by z0_top which, if z0_top&lt;0, will place</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    <span class="comment">! interfaces above the rigid boundary.</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    zinterface(1) = eta</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;      dh = stretching * cs%coordinateResolution(k) <span class="comment">! Notional grid spacing</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      zinterface(k+1) = zinterface(k) - dh</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="comment">! Integrating up from the bottom adjusting interface position to accommodate</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="comment">! inflating layers without disturbing the interface above</span></div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    zinterface(nz+1) = -depth</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">do</span> k = nz,1,-1</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;      <span class="keywordflow">if</span> ( zinterface(k) &lt; (zinterface(k+1) + min_thickness) ) <span class="keywordflow">then</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;        zinterface(k) = zinterface(k+1) + min_thickness</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a1fe77f09d8e5ea5eae1a0cff087d5464_icgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ae49eb6807ab2559382afe3a56f0c8793"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::build_zstar_grid </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Builds a z*-ccordinate grid with partial steps (Adcroft and Campin, 2004). z* is defined as z* = (z-eta)/(H+eta)*H s.t. z*=0 when z=eta and z*=-H when z=-H . </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses, in H</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>The change in interface depth in H. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00574">574</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01726">adjust_interface_motion()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00654">build_zstar_column()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">filtered_grid_motion()</a>, and <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                          <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                        <span class="keywordtype">intent(in)</span>    :: g<span class="comment">  !&lt; Ocean grid structure</span></div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                      <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,    <span class="keywordtype">intent(in)</span>    :: h<span class="comment">  !&lt; Layer thicknesses, in H</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; The change in interface depth in H.</span></div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordtype">integer</span> :: nz</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="keywordtype">real</span>    :: nominaldepth, totalthickness, dh</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(GV)+1)</span> :: zold, znew</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordtype">real</span> :: minthickness</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  nz = gv%ke</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  minthickness = cs%min_thickness</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,dzInterface,CS,nz,h)                 &amp;</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">!$OMP                          private(nominalDepth,totalThickness,minThickness, &amp;</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="comment">!$OMP                                  zNew,dh,zOld)</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)==0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        dzinterface(i,j,:) = 0.</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        cycle</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      <span class="comment">! Local depth (G%bathyT is positive)</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      nominaldepth = g%bathyT(i,j)*gv%m_to_H</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      <span class="comment">! Determine water column thickness</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      totalthickness = 0.0</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      <span class="keywordflow">do</span> k = 1,nz</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;        totalthickness = totalthickness + h(i,j,k)</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      zold(nz+1) = - nominaldepth</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="keywordflow">do</span> k = nz,1,-1</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        zold(k) = zold(k+1) + h(i,j,k)</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;      <span class="keywordflow">if</span> (totalthickness-nominaldepth&lt;cs%height_of_rigid_surface) <span class="keywordflow">then</span></div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        <span class="keyword">call </span>build_zstar_column(cs, nz, nominaldepth, totalthickness, znew, &amp;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                                z_rigid_top = totalthickness-nominaldepth, &amp;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                                eta_orig = zold(1))</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        <span class="keyword">call </span>build_zstar_column(cs, nz, nominaldepth, totalthickness, znew)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;      <span class="comment">! Calculate the final change in grid position after blending new and old grids</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;      <span class="keyword">call </span>filtered_grid_motion( cs, nz, zold, znew, dzinterface(i,j,:) )</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="preprocessor"></span>      dh=max(nominaldepth,totalthickness)</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      <span class="keywordflow">if</span> (abs(znew(1)-zold(1))&gt;(nz-1)*0.5*epsilon(dh)*dh) <span class="keywordflow">then</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;min_thickness=&#39;</span>,minthickness</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;nominalDepth=&#39;</span>,nominaldepth,<span class="stringliteral">&#39;totalThickness=&#39;</span>,totalthickness</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;dzInterface(1) = &#39;</span>,dzinterface(i,j,1),epsilon(dh),nz</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        <span class="keywordflow">do</span> k=1,nz+1</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;          <span class="keyword">write</span>(0,*) k,zold(k),znew(k)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;          <span class="keyword">write</span>(0,*) k,h(i,j,k),znew(k)-znew(k+1),cs%coordinateResolution(k)</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;               <span class="stringliteral">&#39;MOM_regridding, build_zstar_grid(): top surface has moved!!!&#39;</span> )</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="preprocessor"></span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;      <span class="keyword">call </span>adjust_interface_motion( nz, cs%min_thickness, h(i,j,:), dzinterface(i,j,:) )</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="keywordflow">    end do</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ae49eb6807ab2559382afe3a56f0c8793_cgraph.svg" width="100%" height="459"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ae49eb6807ab2559382afe3a56f0c8793_icgraph.svg" width="370" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a25136915d797aa14491ca778370f46f8"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::calc_h_new_by_dz </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(in)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_new</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Calculates h_new from h + delta_k dzInterface. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Old layer thicknesses (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dzinterface</td><td>Change in interface positions (m)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_new</td><td>New layer thicknesses (m) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00339">339</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment"> !&lt; Grid structure</span></div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span>    :: h<span class="comment"> !&lt; Old layer thicknesses (m)</span></div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(in)</span>    :: dzinterface<span class="comment"> !&lt; Change in interface positions (m)</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(inout)</span> :: h_new<span class="comment"> !&lt; New layer thicknesses (m)</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,h,dzInterface,h_new)</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="keywordflow">do</span> k=1,gv%ke</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;          h_new(i,j,k) = max( 0., h(i,j,k) + ( dzinterface(i,j,k) - dzinterface(i,j,k+1) ) )</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        h_new(i,j,:) = h(i,j,:)</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a25136915d797aa14491ca778370f46f8_icgraph.svg" width="366" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="ab2a6be87039f49176d91a494126d8430"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::check_grid_column </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check that the total thickness of new and old grids are consistent. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nk</td><td>Number of cells</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">depth</td><td>Depth of bottom (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Cell thicknesses (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dzinterface</td><td>Change in interface positions (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">msg</td><td>Message to append to errors </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00383">383</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00364">check_remapping_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span> :: nk<span class="comment"> !&lt; Number of cells</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="keywordtype">real</span>,                  <span class="keywordtype">intent(in)</span> :: depth<span class="comment"> !&lt; Depth of bottom (m)</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk)</span>,   <span class="keywordtype">intent(in)</span> :: h<span class="comment"> !&lt; Cell thicknesses (m)</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span>, <span class="keywordtype">intent(in)</span> :: dzinterface<span class="comment"> !&lt; Change in interface positions (m)</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span> :: msg<span class="comment"> !&lt; Message to append to errors</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordtype">real</span>    :: eps, total_h_old, total_h_new, h_new, z_old, z_new</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  eps =1. ; eps = epsilon(eps)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="comment">! Total thickness of grid h</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  total_h_old = 0.</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">do</span> k = 1,nk</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    total_h_old = total_h_old + h(k)</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="comment">! Integrate upwards for the interfaces consistent with the rest of MOM6</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  z_old = - depth</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span> (depth == 0.) z_old = - total_h_old</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  total_h_new = 0.</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordflow">do</span> k = nk,1,-1</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    z_old = z_old + h(k) <span class="comment">! Old interface position above layer k</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    z_new = z_old + dzinterface(k) <span class="comment">! New interface position based on dzInterface</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    h_new = h(k) + ( dzinterface(k) - dzinterface(k+1) ) <span class="comment">! New thickness</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">if</span> (h_new&lt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;k,h,hnew=&#39;</span>,k,h(k),h_new</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;dzI(k+1),dzI(k)=&#39;</span>,dzinterface(k+1),dzinterface(k)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding, check_grid_column: &#39;</span>//&amp;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        <span class="stringliteral">&#39;Negative layer thickness implied by re-gridding, &#39;</span>//trim(msg))</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    total_h_new = total_h_new + h_new</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="comment">! Conservation by implied h_new</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordflow">if</span> (abs(total_h_new-total_h_old)&gt;<span class="keywordtype">real</span>(nk-1)*0.5*(total_h_old+total_h_new)*eps) then</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;nk=&#39;</span>,nk</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordflow">do</span> k = 1,nk</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;k,h,hnew=&#39;</span>,k,h(k),h(k)+(dzinterface(k)-dzinterface(k+1))</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;Hold,Hnew,Hnew-Hold=&#39;</span>,total_h_old,total_h_new,total_h_new-total_h_old</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;eps,(n)/2*eps*H=&#39;</span>,eps,<span class="keywordtype">real</span>(nk-1)*0.5*(total_h_old+total_h_new)*eps</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;MOM_regridding, check_grid_column: &#39;</span>//&amp;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      <span class="stringliteral">&#39;Re-gridding did NOT conserve total thickness to within roundoff &#39;</span>//trim(msg))</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="comment">! Check that the top and bottom are intentionally moving</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keywordflow">if</span> (dzinterface(1) /= 0.) <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="stringliteral">&#39;MOM_regridding, check_grid_column: Non-zero dzInterface at surface! &#39;</span>//trim(msg))</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keywordflow">if</span> (dzinterface(nk+1) /= 0.) <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="stringliteral">&#39;MOM_regridding, check_grid_column: Non-zero dzInterface at bottom! &#39;</span>//trim(msg))</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ab2a6be87039f49176d91a494126d8430_cgraph.svg" width="488" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ab2a6be87039f49176d91a494126d8430_icgraph.svg" width="556" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a810d6a0658d645ac7a9e2b6680ce819c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::check_remapping_grid </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)+1), intent(in)&#160;</td>
          <td class="paramname"><em>dzInterface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>msg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Check that the total thickness of two grids match. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thicknesses (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dzinterface</td><td>Change in interface positions (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">msg</td><td>Message to append to errors </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00364">364</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00383">check_grid_column()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                       <span class="keywordtype">intent(in)</span> :: g<span class="comment"> !&lt; Grid structure</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                     <span class="keywordtype">intent(in)</span> :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>,   <span class="keywordtype">intent(in)</span> :: h<span class="comment"> !&lt; Layer thicknesses (m)</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV)+1)</span>, <span class="keywordtype">intent(in)</span> :: dzinterface<span class="comment"> !&lt; Change in interface positions (m)</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordtype">character(len=*)</span>,                            <span class="keywordtype">intent(in)</span> :: msg<span class="comment"> !&lt; Message to append to errors</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;  <span class="keywordtype">integer</span> :: i, j</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(G,GV,h,dzInterface,msg)</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      <span class="keywordflow">if</span> (g%mask2dT(i,j)&gt;0.) <span class="keyword">call </span>check_grid_column( gv%ke, g%bathyT(i,j), h(i,j,:), dzinterface(i,j,:), msg )</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a810d6a0658d645ac7a9e2b6680ce819c_cgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a810d6a0658d645ac7a9e2b6680ce819c_icgraph.svg" width="375" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aac58190f39678cb94e0f918455804f43"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::convective_adjustment </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02360">2360</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">regridding_main()</a>.</p>
<div class="fragment"><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="comment">! Check each water column to see whether it is stratified. If not, sort the</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="comment">! layers by successive swappings of water masses (bubble sort algorithm)</span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type), <span class="keywordtype">intent(in)</span>                  :: g</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>                :: gv</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs), <span class="keywordtype">intent(inout)</span>               :: tv</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;  <span class="keywordtype">integer</span>   :: i, j, k</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;  <span class="keywordtype">real</span>      :: t0, t1       <span class="comment">! temperatures</span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;  <span class="keywordtype">real</span>      :: s0, s1       <span class="comment">! salinities</span></div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;  <span class="keywordtype">real</span>      :: r0, r1       <span class="comment">! densities</span></div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;  <span class="keywordtype">real</span>      :: h0, h1</div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;  <span class="keywordtype">logical</span>   :: stratified</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(GV%ke)</span> :: p_col, densities</div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;  p_col(:) = 0.</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;  <span class="comment">! Loop on columns</span></div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;  <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1 ; <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;    <span class="comment">! Compute densities within current water column</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;    <span class="keyword">call </span>calculate_density( tv%T(i,j,:), tv%S(i,j,:), p_col, &amp;</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;                            densities, 1, gv%ke, tv%eqn_of_state )</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;    <span class="comment">! Repeat restratification until complete</span></div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;    <span class="keywordflow">do</span></div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;      stratified = .true.</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;      <span class="keywordflow">do</span> k = 1,gv%ke-1</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;        <span class="comment">! Gather information of current and next cells</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;        t0 = tv%T(i,j,k)  ; t1 = tv%T(i,j,k+1)</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;        s0 = tv%S(i,j,k)  ; s1 = tv%S(i,j,k+1)</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;        r0 = densities(k) ; r1 = densities(k+1)</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;        h0 = h(i,j,k) ; h1 = h(i,j,k+1)</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;        <span class="comment">! If the density of the current cell is larger than the density</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;        <span class="comment">! below it, we swap the cells and recalculate the densitiies</span></div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;        <span class="comment">! within the swapped cells</span></div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;        <span class="keywordflow">if</span> ( r0 &gt; r1 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;          tv%T(i,j,k) = t1 ; tv%T(i,j,k+1) = t0</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;          tv%S(i,j,k) = s1 ; tv%S(i,j,k+1) = s0</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;          h(i,j,k)    = h1 ; h(i,j,k+1)    = h0</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;          <span class="comment">! Recompute densities at levels k and k+1</span></div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;          <span class="keyword">call </span>calculate_density( tv%T(i,j,k), tv%S(i,j,k), p_col(k), &amp;</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;                                  densities(k), tv%eqn_of_state )</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;          <span class="keyword">call </span>calculate_density( tv%T(i,j,k+1), tv%S(i,j,k+1), p_col(k+1), &amp;</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;                                  densities(k+1), tv%eqn_of_state )</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;          stratified = .false.</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;<span class="keywordflow">      enddo</span>  <span class="comment">! k</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;</div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;      <span class="keywordflow">if</span> ( stratified ) <span class="keywordflow">exit</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;</div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span>  <span class="comment">! i &amp; j</span></div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_aac58190f39678cb94e0f918455804f43_icgraph.svg" width="396" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a9f55ab3a80ab1202b7664e9c65ebf08b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::end_regridding </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Deallocation of regridding memory. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00259">259</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02763">regridding_memory_deallocation()</a>.</p>
<div class="fragment"><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="keyword">call </span>regridding_memory_deallocation( cs )</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a9f55ab3a80ab1202b7664e9c65ebf08b_cgraph.svg" width="338" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a9dddf53999f90d1a4edc79179c5b5da4"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::filtered_grid_motion </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>z_old</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>z_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nk+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dz_g</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Returns the change in interface position motion after filtering and assuming the top and bottom interfaces do not move. The filtering is a function of depth, and is applied as the integrated average filtering over the trajectory of the interface. By design, this code can not give tangled interfaces provided that z_old and z_new are not already tangled. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nk</td><td>Number of cells</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">z_old</td><td>Old grid position (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">z_new</td><td>New grid position (m)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dz_g</td><td>Change in interface positions (m) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00444">444</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">build_grid_hycom1()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01151">build_grid_slight()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00729">build_sigma_grid()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00574">build_zstar_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                           <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nk<span class="comment"> !&lt; Number of cells</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span>, <span class="keywordtype">intent(in)</span>    :: z_old<span class="comment"> !&lt; Old grid position (m)</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span>, <span class="keywordtype">intent(in)</span>    :: z_new<span class="comment"> !&lt; New grid position (m)</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span>, <span class="keywordtype">intent(inout)</span> :: dz_g<span class="comment"> !&lt; Change in interface positions (m)</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordtype">real</span> :: sgn  <span class="comment">! The sign convention for downward.</span></div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">real</span> :: dz_tgt, zr1</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">real</span> :: aq, bq, dz0, z0, f0</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keywordtype">real</span> :: zs, zd, dzwt, idzwt</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keywordtype">real</span> :: wtd, iwtd</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordtype">real</span> :: int_zs, int_zd, dint_zs_zd</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment">! For debugging:</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nk+1)</span> :: z_act</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">!  real, dimension(nk+1) :: ddz_g_s, ddz_g_d</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordtype">logical</span> :: debug = .false.</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">if</span> ((z_old(nk+1) - z_old(1)) * (z_new(nk+1) - z_new(1)) &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;filtered_grid_motion: z_old and z_new use different sign conventions.&quot;</span>)</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordflow">elseif</span> ((z_old(nk+1) - z_old(1)) * (z_new(nk+1) - z_new(1)) == 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">! This is a massless column, so do nothing and return.</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">do</span> k=1,nk+1 ; dz_g(k) = 0.0 ;<span class="keywordflow"> enddo</span> ; <span class="keywordflow">return</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordflow">elseif</span> ((z_old(nk+1) - z_old(1)) + (z_new(nk+1) - z_new(1)) &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    sgn = 1.0</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    sgn = -1.0</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">do</span> k=2,nk+1</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      <span class="keywordflow">if</span> (sgn*(z_new(k)-z_new(k-1)) &lt; -5e-16*(abs(z_new(k))+abs(z_new(k-1))) ) &amp;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;filtered_grid_motion: z_new is tangled.&quot;</span>)</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="keywordflow">if</span> (sgn*(z_old(k)-z_old(k-1)) &lt; -5e-16*(abs(z_old(k))+abs(z_old(k-1))) ) &amp;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;filtered_grid_motion: z_old is tangled.&quot;</span>)</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">! ddz_g_s(:) = 0.0 ; ddz_g_d(:) = 0.0</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  </div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;  zs = cs%depth_of_time_filter_shallow</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  zd = cs%depth_of_time_filter_deep</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  wtd = 1.0 - cs%old_grid_weight</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  iwtd = 1.0 / wtd</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  dzwt = (zd - zs)</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  idzwt = 0.0 ; <span class="keywordflow">if</span> (abs(zd - zs) &gt; 0.0) idzwt = 1.0 / (zd - zs)</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  dint_zs_zd = 0.5*(1.0 + iwtd) * (zd - zs)</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  aq = 0.5*(iwtd - 1.0)</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  dz_g(1) = 0.0</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="keywordflow">do</span> k = 2,nk</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">! zr1 is positive and increases with depth, and dz_tgt is positive downward.</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    dz_tgt = sgn*(z_new(k) - z_old(k))</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    zr1 = sgn*(z_old(k) - z_old(1))</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    </div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment">!   First, handle the two simple and common cases that do not pass through</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="comment">! the adjustment rate transition zone.</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="keywordflow">if</span> ((zr1 &gt; zd) .and. (zr1 + wtd * dz_tgt &gt; zd)) <span class="keywordflow">then</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      dz_g(k) = sgn * wtd * dz_tgt</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordflow">elseif</span> ((zr1 &lt; zs) .and. (zr1 + dz_tgt &lt; zs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;      dz_g(k) = sgn * dz_tgt</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;      <span class="comment">! Find the new value by inverting the equation</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;      <span class="comment">!   integral(0 to dz_new) Iwt(z) dz = dz_tgt</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;      <span class="comment">! This is trivial where Iwt is a constant, and agrees with the two limits above.</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      </div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;      <span class="comment">! Take test values at the transition points to figure out which segment</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;      <span class="comment">! the new value will be found in.</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;      <span class="keywordflow">if</span> (zr1 &gt;= zd) <span class="keywordflow">then</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        int_zd = iwtd*(zd - zr1)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        int_zs = int_zd - dint_zs_zd</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keywordflow">elseif</span> (zr1 &lt;= zs) <span class="keywordflow">then</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;        int_zs = (zs - zr1)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        int_zd = dint_zs_zd + (zs - zr1)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">!        Int_zd = (zd - zr1) * (Iwtd + 0.5*(1.0 - Iwtd) * (zd - zr1) / (zd - zs))</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        int_zd = (zd - zr1) * (iwtd*(0.5*(zd+zr1) - zs) + 0.5*(zd - zr1)) * idzwt</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        int_zs = (zs - zr1) * (0.5*iwtd * ((zr1 - zs)) + (zd - 0.5*(zr1+zs))) * idzwt</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        <span class="comment">! It has been verified that  Int_zs = Int_zd - dInt_zs_zd to within roundoff.</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;      </div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;      <span class="keywordflow">if</span> (dz_tgt &gt;= int_zd) <span class="keywordflow">then</span> <span class="comment">! The new location is in the deep, slow region.</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;        dz_g(k) = sgn * ((zd-zr1) + wtd*(dz_tgt - int_zd))</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;      <span class="keywordflow">elseif</span> (dz_tgt &lt;= int_zs) <span class="keywordflow">then</span> <span class="comment">! The new location is in the shallow region.</span></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;        dz_g(k) = sgn * ((zs-zr1) + (dz_tgt - int_zs))</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;      <span class="keywordflow">else</span>  <span class="comment">! We need to solve a quadratic equation for z_new.</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="comment">! For accuracy, do the integral from the starting depth or the nearest</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;        <span class="comment">! edge of the transition region.  The results with each choice are</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;        <span class="comment">! mathematically equivalent, but differ in roundoff, and this choice</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        <span class="comment">! should minimize the likelihood of inadvertently overlapping interfaces.</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        <span class="keywordflow">if</span> (zr1 &lt;= zs) <span class="keywordflow">then</span> ; dz0 = zs-zr1 ; z0 = zs ; f0 = dz_tgt - int_zs</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;        <span class="keywordflow">elseif</span> (zr1 &gt;= zd) <span class="keywordflow">then</span> ; dz0 = zd-zr1 ; z0 = zd ; f0 = dz_tgt - int_zd</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="keywordflow">else</span> ; dz0 = 0.0 ; z0 = zr1 ; f0 = dz_tgt ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        bq = (dzwt + 2.0*aq*(z0-zs))</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="comment">! Solve the quadratic: Aq*(zn-z0)**2 + Bq*(zn-z0) - F0*dzwt = 0</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;        <span class="comment">! Note that b&gt;=0, and the two terms in the standard form cancel for the right root.</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        dz_g(k) = sgn * (dz0 + 2.0*f0*dzwt / (bq + sqrt(bq**2 + 4.0*aq*f0*dzwt) ))</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="comment">!       if (debug) then</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">!         dz0 = zs-zr1 ; z0 = zs ; F0 = dz_tgt - Int_zs ; Bq = (dzwt + 2.0*Aq*(z0-zs))</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">!         ddz_g_s(k) = sgn * (dz0 + 2.0*F0*dzwt / (Bq + sqrt(Bq**2 + 4.0*Aq*F0*dzwt) )) - dz_g(k)</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">!         dz0 = zd-zr1 ; z0 = zd ; F0 = dz_tgt - Int_zd ; Bq = (dzwt + 2.0*Aq*(z0-zs))</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">!         ddz_g_d(k) = sgn * (dz0 + 2.0*F0*dzwt / (Bq + sqrt(Bq**2 + 4.0*Aq*F0*dzwt) )) - dz_g(k)</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">!         </span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="comment">!         if (abs(ddz_g_s(k)) &gt; 1e-12*(abs(dz_g(k)) + abs(dz_g(k)+ddz_g_s(k)))) &amp;</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="comment">!           call MOM_error(WARNING, &quot;filtered_grid_motion: Expect z_output to be tangled (sc).&quot;)</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">!         if (abs(ddz_g_d(k) - ddz_g_s(k)) &gt; 1e-12*(abs(dz_g(k)+ddz_g_d(k)) + abs(dz_g(k)+ddz_g_s(k)))) &amp;</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">!           call MOM_error(WARNING, &quot;filtered_grid_motion: Expect z_output to be tangled.&quot;)</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">!       endif</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  dz_g(nk+1) = 0.0</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="keywordflow">if</span> (debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    <span class="keywordflow">do</span> k=1,nk+1 ; z_act(k) = z_old(k) + dz_g(k) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="keywordflow">do</span> k=2,nk+1</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      <span class="keywordflow">if</span> (sgn*((z_act(k))-z_act(k-1)) &lt; -1e-15*(abs(z_act(k))+abs(z_act(k-1))) ) &amp;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;filtered_grid_motion: z_output is tangled.&quot;</span>)</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a9dddf53999f90d1a4edc79179c5b5da4_cgraph.svg" width="494" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a9dddf53999f90d1a4edc79179c5b5da4_icgraph.svg" width="556" height="314"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a6ec0dea34ca979892fcaf54a2c676c5e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real function mom_regridding::get_polynomial_coordinate </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>x_g</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(in)&#160;</td>
          <td class="paramname"><em>ppoly_E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(in)&#160;</td>
          <td class="paramname"><em>ppoly_coefficients</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>target_value</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>degree</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<dl class="section return"><dt>Returns</dt><dd>The position of x_g at which target_value is found. </dd></dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02097">2097</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00206">nr_iterations</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00212">nr_offset</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00208">nr_tolerance</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02054">interpolate_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;<span class="comment">! ------------------------------------------------------------------------------</span></div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="comment">! Here, &#39;ppoly&#39; is assumed to be a piecewise discontinuous polynomial of degree</span></div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="comment">! &#39;degree&#39; throughout the domain defined by &#39;grid&#39;. A target value is given</span></div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;<span class="comment">! and we need to determine the corresponding grid coordinate to define the</span></div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="comment">! new grid.</span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">! If the target value is out of range, the grid coordinate is simply set to</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">! be equal to one of the boundary coordinates, which results in vanished layers</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">! near the boundaries.</span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="comment">! IT IS ASSUMED THAT THE PIECEWISE POLYNOMIAL IS MONOTONICALLY INCREASING.</span></div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="comment">! IF THIS IS NOT THE CASE, THE NEW GRID MAY BE ILL-DEFINED.</span></div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;<span class="comment">! It is assumed that the number of cells defining &#39;grid&#39; and &#39;ppoly&#39; are the</span></div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;<span class="comment">! same.</span></div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="comment">! ------------------------------------------------------------------------------</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;  <span class="keywordtype">integer</span>,              <span class="keywordtype">intent(in)</span> :: n     <span class="comment">! The number of grid cells</span></div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>,   <span class="keywordtype">intent(in)</span> :: h     <span class="comment">! Grid cell thicknesses    (size N)</span></div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>,   <span class="keywordtype">intent(in)</span> :: x_g   <span class="comment">! Grid interface locations (size N+1)</span></div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in)</span> :: ppoly_e  <span class="comment">!Edge value of polynomial</span></div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in)</span> :: ppoly_coefficients <span class="comment">!Coefficients of polynomial</span></div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;  <span class="keywordtype">real</span>,                 <span class="keywordtype">intent(in)</span> :: target_value</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;  <span class="keywordtype">integer</span>,              <span class="keywordtype">intent(in)</span> :: degree <span class="comment">! The degree of the polynomials</span></div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;  <span class="keywordtype">real</span> :: x_tgt<span class="comment">      !&lt; The position of x_g at which target_value is found.</span></div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;  <span class="keywordtype">integer</span>            :: i, k            <span class="comment">! loop indices</span></div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;  <span class="keywordtype">integer</span>            :: k_found         <span class="comment">! index of target cell</span></div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;  <span class="keywordtype">integer</span>            :: iter</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;  <span class="keywordtype">real</span>               :: xi0             <span class="comment">! normalized target coordinate</span></div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(5)</span> :: a               <span class="comment">! polynomial coefficients</span></div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;  <span class="keywordtype">real</span>               :: numerator</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;  <span class="keywordtype">real</span>               :: denominator</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;  <span class="keywordtype">real</span>               :: delta           <span class="comment">! Newton-Raphson increment</span></div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;  <span class="keywordtype">real</span>               :: x               <span class="comment">! global target coordinate</span></div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;  <span class="keywordtype">real</span>               :: eps                 <span class="comment">! offset used to get away from</span></div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;                                        <span class="comment">! boundaries</span></div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;  <span class="keywordtype">real</span>               :: grad            <span class="comment">! gradient during N-R iterations</span></div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;  eps = nr_offset</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;  k_found = -1</div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;  <span class="comment">! If the target value is outside the range of all values, we</span></div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;  <span class="comment">! force the target coordinate to be equal to the lowest or</span></div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;  <span class="comment">! largest value, depending on which bound is overtaken</span></div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;  <span class="keywordflow">if</span> ( target_value &lt;= ppoly_e(1,1) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;    x_tgt = x_g(1)</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    <span class="keywordflow">return</span>  <span class="comment">! return because there is no need to look further</span></div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;  <span class="comment">! Since discontinuous edge values are allowed, we check whether the target</span></div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;  <span class="comment">! value lies between two discontinuous edge values at interior interfaces</span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;  <span class="keywordflow">do</span> k = 2,n</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    <span class="keywordflow">if</span> ( ( target_value &gt;= ppoly_e(k-1,2) ) .AND. &amp;</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;      ( target_value &lt;= ppoly_e(k,1) ) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;      x_tgt = x_g(k)</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;      <span class="keywordflow">return</span>   <span class="comment">! return because there is no need to look further</span></div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;  <span class="comment">! If the target value is outside the range of all values, we</span></div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;  <span class="comment">! force the target coordinate to be equal to the lowest or</span></div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;  <span class="comment">! largest value, depending on which bound is overtaken</span></div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;  <span class="keywordflow">if</span> ( target_value &gt;= ppoly_e(n,2) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    x_tgt = x_g(n+1)</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;    <span class="keywordflow">return</span>  <span class="comment">! return because there is no need to look further</span></div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;  <span class="comment">! At this point, we know that the target value is bounded and does not</span></div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;  <span class="comment">! lie between discontinuous, monotonic edge values. Therefore,</span></div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;  <span class="comment">! there is a unique solution. We loop on all cells and find which one</span></div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;  <span class="comment">! contains the target value. The variable k_found holds the index value</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;  <span class="comment">! of the cell where the taregt value lies.</span></div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;  <span class="keywordflow">do</span> k = 1,n</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    <span class="keywordflow">if</span> ( ( target_value &gt; ppoly_e(k,1) ) .AND. &amp;</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;         ( target_value &lt; ppoly_e(k,2) ) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;      k_found = k</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;  <span class="comment">! At this point, &#39;k_found&#39; should be strictly positive. If not, this is</span></div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;  <span class="comment">! a major failure because it means we could not find any target cell</span></div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;  <span class="comment">! despite the fact that the target value lies between the extremes. It</span></div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;  <span class="comment">! means there is a major problem with the interpolant. This needs to be</span></div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;  <span class="comment">! reported.</span></div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;  <span class="keywordflow">if</span> ( k_found == -1 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;      <span class="keyword">write</span>(*,*) target_value, ppoly_e(1,1), ppoly_e(n,2)</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;      <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;Could not find target coordinate in &#39;</span> //&amp;</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;                 <span class="stringliteral">&#39;&quot;get_polynomial_coordinate&quot;. This is caused by an &#39;</span>//&amp;</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;                 <span class="stringliteral">&#39;inconsistent interpolant (perhaps not monotonically &#39;</span>//&amp;</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;                 <span class="stringliteral">&#39;increasing)&#39;</span></div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;      <span class="keyword">call </span>mom_error( fatal, <span class="stringliteral">&#39;Aborting execution&#39;</span> )</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;  <span class="comment">! Reset all polynomial coefficients to 0 and copy those pertaining to</span></div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;  <span class="comment">! the found cell</span></div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;  a(:) = 0.0</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;  <span class="keywordflow">do</span> i = 1,degree+1</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;    a(i) = ppoly_coefficients(k_found,i)</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;  <span class="comment">! Guess value to start Newton-Raphson iterations (middle of cell)</span></div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;  xi0 = 0.5</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;  iter = 1</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;  delta = 1e10</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;  <span class="comment">! Newton-Raphson iterations</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;  <span class="keywordflow">do</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    <span class="keywordflow">if</span> ( ( iter &gt; nr_iterations ) .OR. &amp;</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;         ( abs(delta) &lt; nr_tolerance ) ) <span class="keywordflow">then</span></div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;      <span class="keywordflow">exit</span></div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;</div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;    numerator = a(1) + a(2)*xi0 + a(3)*xi0*xi0 + a(4)*xi0*xi0*xi0 + &amp;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                a(5)*xi0*xi0*xi0*xi0 - target_value</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;    denominator = a(2) + 2*a(3)*xi0 + 3*a(4)*xi0*xi0 + 4*a(5)*xi0*xi0*xi0</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;    delta = - ( numerator ) / &amp;</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;              ( denominator )</div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;    xi0 = xi0 + delta</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;    <span class="comment">! Check whether new estimate is out of bounds. If the new estimate is</span></div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;    <span class="comment">! indeed out of bounds, we manually set it to be equal to the overtaken</span></div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;    <span class="comment">! bound with a small offset towards the interior when the gradient of</span></div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;    <span class="comment">! the function at the boundary is zero (in which case, the Newton-Raphson</span></div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;    <span class="comment">! algorithm does not converge).</span></div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;    <span class="keywordflow">if</span> ( xi0 &lt; 0.0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;      xi0 = 0.0</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;      grad = a(2)</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;      <span class="keywordflow">if</span> ( grad == 0.0 ) xi0 = xi0 + eps</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;    <span class="keywordflow">if</span> ( xi0 &gt; 1.0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;      xi0 = 1.0</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;      grad = a(2) + 2*a(3) + 3*a(4) + 4*a(5)</div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;      <span class="keywordflow">if</span> ( grad == 0.0 ) xi0 = xi0 - eps</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    iter = iter + 1</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;<span class="keywordflow">  end do</span> <span class="comment">! end Newton-Raphson iterations</span></div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;  x_tgt = x_g(k_found) + xi0 * h(k_found)</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a6ec0dea34ca979892fcaf54a2c676c5e_icgraph.svg" width="100%" height="388"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="abfaa6d8cb64908f5bd1f39f517fa491d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, dimension(cs%nk+1), public mom_regridding::getcoordinateinterfaces </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Query the target coordinate interface positions. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Interface positions in target coordinate </dd></dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02564">2564</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span> :: cs<span class="comment">                      !&lt; Regridding control structure</span></div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk+1)</span>        :: getcoordinateinterfaces<span class="comment"> !&lt; Interface positions in target coordinate</span></div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;</div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;  <span class="comment">! When using a coordinate with target densities, we need to get the actual</span></div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;  <span class="comment">! densities, rather than computing the interfaces based on resolution</span></div><div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;  <span class="keywordflow">if</span> (cs%regridding_scheme == regridding_rho) <span class="keywordflow">then</span></div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;    <span class="keywordflow">if</span> (.not. cs%target_density_set) &amp;</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&#39;MOM_regridding, getCoordinateInterfaces: &#39;</span>//&amp;</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;                            <span class="stringliteral">&#39;target densities not set!&#39;</span>)</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;</div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;    getcoordinateinterfaces(:) = cs%target_density(:)</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;    getcoordinateinterfaces(1) = 0.</div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;    <span class="keywordflow">do</span> k = 1, cs%nk</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;      getcoordinateinterfaces(k+1) = getcoordinateinterfaces(k) &amp;</div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;                                    -cs%coordinateResolution(k)</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;    <span class="comment">! The following line has an &quot;abs()&quot; to allow ferret users to reference</span></div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;    <span class="comment">! data by index. It is a temporary work around...  :(  -AJA</span></div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;    getcoordinateinterfaces(:) = abs( getcoordinateinterfaces(:) )</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="aea8e51bd450503f56264f7bd468a51fc"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, dimension(cs%nk), public mom_regridding::getcoordinateresolution </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02555">2555</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span> :: cs</div><div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk)</span>          :: getcoordinateresolution</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;  getcoordinateresolution(:) = cs%coordinateResolution(:)</div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="ac1e1f08a6d33ab71e6a3c5008c519ee6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=20) function, public mom_regridding::getcoordinateshortname </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02617">2617</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span> :: cs</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;  <span class="keywordtype">character(len=20)</span>               :: getcoordinateshortname</div><div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;</div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;  <span class="keywordflow">select case</span> ( cs%regridding_scheme )</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;    <span class="keywordflow">case</span> ( regridding_zstar )</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;      <span class="comment">!getCoordinateShortName = &#39;z*&#39;</span></div><div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;      <span class="comment">! The following line is a temporary work around...  :(  -AJA</span></div><div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;pseudo-depth, -z*&#39;</span></div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;    <span class="keywordflow">case</span> ( regridding_sigma )</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;sigma&#39;</span></div><div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;    <span class="keywordflow">case</span> ( regridding_rho )</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;rho&#39;</span></div><div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;    <span class="keywordflow">case</span> ( regridding_arbitrary )</div><div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;coordinate&#39;</span></div><div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;    <span class="keywordflow">case</span> ( regridding_hycom1 )</div><div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;z-rho&#39;</span></div><div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;    <span class="keywordflow">case</span> ( regridding_slight )</div><div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;      getcoordinateshortname = <span class="stringliteral">&#39;s-rho&#39;</span></div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;      <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, getCoordinateShortName: &#39;</span>//&amp;</div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;                     <span class="stringliteral">&#39;Unknown regridding scheme selected!&#39;</span>)</div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;<span class="keywordflow">  end select</span> <span class="comment">! type of grid</span></div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="ad693fbb3424bb0ba9d0ad8878828e604"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=20) function, public mom_regridding::getcoordinateunits </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02594">2594</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span> :: cs</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;  <span class="keywordtype">character(len=20)</span>               :: getcoordinateunits</div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  <span class="keywordflow">select case</span> ( cs%regridding_scheme )</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;    <span class="keywordflow">case</span> ( regridding_zstar, regridding_hycom1, regridding_slight )</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;      getcoordinateunits = <span class="stringliteral">&#39;meter&#39;</span></div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;    <span class="keywordflow">case</span> ( regridding_sigma )</div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;      getcoordinateunits = <span class="stringliteral">&#39;fraction&#39;</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;    <span class="keywordflow">case</span> ( regridding_rho )</div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;      getcoordinateunits = <span class="stringliteral">&#39;kg/m3&#39;</span></div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;    <span class="keywordflow">case</span> ( regridding_arbitrary )</div><div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;      getcoordinateunits = <span class="stringliteral">&#39;unknown&#39;</span></div><div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;      <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, getCoordinateUnits: &#39;</span>//&amp;</div><div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;                     <span class="stringliteral">&#39;Unknown regridding scheme selected!&#39;</span>)</div><div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;<span class="keywordflow">  end select</span> <span class="comment">! type of grid</span></div><div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a1587a58d8fe87432c3f7817952014584"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, dimension(cs%nk), public mom_regridding::getstaticthickness </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>SSH</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>depth</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02699">2699</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d4/db9/MOM__ALE_8F90_source.html#l01391">mom_ale::ale_initthicknesstocoord()</a>.</p>
<div class="fragment"><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span> :: cs</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;  <span class="keywordtype">real</span>,                <span class="keywordtype">intent(in)</span> :: ssh</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;  <span class="keywordtype">real</span>,                <span class="keywordtype">intent(in)</span> :: depth</div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk)</span>          :: getstaticthickness</div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;  <span class="comment">! Local</span></div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;  <span class="keywordtype">real</span> :: z, dz</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;  <span class="keywordflow">select case</span> ( cs%regridding_scheme )</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    <span class="keywordflow">case</span> ( regridding_zstar, regridding_hycom1, regridding_slight )</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;      <span class="keywordflow">if</span> (depth&gt;0.) <span class="keywordflow">then</span></div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;        z = ssh</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;        <span class="keywordflow">do</span> k = 1, cs%nk</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;          dz = cs%coordinateResolution(k) * ( 1. + ssh/depth ) <span class="comment">! Nominal dz*</span></div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;          dz = max(dz, 0.)                                     <span class="comment">! Avoid negative incase ssh=-depth</span></div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;          dz = min(dz, depth - z)                              <span class="comment">! Clip if below topography</span></div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;          z = z + dz                                           <span class="comment">! Bottom of layer</span></div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;          getstaticthickness(k) = dz</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;        getstaticthickness(:) = 0. <span class="comment">! On land ...</span></div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;    <span class="keywordflow">case</span> ( regridding_sigma )</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;      getstaticthickness(:) = cs%coordinateResolution(:) * ( depth + ssh )</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;    <span class="keywordflow">case</span> ( regridding_rho )</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;      getstaticthickness(:) = 0. <span class="comment">! Not applicable</span></div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;    <span class="keywordflow">case</span> ( regridding_arbitrary )</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;      getstaticthickness(:) = 0.  <span class="comment">! Not applicable</span></div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;      <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, getStaticThickness: &#39;</span>//&amp;</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;                     <span class="stringliteral">&#39;Unknown regridding scheme selected!&#39;</span>)</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;<span class="keywordflow">  end select</span> <span class="comment">! type of grid</span></div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a1587a58d8fe87432c3f7817952014584_icgraph.svg" width="431" height="38"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aeb36a31003c4887ea1af82c11c627f2f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::inflate_vanished_layers_old </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02256">2256</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02298">old_inflate_layers_1d()</a>.</p>
<div class="fragment"><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;<span class="comment">! This routine is called when initializing the regridding options. The</span></div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;<span class="comment">! objective is to make sure all layers are at least as thick as the minimum</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;<span class="comment">! thickness allowed for regridding purposes (this parameter is set in the</span></div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="comment">! MOM_input file or defaulted to 1.0e-3). When layers are too thin, they</span></div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;<span class="comment">! are inflated up to the minmum thickness.</span></div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                    <span class="keywordtype">intent(in)</span>    :: cs</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                  <span class="keywordtype">intent(in)</span>    :: g</div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                <span class="keywordtype">intent(in)</span>    :: gv</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;  <span class="keywordtype">real</span>    :: htmp(gv%ke)</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;  <span class="keywordflow">do</span> i = g%isc-1,g%iec+1</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;    <span class="keywordflow">do</span> j = g%jsc-1,g%jec+1</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;      <span class="comment">! Build grid for current column</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;      <span class="keywordflow">do</span> k = 1,gv%ke</div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        htmp(k) = h(i,j,k)</div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;      <span class="keyword">call </span>old_inflate_layers_1d( cs%min_thickness, gv%ke, htmp )</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;      <span class="comment">! Save modified grid</span></div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;      <span class="keywordflow">do</span> k = 1,gv%ke</div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;        h(i,j,k) = htmp(k)</div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;<span class="keywordflow">      end do</span></div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;<span class="keywordflow">    end do</span></div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_aeb36a31003c4887ea1af82c11c627f2f_cgraph.svg" width="314" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a44ba264b71ed6239e0016708a0f58fe9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::initialize_regridding </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>coordMode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>interpScheme</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>compressibility_fraction</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialization of regridding. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nk</td><td>Number of levels</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">coordmode</td><td>Coordinate mode to use</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">interpscheme</td><td>Interpolation mode to use</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">compressibility_fraction</td><td>Fraction of compressibility to add to potential density profiles (nondim) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">221</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02738">allocate_regridding()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00185">interpolation_p1m_h2</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00186">interpolation_p1m_h4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00187">interpolation_p1m_ih4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00191">interpolation_p3m_ih4ih3</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00192">interpolation_p3m_ih6ih5</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00188">interpolation_plm</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00189">interpolation_ppm_h4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00190">interpolation_ppm_ih4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00193">interpolation_pqm_ih4ih3</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00194">interpolation_pqm_ih6ih5</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00179">regriddingdefaultboundaryextrapolation</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00180">regriddingdefaultminthickness</a>, and <a class="el" href="../../df/ddf/MOM__string__functions_8F90_source.html#l00062">mom_string_functions::uppercase()</a>.</p>
<div class="fragment"><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nk<span class="comment"> !&lt; Number of levels</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span>    :: coordmode<span class="comment"> !&lt; Coordinate mode to use</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  <span class="keywordtype">character(len=*)</span>,      <span class="keywordtype">intent(in)</span>    :: interpscheme<span class="comment"> !&lt; Interpolation mode to use</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),   <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  <span class="keywordtype">real</span>,        <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span>    :: compressibility_fraction<span class="comment"> !&lt; Fraction of compressibility</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">                                          !! to add to potential density profiles (nondim)</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  cs%nk = nk</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  cs%regridding_scheme = coordinatemode(coordmode)</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keywordflow">select case</span> ( uppercase(trim(interpscheme)) )</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;P1M_H2&quot;</span>);     cs%interpolation_scheme = interpolation_p1m_h2</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;P1M_H4&quot;</span>);     cs%interpolation_scheme = interpolation_p1m_h4</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;P1M_IH2&quot;</span>);    cs%interpolation_scheme = interpolation_p1m_ih4</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PLM&quot;</span>);        cs%interpolation_scheme = interpolation_plm</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PPM_H4&quot;</span>);     cs%interpolation_scheme = interpolation_ppm_h4</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PPM_IH4&quot;</span>);    cs%interpolation_scheme = interpolation_ppm_ih4</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;P3M_IH4IH3&quot;</span>); cs%interpolation_scheme = interpolation_p3m_ih4ih3</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;P3M_IH6IH5&quot;</span>); cs%interpolation_scheme = interpolation_p3m_ih6ih5</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PQM_IH4IH3&quot;</span>); cs%interpolation_scheme = interpolation_pqm_ih4ih3</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    <span class="keywordflow">case</span> (<span class="stringliteral">&quot;PQM_IH6IH5&quot;</span>); cs%interpolation_scheme = interpolation_pqm_ih6ih5</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="keywordflow">    case default</span> ; <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;read_regridding_options: &quot;</span>//&amp;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;     <span class="stringliteral">&quot;Unrecognized choice for INTERPOLATION_SCHEME (&quot;</span>//trim(interpscheme)//<span class="stringliteral">&quot;).&quot;</span>)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  cs%boundary_extrapolation = regriddingdefaultboundaryextrapolation</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  cs%min_thickness = regriddingdefaultminthickness</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(compressibility_fraction)) cs%compressibility_fraction = compressibility_fraction</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keyword">call </span>allocate_regridding( cs )</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a44ba264b71ed6239e0016708a0f58fe9_cgraph.svg" width="516" height="183"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a12dff5ec4c479e77db1813a8d53db7c2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::interpolate_grid </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>h0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>x0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(in)&#160;</td>
          <td class="paramname"><em>ppoly0_E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(in)&#160;</td>
          <td class="paramname"><em>ppoly0_coefficients</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>target_values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>degree</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(inout)&#160;</td>
          <td class="paramname"><em>h1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(inout)&#160;</td>
          <td class="paramname"><em>x1</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02054">2054</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02097">get_polynomial_coordinate()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">build_grid_hycom1()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;<span class="comment">! ------------------------------------------------------------------------------</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;<span class="comment">! Given the grid &#39;grid0&#39; and the piecewise polynomial interpolant</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;<span class="comment">! &#39;ppoly0&#39; (possibly discontinuous), the coordinates of the new grid &#39;grid1&#39;</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;<span class="comment">! are determined by finding the corresponding target interface densities.</span></div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;<span class="comment">! ------------------------------------------------------------------------------</span></div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;  <span class="keywordtype">integer</span>,            <span class="keywordtype">intent(in)</span>    :: n0</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>    :: h0</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>    :: x0</div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in)</span>  :: ppoly0_e            <span class="comment">!Edge value of polynomial</span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">intent(in)</span>  :: ppoly0_coefficients <span class="comment">!Coefficients of polynomial</span></div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>    :: target_values</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;  <span class="keywordtype">integer</span>,            <span class="keywordtype">intent(in)</span>    :: degree</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;  <span class="keywordtype">integer</span>,            <span class="keywordtype">intent(in)</span>    :: n1</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(inout)</span> :: h1</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(inout)</span> :: x1</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;  <span class="keywordtype">integer</span>        :: k   <span class="comment">! loop index</span></div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;  <span class="keywordtype">real</span>           :: t   <span class="comment">! current interface target density</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;  <span class="comment">! Make sure boundary coordinates of new grid coincide with boundary</span></div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;  <span class="comment">! coordinates of previous grid</span></div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;  x1(1) = x0(1)</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  x1(n1+1) = x0(n0+1)</div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;  <span class="comment">! Find coordinates for interior target values</span></div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;  <span class="keywordflow">do</span> k = 2,n1</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;    t = target_values(k)</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;    x1(k) = get_polynomial_coordinate( n0, h0, x0, ppoly0_e, ppoly0_coefficients, t, degree )</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;    h1(k-1) = x1(k) - x1(k-1)</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;  h1(n1) = x1(n1+1) - x1(n1)</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a12dff5ec4c479e77db1813a8d53db7c2_cgraph.svg" width="374" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a12dff5ec4c479e77db1813a8d53db7c2_icgraph.svg" width="598" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a392230123ef4347e6fe6c0b847be60bc"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::old_inflate_layers_1d </td>
          <td>(</td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>minThickness</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>N</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02298">2298</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02256">inflate_vanished_layers_old()</a>.</p>
<div class="fragment"><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;  <span class="comment">! Argument</span></div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;  <span class="keywordtype">real</span>,                <span class="keywordtype">intent(in)</span> :: minthickness</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;  <span class="keywordtype">integer</span>,             <span class="keywordtype">intent(in)</span> :: n</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;  <span class="keywordtype">real</span>,                <span class="keywordtype">intent(inout)</span> :: h(:)</div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;  <span class="comment">! Local variable</span></div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;  <span class="keywordtype">integer</span>   :: k</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;  <span class="keywordtype">integer</span>   :: k_found</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;  <span class="keywordtype">integer</span>   :: count_nonzero_layers</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;  <span class="keywordtype">real</span>      :: delta</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;  <span class="keywordtype">real</span>      :: correction</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;  <span class="keywordtype">real</span>      :: maxthickness</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;  <span class="comment">! Count number of nonzero layers</span></div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;  count_nonzero_layers = 0</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;  <span class="keywordflow">do</span> k = 1,n</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;    <span class="keywordflow">if</span> ( h(k) &gt; minthickness ) <span class="keywordflow">then</span></div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;      count_nonzero_layers = count_nonzero_layers + 1</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;  <span class="comment">! If all layer thicknesses are greater than the threshold, exit routine</span></div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;  <span class="keywordflow">if</span> ( count_nonzero_layers == n ) <span class="keywordflow">return</span></div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;  <span class="comment">! If all thicknesses are zero, inflate them all and exit</span></div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;  <span class="keywordflow">if</span> ( count_nonzero_layers == 0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;    <span class="keywordflow">do</span> k = 1,n</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;      h(k) = minthickness</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;<span class="keywordflow">    end do</span></div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="keywordflow">  end if</span></div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;  <span class="comment">! Inflate zero layers</span></div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;  correction = 0.0</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;  <span class="keywordflow">do</span> k = 1,n</div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;    <span class="keywordflow">if</span> ( h(k) &lt;= minthickness ) <span class="keywordflow">then</span></div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;      delta = minthickness - h(k)</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;      correction = correction + delta</div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;      h(k) = h(k) + delta</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;  <span class="comment">! Modify thicknesses of nonzero layers to ensure volume conservation</span></div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;  maxthickness = h(1)</div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;  k_found = 1</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;  <span class="keywordflow">do</span> k = 1,n</div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;    <span class="keywordflow">if</span> ( h(k) &gt; maxthickness ) <span class="keywordflow">then</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;      maxthickness = h(k)</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;      k_found = k</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="keywordflow">    end if</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;  h(k_found) = h(k_found) - correction</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a392230123ef4347e6fe6c0b847be60bc_icgraph.svg" width="544" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a1a4ef08eafeb47fe9c96d08d736b16b1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::regridding_main </td>
          <td>(</td>
          <td class="paramtype">type(remapping_cs), intent(in)&#160;</td>
          <td class="paramname"><em>remapCS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(inout)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g), szk_(gv)+1), intent(inout)&#160;</td>
          <td class="paramname"><em>dzInterface</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">remapcs</td><td>Remapping parameters and options</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>Ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h</td><td>Current 3D grid obtained after the last time step</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tv</td><td>Thermodynamical variables (T, S, ...)</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">h_new</td><td>New 3D grid consistent with target coordinate</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">dzinterface</td><td>The change in position of each interface </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00269">269</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01772">build_grid_arbitrary()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">build_grid_hycom1()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01151">build_grid_slight()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00729">build_sigma_grid()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00574">build_zstar_grid()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00339">calc_h_new_by_dz()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00364">check_remapping_grid()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02360">convective_adjustment()</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00072">mom_error_handler::mom_error()</a>, <a class="el" href="../../d2/d3c/regrid__consts_8F90_source.html#l00017">regrid_consts::regridding_hycom1</a>, and <a class="el" href="../../d2/d3c/regrid__consts_8F90_source.html#l00018">regrid_consts::regridding_slight</a>.</p>
<div class="fragment"><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">! This routine takes care of (1) building a new grid and (2) remapping between</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">! the old grid and the new grid. The creation of the new grid can be based</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">! on z coordinates, target interface densities, sigma coordinates or any</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">! arbitrary coordinate system.</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">!   The MOM6 interface positions are always calculated from the bottom up by</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">! accumulating the layer thicknesses starting at z=-G%bathyT.  z increases</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">! upwards (decreasing k-index).</span></div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">!   The new grid is defined by the change in position of those interfaces in z</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">!       dzInterface = zNew - zOld.</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">!   Thus, if the regridding inflates the top layer, hNew(1) &gt; hOld(1), then the</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">! second interface moves downward, zNew(2) &lt; zOld(2), and dzInterface(2) &lt; 0.</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">!       hNew(k) = hOld(k) - dzInterface(k+1) + dzInterface(k)</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">! IMPORTANT NOTE:</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">!   This is the converse of the sign convention used in the remapping code!</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">remapping_cs</a>),                         <span class="keywordtype">intent(in)</span>    :: remapcs<span class="comment"> !&lt; Remapping parameters and options</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),                        <span class="keywordtype">intent(in)</span>    :: cs<span class="comment">     !&lt; Regridding control structure</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">      !&lt; Ocean grid structure</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                    <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">     !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h<span class="comment">      !&lt; Current 3D grid obtained after the last time step</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                      <span class="keywordtype">intent(inout)</span> :: tv<span class="comment">     !&lt; Thermodynamical variables (T, S, ...)</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV))</span>, <span class="keywordtype">intent(inout)</span> :: h_new<span class="comment">  !&lt; New 3D grid consistent with target coordinate</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G), SZK_(GV)+1)</span>, <span class="keywordtype">intent(inout)</span> :: dzinterface<span class="comment"> !&lt; The change in position of each interface</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="keywordtype">real</span> :: trickgnucompiler</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="keywordflow">select case</span> ( cs%regridding_scheme )</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <span class="keywordflow">case</span> ( regridding_zstar )</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="keyword">call </span>build_zstar_grid( cs, g, gv, h, dzinterface )</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keywordflow">case</span> ( regridding_sigma )</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      <span class="keyword">call </span>build_sigma_grid( cs, g, gv, h, dzinterface )</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="keywordflow">case</span> ( regridding_rho )</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;      <span class="keyword">call </span>convective_adjustment(g, gv, h, tv)</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      <span class="keyword">call </span>build_rho_grid( g, gv, h, tv, dzinterface, remapcs, cs )</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">case</span> ( regridding_arbitrary )</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      <span class="keyword">call </span>build_grid_arbitrary( g, gv, h, dzinterface, trickgnucompiler, cs )</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="keywordflow">case</span> ( regridding_hycom1 )</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;      <span class="keyword">call </span>build_grid_hycom1( g, gv, h, tv, dzinterface, remapcs, cs )</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    <span class="keywordflow">case</span> ( regridding_slight )</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;      <span class="keyword">call </span>build_grid_slight( g, gv, h, tv, dzinterface, remapcs, cs )</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      <span class="keyword">call </span>calc_h_new_by_dz(g, gv, h, dzinterface, h_new)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;      <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, regridding_main: &#39;</span>//&amp;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                     <span class="stringliteral">&#39;Unknown regridding scheme selected!&#39;</span>)</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="keywordflow">  end select</span> <span class="comment">! type of grid</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="preprocessor">#ifdef __DO_SAFETY_CHECKS__</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="preprocessor"></span>  <span class="keyword">call </span>check_remapping_grid(g, gv, h, dzinterface,<span class="stringliteral">&#39;in regridding_main&#39;</span>)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="preprocessor"></span></div><div class="ttc" id="structmom__remapping_1_1remapping__cs_html"><div class="ttname"><a href="../../dd/d2b/structmom__remapping_1_1remapping__cs.html">mom_remapping::remapping_cs</a></div><div class="ttdoc">Container for remapping parameters. </div><div class="ttdef"><b>Definition:</b> <a href="../../db/d8b/MOM__remapping_8F90_source.html#l00022">MOM_remapping.F90:22</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a1a4ef08eafeb47fe9c96d08d736b16b1_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ad568490b3c428e17fa5ce90ec95ac681"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::regridding_memory_deallocation </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Deallocate memory for regridding. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02763">2763</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00259">end_regridding()</a>.</p>
<div class="fragment"><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;</div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;  <span class="comment">! Target values</span></div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;  <span class="keyword">deallocate</span>( cs%target_density )</div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;  <span class="keyword">deallocate</span>( cs%coordinateResolution )</div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%max_interface_depths) ) <span class="keyword">deallocate</span>( cs%max_interface_depths )</div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">allocated</span>(cs%max_layer_thickness) ) <span class="keyword">deallocate</span>( cs%max_layer_thickness )</div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ad568490b3c428e17fa5ce90ec95ac681_icgraph.svg" width="338" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a580e775df53e4bb61f118fcab44a3f92"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::regridding_set_ppolys </td>
          <td>(</td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>densities</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>n0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>h0</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>ppoly0_E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>ppoly0_S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(:,:), intent(inout)&#160;</td>
          <td class="paramname"><em>ppoly0_coefficients</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(inout)&#160;</td>
          <td class="paramname"><em>degree</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Given the set of target values and cell densities, this routine builds an interpolated profile for the densities within each grid cell. It may happen that, given a high-order interpolator, the number of available layers is insufficient (e.g., there are two available layers for a third-order PPM ih4 scheme). In these cases, we resort to the simplest continuous linear scheme (P1M h2). </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">densities</td><td>Actual cell densities</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">n0</td><td>Number of cells on source grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h0</td><td>cell widths on source grid</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ppoly0_e</td><td>Edge value of polynomial</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ppoly0_s</td><td>Edge slope of polynomial</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">ppoly0_coefficients</td><td>Coefficients of polynomial</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">degree</td><td>The degree of the polynomials</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Parameters used for regridding </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">1879</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">degree_1</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">degree_2</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">degree_3</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">degree_4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00185">interpolation_p1m_h2</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00186">interpolation_p1m_h4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00187">interpolation_p1m_ih4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00191">interpolation_p3m_ih4ih3</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00192">interpolation_p3m_ih6ih5</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00188">interpolation_plm</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00189">interpolation_ppm_h4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00190">interpolation_ppm_ih4</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00193">interpolation_pqm_ih4ih3</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00194">interpolation_pqm_ih6ih5</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01045">build_grid_hycom1()</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01484">rho_interfaces_col()</a>.</p>
<div class="fragment"><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>,  <span class="keywordtype">intent(in)</span>    :: densities<span class="comment"> !&lt; Actual cell densities</span></div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;  <span class="keywordtype">integer</span>,             <span class="keywordtype">intent(in)</span>    :: n0<span class="comment"> !&lt; Number of cells on source grid</span></div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>,  <span class="keywordtype">intent(in)</span>    :: h0<span class="comment"> !&lt; cell widths on source grid</span></div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,<span class="keywordtype">intent(inout)</span> :: ppoly0_e<span class="comment">            !&lt; Edge value of polynomial</span></div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,<span class="keywordtype">intent(inout)</span> :: ppoly0_s<span class="comment">            !&lt; Edge slope of polynomial</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:,:)</span>,<span class="keywordtype">intent(inout)</span> :: ppoly0_coefficients<span class="comment"> !&lt; Coefficients of polynomial</span></div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;  <span class="keywordtype">integer</span>,             <span class="keywordtype">intent(inout)</span> :: degree<span class="comment">  !&lt; The degree of the polynomials</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(in)</span>    :: cs<span class="comment"> !&lt; Parameters used for regridding</span></div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;  <span class="comment">! Reset piecewise polynomials</span></div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;  ppoly0_e(:,:) = 0.0</div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;  ppoly0_s(:,:) = 0.0</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;  ppoly0_coefficients(:,:) = 0.0</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;</div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;  <span class="comment">! Compute the interpolated profile of the density field and build grid</span></div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;  <span class="keywordflow">select case</span> ( cs%interpolation_scheme )</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;    <span class="keywordflow">case</span> ( interpolation_p1m_h2 )</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;      degree = degree_1</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;      <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;      <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;      <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    <span class="keywordflow">case</span> ( interpolation_p1m_h4 )</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;      degree = degree_1</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;      <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;      <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;        <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="keywordflow">case</span> ( interpolation_p1m_ih4 )</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;      degree = degree_1</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;      <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;      <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="keywordflow">case</span> ( interpolation_plm )</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;      degree = degree_1</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;      <span class="keyword">call </span>plm_reconstruction( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;      <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;        <span class="keyword">call </span>plm_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;    <span class="keywordflow">case</span> ( interpolation_ppm_h4 )</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;        degree = degree_2</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        <span class="keyword">call </span>ppm_reconstruction( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;          <span class="keyword">call </span>ppm_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;        degree = degree_1</div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;</div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;    <span class="keywordflow">case</span> ( interpolation_ppm_ih4 )</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;        degree = degree_2</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;        <span class="keyword">call </span>ppm_reconstruction( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;          <span class="keyword">call </span>ppm_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;        degree = degree_1</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <span class="keywordflow">case</span> ( interpolation_p3m_ih4ih3 )</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;        degree = degree_3</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;        <span class="keyword">call </span>edge_slopes_implicit_h3( n0, h0, densities, ppoly0_s )</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;        <span class="keyword">call </span>p3m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;          <span class="keyword">call </span>p3m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        degree = degree_1</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;    <span class="keywordflow">case</span> ( interpolation_p3m_ih6ih5 )</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 6 ) <span class="keywordflow">then</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;        degree = degree_3</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h6( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;        <span class="keyword">call </span>edge_slopes_implicit_h5( n0, h0, densities, ppoly0_s )</div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;        <span class="keyword">call </span>p3m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;          <span class="keyword">call </span>p3m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;        degree = degree_1</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;    <span class="keywordflow">case</span> ( interpolation_pqm_ih4ih3 )</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 4 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;        degree = degree_4</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h4( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;        <span class="keyword">call </span>edge_slopes_implicit_h3( n0, h0, densities, ppoly0_s )</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;        <span class="keyword">call </span>pqm_reconstruction( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;          <span class="keyword">call </span>pqm_boundary_extrapolation_v1( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;        degree = degree_1</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    <span class="keywordflow">case</span> ( interpolation_pqm_ih6ih5 )</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;      <span class="keywordflow">if</span> ( n0 &gt;= 6 ) <span class="keywordflow">then</span></div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;        degree = degree_4</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;        <span class="keyword">call </span>edge_values_implicit_h6( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;        <span class="keyword">call </span>edge_slopes_implicit_h5( n0, h0, densities, ppoly0_s )</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;        <span class="keyword">call </span>pqm_reconstruction( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;          <span class="keyword">call </span>pqm_boundary_extrapolation_v1( n0, h0, densities, ppoly0_e, ppoly0_s, ppoly0_coefficients )</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;        degree = degree_1</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;        <span class="keyword">call </span>edge_values_explicit_h2( n0, h0, densities, ppoly0_e )</div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;        <span class="keyword">call </span>p1m_interpolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;        <span class="keywordflow">if</span> ( cs%boundary_extrapolation) <span class="keywordflow">then</span></div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;          <span class="keyword">call </span>p1m_boundary_extrapolation( n0, h0, densities, ppoly0_e, ppoly0_coefficients )</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;<span class="keywordflow">        end if</span></div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;<span class="keywordflow">      end if</span></div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="keywordflow">  end select</span></div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_a580e775df53e4bb61f118fcab44a3f92_icgraph.svg" width="100%" height="432"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="aacf680ddf88e9c41a340dd426272906d"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_regridding::rho_interfaces_col </td>
          <td>(</td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>rho_col</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz), intent(in)&#160;</td>
          <td class="paramname"><em>h_col</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>z_col</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(in)&#160;</td>
          <td class="paramname"><em>rho_tgt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(nz+1), intent(inout)&#160;</td>
          <td class="paramname"><em>z_col_new</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(in)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, dimension(nz+1), intent(inout)&#160;</td>
          <td class="paramname"><em>reliable</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>debug</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Finds the new interface locations in a column of water that match the prescribed target densities. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">nz</td><td>Number of layers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_col</td><td>Initial layer reference densities.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h_col</td><td>Initial layer thicknesses.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">z_col</td><td>Initial interface heights.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_tgt</td><td>Interface target densities.</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">z_col_new</td><td>New interface heights.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">reliable</td><td>If true, the interface positions are well defined from a stable region.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">debug</td><td>If present and true, do debugging checks. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01484">1484</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>References <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00206">nr_iterations</a>, <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00208">nr_tolerance</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01151">build_grid_slight()</a>.</p>
<div class="fragment"><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="keywordtype">integer</span>,               <span class="keywordtype">intent(in)</span>    :: nz<span class="comment">      !&lt; Number of layers</span></div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: rho_col<span class="comment"> !&lt; Initial layer reference densities.</span></div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz)</span>,   <span class="keywordtype">intent(in)</span>    :: h_col<span class="comment">   !&lt; Initial layer thicknesses.</span></div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: z_col<span class="comment">   !&lt; Initial interface heights.</span></div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(in)</span>    :: rho_tgt<span class="comment"> !&lt; Interface target densities.</span></div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(inout)</span> :: z_col_new<span class="comment"> !&lt; New interface heights.</span></div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),   <span class="keywordtype">intent(in)</span>    :: cs<span class="comment">      !&lt; Regridding control structure</span></div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(nz+1)</span>, <span class="keywordtype">intent(inout)</span> :: reliable<span class="comment"> !&lt; If true, the interface positions</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">                                                  !! are well defined from a stable region.</span></div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>,     <span class="keywordtype">intent(in)</span> :: debug<span class="comment">      !&lt; If present and true, do debugging checks.</span></div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span> :: ru_max_int <span class="comment">! The maximum and minimum densities in</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz+1)</span> :: ru_min_int <span class="comment">! an unstable region around an interface.</span></div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz)</span>   :: ru_max_lay <span class="comment">! The maximum and minimum densities in</span></div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz)</span>   :: ru_min_lay <span class="comment">! an unstable region containing a layer.</span></div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz,2)</span> :: ppoly_i_e <span class="comment">! Edge value of polynomial</span></div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz,2)</span> :: ppoly_i_s <span class="comment">! Edge slope of polynomial</span></div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(nz,CS%degree_i+1)</span> :: ppoly_i_coefficients <span class="comment">! Coefficients of polynomial</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(nz)</span>   :: unstable_lay <span class="comment">! If true, this layer is in an unstable region.</span></div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(nz+1)</span> :: unstable_int <span class="comment">! If true, this interface is in an unstable region.</span></div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  <span class="keywordtype">real</span> :: rt  <span class="comment">! The current target density, in kg m-3.</span></div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <span class="keywordtype">real</span> :: zf  <span class="comment">! The fractional z-position within a layer of the target density.</span></div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keywordtype">real</span> :: rfn</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;  <span class="keywordtype">real</span> :: a(5) <span class="comment">! Coefficients of a local polynomial minus the target density.</span></div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="keywordtype">real</span> :: zf1, zf2, rfn1, rfn2</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;  <span class="keywordtype">real</span> :: drfn_dzf, sgn, delta_zf, zf_prev</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  <span class="keywordtype">real</span> :: tol</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;  <span class="keywordtype">logical</span> :: k_found <span class="comment">! If true, the position has been found.</span></div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  <span class="keywordtype">integer</span> :: k_layer <span class="comment">! The index of the stable layer containing an interface.</span></div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;  <span class="keywordtype">integer</span> :: ppoly_degree</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;  <span class="keywordtype">integer</span> :: k, k1, k1_min, itt, max_itt, m</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  <span class="keywordtype">real</span> :: z_sgn  <span class="comment">! 1 or -1, depending on whether z increases with increasing K.</span></div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  <span class="keywordtype">logical</span> :: debugging</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;  debugging = .false. ; <span class="keywordflow">if</span> (<span class="keyword">present</span>(debug)) debugging = debug</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  max_itt = nr_iterations</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  tol = nr_tolerance</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;  z_sgn = 1.0 ; <span class="keywordflow">if</span> ( z_col(1) &gt; z_col(nz+1) ) z_sgn = -1.0</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  <span class="keywordflow">if</span> (debugging) <span class="keywordflow">then</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;    <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;      <span class="keywordflow">if</span> (abs((z_col(k+1) - z_col(k)) - z_sgn*h_col(k)) &gt; &amp;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;          1.0e-14*(abs(z_col(k+1)) + abs(z_col(k)) + abs(h_col(k))) ) &amp;</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;rho_interfaces_col: Inconsistent z_col and h_col&quot;</span>)</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;  <span class="keywordflow">if</span> ( z_col(1) == z_col(nz+1) ) <span class="keywordflow">then</span></div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    <span class="comment">! This is a massless column!</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="keywordflow">do</span> k=1,nz+1 ; z_col_new(k) = z_col(1) ; reliable(k) = .true. ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  <span class="comment">! This sets up the piecewise polynomials based on the rho_col profile.</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;  <span class="keyword">call </span>regridding_set_ppolys(rho_col, cs, nz, h_col, ppoly_i_e, ppoly_i_s, &amp;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;                             ppoly_i_coefficients, ppoly_degree)</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;  <span class="comment">! Determine the density ranges of unstably stratified segments.</span></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;  <span class="comment">! Interfaces that start out in an unstably stratified segment can</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;  <span class="comment">! only escape if they are outside of the bounds of that segment, and no</span></div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;  <span class="comment">! interfaces are ever mapped into an unstable segment.</span></div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  unstable_int(1) = .false.</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  ru_max_int(1) = ppoly_i_e(1,1)</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;  unstable_lay(1) = (ppoly_i_e(1,1) &gt; ppoly_i_e(1,2))</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  ru_max_lay(1) = max(ppoly_i_e(1,1), ppoly_i_e(1,2))</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;  <span class="keywordflow">do</span> k=2,nz</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;    unstable_int(k) = (ppoly_i_e(k-1,2) &gt; ppoly_i_e(k,1))</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    ru_max_int(k) = max(ppoly_i_e(k-1,2), ppoly_i_e(k,1))</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    ru_min_int(k) = min(ppoly_i_e(k-1,2), ppoly_i_e(k,1))</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    <span class="keywordflow">if</span> (unstable_int(k) .and. unstable_lay(k-1)) &amp;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;      ru_max_int(k) = max(ru_max_lay(k-1), ru_max_int(k))</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    unstable_lay(k) = (ppoly_i_e(k,1) &gt; ppoly_i_e(k,2))</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;    ru_max_lay(k) = max(ppoly_i_e(k,1), ppoly_i_e(k,2))</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;    ru_min_lay(k) = min(ppoly_i_e(k,1), ppoly_i_e(k,2))</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="keywordflow">if</span> (unstable_lay(k) .and. unstable_int(k)) &amp;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;      ru_max_lay(k) = max(ru_max_int(k), ru_max_lay(k))</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;  unstable_int(nz+1) = .false.</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;  ru_min_int(nz+1) = ppoly_i_e(nz,2)</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;  <span class="keywordflow">do</span> k=nz,1,-1</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    <span class="keywordflow">if</span> (unstable_lay(k) .and. unstable_int(k+1)) &amp;</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      ru_min_lay(k) = min(ru_min_int(k+1), ru_min_lay(k))</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;    <span class="keywordflow">if</span> (unstable_int(k) .and. unstable_lay(k)) &amp;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;      ru_min_int(k) = min(ru_min_lay(k), ru_min_int(k))</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  z_col_new(1) = z_col(1) ; reliable(1) = .true.</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  k1_min = 1</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;  <span class="keywordflow">do</span> k=2,nz <span class="comment">! Find the locations of the various target densities for the interfaces.</span></div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    rt = rho_tgt(k)</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    k_layer = -1</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    k_found = .false.</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;    <span class="comment">! Many light layers are found at the top, so start there.</span></div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;    <span class="keywordflow">if</span> (rt &lt;= ppoly_i_e(k1_min,1)) <span class="keywordflow">then</span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;      z_col_new(k) = z_col(k1_min)</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;      k_found = .true.</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;      <span class="comment">! Do not change k1_min for the next layer.</span></div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    <span class="keywordflow">elseif</span> (k1_min == nz+1) <span class="keywordflow">then</span></div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;      z_col_new(k) = z_col(nz+1)</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;      <span class="comment">! Start with the previous location and search outward.</span></div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;      <span class="keywordflow">if</span> (unstable_int(k) .and. (rt &gt;= ru_min_int(k)) .and. (rt &lt;= ru_max_int(k))) <span class="keywordflow">then</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;        <span class="comment">! This interface started in an unstable region and should not move due to remapping.</span></div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;        z_col_new(k) = z_col(k) ; reliable(k) = .false.</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;        k1_min = k ; k_found = .true.</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;      <span class="keywordflow">elseif</span> ((rt &gt;= ppoly_i_e(k-1,2)) .and. (rt &lt;= ppoly_i_e(k,1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        <span class="comment">! This interface is already in the right place and does not move.</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;        z_col_new(k) = z_col(k) ; reliable(k) = .true.</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;        k1_min = k ; k_found = .true.</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;      <span class="keywordflow">elseif</span> (rt &lt; ppoly_i_e(k-1,2)) <span class="keywordflow">then</span>   <span class="comment">! Search upward</span></div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;        <span class="keywordflow">do</span> k1=k-1,k1_min,-1</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;          <span class="comment">! Check whether rt is in layer k.</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;          <span class="keywordflow">if</span> ((rt &lt; ppoly_i_e(k1,2)) .and. (rt &gt; ppoly_i_e(k1,1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            <span class="comment">! rt is in layer k.</span></div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;            k_layer = k1</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;          <span class="keywordflow">elseif</span> (unstable_lay(k1) .and. (rt &gt;= ru_min_lay(k1)) .and. (rt &lt;= ru_max_lay(k1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;            <span class="comment">! rt would be found at unstable layer that it can not penetrate.</span></div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;            <span class="comment">!   It is possible that this can never happen?</span></div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;            z_col_new(k) = z_col(k1+1) ; reliable(k) = .false.</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;          <span class="comment">! Check whether rt is at interface K.</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;          <span class="keywordflow">if</span> (k1 &gt; 1) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> ((rt &lt;= ppoly_i_e(k1,1)) .and. (rt &gt;= ppoly_i_e(k1-1,2))) <span class="keywordflow">then</span></div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;            <span class="comment">! rt is at interface K1</span></div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;            z_col_new(k) = z_col(k1) ; reliable(k) = .true.</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;          <span class="keywordflow">elseif</span> (unstable_int(k1) .and. (rt &gt;= ru_min_int(k1)) .and. (rt &lt;= ru_max_int(k1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;            <span class="comment">! rt would be found at an unstable interface that it can not pass.</span></div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;            <span class="comment">!   It is possible that this can never happen?</span></div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;            z_col_new(k) = z_col(k1) ; reliable(k) = .false.</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;        <span class="keywordflow">if</span> (.not.k_found) <span class="keywordflow">then</span></div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;          <span class="comment">! This should not happen unless k1_min = 1.</span></div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;          <span class="keywordflow">if</span> (k1_min &lt; 2) <span class="keywordflow">then</span></div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;            z_col_new(k) = z_col(k1_min)</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;            z_col_new(k) = z_col(k1_min)</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;      <span class="keywordflow">else</span>  <span class="comment">! Search downward</span></div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        <span class="keywordflow">do</span> k1=k,nz</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;          <span class="keywordflow">if</span> ((rt &lt; ppoly_i_e(k1,2)) .and. (rt &gt; ppoly_i_e(k1,1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;            <span class="comment">! rt is in layer k.</span></div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;            k_layer = k1</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;          <span class="keywordflow">elseif</span> (unstable_lay(k1) .and. (rt &gt;= ru_min_lay(k1)) .and. (rt &lt;= ru_max_lay(k1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;            <span class="comment">! rt would be found at unstable layer that it can not penetrate.</span></div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;            <span class="comment">!   It is possible that this can never happen?</span></div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            z_col_new(k) = z_col(k1)</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;            reliable(k) = .false.</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;            k1_min = k1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;          <span class="keywordflow">if</span> (k1 &lt; nz) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> ((rt &lt;= ppoly_i_e(k1+1,1)) .and. (rt &gt;= ppoly_i_e(k1,2))) <span class="keywordflow">then</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;            <span class="comment">! rt is at interface K1+1</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;            z_col_new(k) = z_col(k1+1) ; reliable(k) = .true.</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;            k1_min = k1+1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;          <span class="keywordflow">elseif</span> (unstable_int(k1+1) .and. (rt &gt;= ru_min_int(k1+1)) .and. (rt &lt;= ru_max_int(k1+1))) <span class="keywordflow">then</span></div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;            <span class="comment">! rt would be found at an unstable interface that it can not pass.</span></div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;            <span class="comment">!   It is possible that this can never happen?</span></div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;            z_col_new(k) = z_col(k1+1)</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;            reliable(k) = .false.</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;            k1_min = k1+1 ; k_found = .true. ; <span class="keywordflow">exit</span></div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;<span class="keywordflow">          endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        <span class="keywordflow">if</span> (.not.k_found) <span class="keywordflow">then</span></div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;          z_col_new(k) = z_col(nz+1)</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;          <span class="keywordflow">if</span> (rt &gt;= ppoly_i_e(nz,2)) <span class="keywordflow">then</span></div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;            reliable(k) = .true.</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;            reliable(k) = .false.</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      <span class="keywordflow">if</span> (k_layer &gt; 0) <span class="keywordflow">then</span>  <span class="comment">! The new location is inside of layer k_layer.</span></div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;        <span class="comment">! Note that this is coded assuming that this layer is stably stratified.</span></div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        <span class="keywordflow">if</span> (.not.(ppoly_i_e(k1,2) &gt; ppoly_i_e(k1,1))) <span class="keyword">call </span>mom_error(fatal, &amp;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;          <span class="stringliteral">&quot;build_grid_SLight: Erroneously searching for an interface in an unstratified layer.&quot;</span>) <span class="comment">!### COMMENT OUT LATER?</span></div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        <span class="comment">! Use the false position method to find the location (degree &lt;= 1) or the first guess.</span></div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        zf = (rt - ppoly_i_e(k1,1)) / (ppoly_i_e(k1,2) - ppoly_i_e(k1,1))</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;        <span class="keywordflow">if</span> (ppoly_degree &gt; 1) <span class="keywordflow">then</span> <span class="comment">! Iterate to find the solution.</span></div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;          a(:) = 0.0 ; a(1) = ppoly_i_coefficients(k_layer,1) - rt</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;          <span class="keywordflow">do</span> m=2,ppoly_degree+1 ; a(m) = ppoly_i_coefficients(k_layer,m) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;          <span class="comment">! Bracket the root.</span></div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;          zf1 = 0.0 ; rfn1 = a(1)</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;          zf2 = 1.0 ; rfn2 =  a(1) + (a(2) + (a(3) + (a(4) + a(5))))</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;          <span class="keywordflow">if</span> (rfn1 * rfn2 &gt; 0.0) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;build_grid_SLight: Bad bracketing.&quot;</span>) <span class="comment">!### COMMENT OUT LATER?</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;          <span class="keywordflow">do</span> itt=1,max_itt</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            rfn = a(1) + zf*(a(2) + zf*(a(3) + zf*(a(4) + zf*a(5))))</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            <span class="comment">! Reset one of the ends of the bracket.</span></div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            <span class="keywordflow">if</span> (rfn * rfn1 &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;              zf1 = zf ; rfn1 = rfn</div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;              zf2 = zf ; rfn2 = rfn</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            <span class="keywordflow">if</span> (rfn1 == rfn2) <span class="keywordflow">exit</span></div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;</div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            drfn_dzf = (a(2) + zf*(2.0*a(3) + zf*(3.0*a(4) + zf*4.0*a(5))))</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;            sgn = 1.0 ; <span class="keywordflow">if</span> (drfn_dzf &lt; 0.0) sgn = -1.0</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;            <span class="keywordflow">if</span> ((sgn*(zf - rfn) &gt;= zf1 * abs(drfn_dzf)) .and. &amp;</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;                (sgn*(zf - rfn) &lt;= zf2 * abs(drfn_dzf))) <span class="keywordflow">then</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;              delta_zf = -rfn / drfn_dzf</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;              zf = zf + delta_zf</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;            <span class="keywordflow">else</span> <span class="comment">! Newton&#39;s method goes out of bounds, so use a false position method estimate</span></div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;              zf_prev = zf</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;              zf = ( rfn2 * zf1 - rfn1 * zf2 ) / (rfn2 - rfn1)</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;              delta_zf = zf - zf_prev</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;            <span class="keywordflow">if</span> (abs(delta_zf) &lt; tol) <span class="keywordflow">exit</span></div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;        z_col_new(k) = z_col(k_layer) + zf * z_sgn * h_col(k_layer)</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;        reliable(k) = .true.</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;  z_col_new(nz+1) = z_col(nz+1) ; reliable(nz+1) = .true.</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_aacf680ddf88e9c41a340dd426272906d_cgraph.svg" width="336" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_aacf680ddf88e9c41a340dd426272906d_icgraph.svg" width="540" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="aac547ec199090852d539c7aefc44dfa7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::set_regrid_max_depths </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(cs%nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>max_depths</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>units_to_H</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set maximum interface depths based on a vector of input values. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_depths</td><td>Maximum interface depths, in arbitrary units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">units_to_h</td><td>A conversion factor for max_depths into H units </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02502">2502</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),      <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk+1)</span>, <span class="keywordtype">intent(in)</span>    :: max_depths<span class="comment"> !&lt; Maximum interface depths, in arbitrary units</span></div><div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,           <span class="keywordtype">intent(in)</span>    :: units_to_h<span class="comment"> !&lt; A conversion factor for max_depths into H units</span></div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;  <span class="keywordtype">real</span> :: val_to_h</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">allocated</span>(cs%max_interface_depths)) <span class="keyword">allocate</span>(cs%max_interface_depths(1:cs%nk+1))</div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;</div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;  val_to_h = 1.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>( units_to_h)) val_to_h = units_to_h</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;  <span class="keywordflow">if</span> (max_depths(cs%nk+1) &lt; max_depths(1)) val_to_h = -1.0*val_to_h</div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;</div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;  <span class="comment">! Check for sign reversals in the depths.</span></div><div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;  <span class="keywordflow">if</span> (max_depths(cs%nk+1) &lt; max_depths(1)) <span class="keywordflow">then</span></div><div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;    <span class="keywordflow">do</span> k=1,cs%nk ; <span class="keywordflow">if</span> (max_depths(k+1) &gt; max_depths(k)) &amp;</div><div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;Unordered list of maximum depths sent to set_regrid_max_depths!&quot;</span>)</div><div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;    <span class="keywordflow">do</span> k=1,cs%nk ; <span class="keywordflow">if</span> (max_depths(k+1) &lt; max_depths(k)) &amp;</div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;Unordered list of maximum depths sent to set_regrid_max_depths.&quot;</span>)</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div><div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;  <span class="keywordflow">do</span> k=1,cs%nk+1</div><div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;    cs%max_interface_depths(k) = val_to_h * max_depths(k)</div><div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="ae91ca3f1376b3c72940268b5d9f87bb4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::set_regrid_max_thickness </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(cs%nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>max_h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>units_to_H</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set maximum layer thicknesses based on a vector of input values. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">max_h</td><td>Maximum interface depths, in arbitrary units</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">units_to_h</td><td>A conversion factor for max_h into H units </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02533">2533</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),      <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk+1)</span>, <span class="keywordtype">intent(in)</span>    :: max_h<span class="comment"> !&lt; Maximum interface depths, in arbitrary units</span></div><div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">optional</span>,           <span class="keywordtype">intent(in)</span>    :: units_to_h<span class="comment"> !&lt; A conversion factor for max_h into H units</span></div><div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;  <span class="keywordtype">real</span> :: val_to_h</div><div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;  <span class="keywordtype">integer</span> :: k</div><div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;</div><div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;  <span class="keywordflow">if</span> (.not.<span class="keyword">allocated</span>(cs%max_layer_thickness)) <span class="keyword">allocate</span>(cs%max_layer_thickness(1:cs%nk))</div><div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;</div><div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;  val_to_h = 1.0 ; <span class="keywordflow">if</span> (<span class="keyword">present</span>( units_to_h)) val_to_h = units_to_h</div><div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;</div><div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;  <span class="keywordflow">do</span> k=1,cs%nk</div><div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;    cs%max_layer_thickness(k) = val_to_h * max_h(k)</div><div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="ac384596d1d07e413bbed37c71e0571e0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::set_regrid_params </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>boundary_extrapolation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>min_thickness</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>old_grid_weight</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>depth_of_time_filter_shallow</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>depth_of_time_filter_deep</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>compress_fraction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>dz_min_surface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in), optional&#160;</td>
          <td class="paramname"><em>nz_fixed_surface</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>Rho_ML_avg_depth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>nlay_ML_to_interior</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>fix_haloclines</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>halocline_filt_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>halocline_strat_tol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, intent(in), optional&#160;</td>
          <td class="paramname"><em>integrate_downward_for_e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in), optional&#160;</td>
          <td class="paramname"><em>height_of_rigid_surface</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This subroutine can be used to set many of the parameters for MOM_regridding. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">boundary_extrapolation</td><td>Extrapolate in boundary cells</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">min_thickness</td><td>Minimum thickness allowed when building the new grid (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">old_grid_weight</td><td>Weight given to old coordinate when time-filtering grid</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">depth_of_time_filter_shallow</td><td>Depth to start cubic (H units)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">depth_of_time_filter_deep</td><td>Depth to end cubic (H units)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">compress_fraction</td><td>Fraction of compressibility to add to potential density</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dz_min_surface</td><td>The fixed resolution in the topmost SLight_nkml_min layers (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nz_fixed_surface</td><td>The number of fixed-thickess layers at the top of the model</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_ml_avg_depth</td><td>Averaging depth over which to determine mixed layer potential density (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">nlay_ml_to_interior</td><td>Number of layers to offset the mixed layer density to find resolved stratification (nondim)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">fix_haloclines</td><td>Detect regions with much weaker stratification in the coordinate</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halocline_filt_len</td><td>Length scale over which to filter T &amp; S when looking for spuriously unstable water mass profiles (m)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">halocline_strat_tol</td><td>Value of the stratification ratio that defines a problematic halocline region.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">integrate_downward_for_e</td><td>If true, integrate for interface positions downward from the top.</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">height_of_rigid_surface</td><td>Threshold height for detection of a rigid upper surface. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02648">2648</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../db/da5/MOM__diag__mediator_8F90_source.html#l00830">mom_diag_mediator::diag_update_target_grids()</a>.</p>
<div class="fragment"><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: boundary_extrapolation<span class="comment"> !&lt; Extrapolate in boundary cells</span></div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: min_thickness<span class="comment"> !&lt; Minimum thickness allowed when building the new grid (m)</span></div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: old_grid_weight<span class="comment"> !&lt; Weight given to old coordinate when time-filtering grid</span></div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: depth_of_time_filter_shallow<span class="comment"> !&lt; Depth to start cubic (H units)</span></div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: depth_of_time_filter_deep<span class="comment"> !&lt; Depth to end cubic (H units)</span></div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: compress_fraction<span class="comment"> !&lt; Fraction of compressibility to add to potential density</span></div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: dz_min_surface<span class="comment"> !&lt; The fixed resolution in the topmost SLight_nkml_min layers (m)</span></div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: nz_fixed_surface<span class="comment"> !&lt; The number of fixed-thickess layers at the top of the model</span></div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: rho_ml_avg_depth<span class="comment"> !&lt; Averaging depth over which to determine mixed layer potential density (m)</span></div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: nlay_ml_to_interior<span class="comment"> !&lt; Number of layers to offset the mixed layer density to find resolved stratification (nondim)</span></div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: fix_haloclines<span class="comment"> !&lt; Detect regions with much weaker stratification in the coordinate</span></div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: halocline_filt_len<span class="comment"> !&lt; Length scale over which to filter T &amp; S when looking for spuriously unstable water mass profiles (m)</span></div><div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: halocline_strat_tol<span class="comment"> !&lt; Value of the stratification ratio that defines a problematic halocline region.</span></div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: integrate_downward_for_e<span class="comment"> !&lt; If true, integrate for interface positions downward from the top.</span></div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;  <span class="keywordtype">real</span>,    <span class="keywordtype">optional</span>, <span class="keywordtype">intent(in)</span> :: height_of_rigid_surface<span class="comment"> !&lt; Threshold height for detection of a rigid upper surface.</span></div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(boundary_extrapolation)) cs%boundary_extrapolation = boundary_extrapolation</div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(min_thickness)) cs%min_thickness = min_thickness</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(old_grid_weight)) <span class="keywordflow">then</span></div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;    <span class="keywordflow">if</span> (old_grid_weight&lt;0. .or. old_grid_weight&gt;1.) &amp;</div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;      <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, set_regrid_params: Weight is out side the range 0..1!&#39;</span>)</div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    cs%old_grid_weight = old_grid_weight</div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(depth_of_time_filter_shallow)) cs%depth_of_time_filter_shallow = depth_of_time_filter_shallow</div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(depth_of_time_filter_deep)) cs%depth_of_time_filter_deep = depth_of_time_filter_deep</div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(depth_of_time_filter_shallow) .or. <span class="keyword">present</span>(depth_of_time_filter_deep)) <span class="keywordflow">then</span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;    <span class="keywordflow">if</span> (cs%depth_of_time_filter_deep&lt;cs%depth_of_time_filter_shallow) <span class="keyword">call </span>mom_error(fatal,<span class="stringliteral">&#39;MOM_regridding, &#39;</span>//&amp;</div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;                     <span class="stringliteral">&#39;set_regrid_params: depth_of_time_filter_deep&lt;depth_of_time_filter_shallow!&#39;</span>)</div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(compress_fraction)) cs%compressibility_fraction = compress_fraction</div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(dz_min_surface)) cs%dz_ml_min = dz_min_surface</div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(nz_fixed_surface)) cs%nz_fixed_surface = nz_fixed_surface</div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(rho_ml_avg_depth)) cs%Rho_ML_avg_depth = rho_ml_avg_depth</div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(nlay_ml_to_interior)) cs%nlay_ML_offset = nlay_ml_to_interior</div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(fix_haloclines)) cs%fix_haloclines = fix_haloclines</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halocline_filt_len)) cs%halocline_filter_length = halocline_filt_len</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(halocline_strat_tol)) <span class="keywordflow">then</span></div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;    <span class="keywordflow">if</span> (halocline_strat_tol &gt; 1.0) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;set_regrid_params: &quot;</span>//&amp;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;        <span class="stringliteral">&quot;HALOCLINE_STRAT_TOL must not exceed 1.0.&quot;</span>)</div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;    cs%halocline_strat_tol = halocline_strat_tol</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(integrate_downward_for_e)) cs%integrate_downward_for_e = integrate_downward_for_e</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(height_of_rigid_surface)) cs%height_of_rigid_surface = height_of_rigid_surface</div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d7/d1b/namespacemom__regridding_ac384596d1d07e413bbed37c71e0571e0_icgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<a id="ae7eade38ab8e2adb0797a7191ddebb18"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::set_target_densities </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(cs%nk+1), intent(in)&#160;</td>
          <td class="paramname"><em>rho_int</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set target densities based on vector of interface values. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">rho_int</td><td>Interface densities </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02492">2492</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),      <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(CS%nk+1)</span>, <span class="keywordtype">intent(in)</span>    :: rho_int<span class="comment"> !&lt; Interface densities</span></div><div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;</div><div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;  cs%target_density(:) = rho_int(:)</div><div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;  cs%target_density_set = .true.</div><div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a8d0d0a1095ab370feb260753e1c25ffa"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::set_target_densities_from_gv </td>
          <td>(</td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set target densities based on the old Rlay variable. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>Ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>Regridding control structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02475">2475</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type), <span class="keywordtype">intent(in)</span>    :: gv<span class="comment"> !&lt; Ocean vertical grid structure</span></div><div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;  <span class="keywordtype">type</span>(regridding_cs),     <span class="keywordtype">intent(inout)</span> :: cs<span class="comment"> !&lt; Regridding control structure</span></div><div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;  <span class="keywordtype">integer</span> :: k, nz</div><div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;</div><div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;  nz = cs%nk</div><div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;  cs%target_density(1)    = gv%Rlay(1)+0.5*(gv%Rlay(1)-gv%Rlay(2))</div><div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  cs%target_density(nz+1) = gv%Rlay(nz)+0.5*(gv%Rlay(nz)-gv%Rlay(nz-1))</div><div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;  <span class="keywordflow">do</span> k = 2,nz</div><div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;    cs%target_density(k) = cs%target_density(k-1) + cs%coordinateResolution(k)</div><div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;<span class="keywordflow">  end do</span></div><div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;  cs%target_density_set = .true.</div><div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a4f0b5a0e798c4cf8e70a63ed3bc62c6f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_regridding::setcoordinateresolution </td>
          <td>(</td>
          <td class="paramtype">real, dimension(:), intent(in)&#160;</td>
          <td class="paramname"><em>dz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d9/d41/structmom__regridding_1_1regridding__cs.html">regridding_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02463">2463</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(:)</span>,  <span class="keywordtype">intent(in)</span>    :: dz</div><div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;  <span class="keywordtype">type</span>(regridding_cs), <span class="keywordtype">intent(inout)</span> :: cs</div><div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;</div><div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">size</span>(dz)/=cs%nk) <span class="keyword">call </span>mom_error( fatal, &amp;</div><div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;      <span class="stringliteral">&#39;setCoordinateResolution: inconsistent number of levels&#39;</span> )</div><div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div><div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;  cs%coordinateResolution(:) = dz(:)</div><div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a8b3b0c1555006f196d9bb1baededd9e6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real function, dimension(nk), public mom_regridding::uniformresolution </td>
          <td>(</td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>nk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=*), intent(in)&#160;</td>
          <td class="paramname"><em>coordMode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>maxDepth</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>rhoLight</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>rhoHeavy</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02426">2426</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;<span class="comment">! Calculate a vector of uniform resolution in the units of the coordinate</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;<span class="comment">!------------------------------------------------------------------------------</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;  <span class="comment">! Arguments</span></div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;  <span class="keywordtype">integer</span>,          <span class="keywordtype">intent(in)</span> :: nk</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">intent(in)</span> :: coordmode</div><div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;  <span class="keywordtype">real</span>,             <span class="keywordtype">intent(in)</span> :: maxdepth, rholight, rhoheavy</div><div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;  <span class="keywordtype">real</span>                         :: uniformresolution(nk)</div><div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;</div><div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;  <span class="keywordtype">integer</span> :: scheme</div><div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;</div><div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;  scheme = coordinatemode(coordmode)</div><div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;  <span class="keywordflow">select case</span> ( scheme )</div><div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;</div><div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;    <span class="keywordflow">case</span> ( regridding_zstar, regridding_hycom1, regridding_slight )</div><div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;      uniformresolution(:) = maxdepth / <span class="keywordtype">real</span>(nk)</div><div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;</div><div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;    <span class="keywordflow">case</span> ( regridding_rho )</div><div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;      uniformresolution(:) = (rhoheavy - rholight) / <span class="keywordtype">real</span>(nk)</div><div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;</div><div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;    <span class="keywordflow">case</span> ( regridding_sigma )</div><div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;      uniformresolution(:) = 1. / <span class="keywordtype">real</span>(nk)</div><div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;</div><div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;<span class="keywordflow">    case default</span></div><div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;      <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_regridding, uniformResolution: &quot;</span>//&amp;</div><div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;       <span class="stringliteral">&quot;Unrecognized choice for coordinate mode (&quot;</span>//trim(coordmode)//<span class="stringliteral">&quot;).&quot;</span>)</div><div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;<span class="keywordflow">  end select</span> <span class="comment">! type of grid</span></div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a39adf48fc3f4b7ef0f544875a82d8c45"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::degree_1 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>List of interpolant degrees. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">197</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: degree_1 = 1, degree_2 = 2, degree_3 = 3, degree_4 = 4</div></div><!-- fragment -->
</div>
</div>
<a id="addfbfd13132d03a95234401d57f92588"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::degree_2 = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">197</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

</div>
</div>
<a id="a205badfdb7b08797cfb9f35f7161bafd"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::degree_3 = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">197</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

</div>
</div>
<a id="a7c1281f32ff39edbbfb94238159dc6c8"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::degree_4 = 4</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00197">197</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>

</div>
</div>
<a id="a858621246c78b04149096007e6e40d5b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real, parameter mom_regridding::deviation_tolerance = 1e-10</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Deviation tolerance between succesive grids in regridding iterations. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00202">202</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>    :: deviation_tolerance = 1e-10</div></div><!-- fragment -->
</div>
</div>
<a id="a7eda7ea8fdd3798039f9d6522eccf9c0"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_p1m_h2 = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^2) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00185">185</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_p1m_h2     = 0<span class="comment"> !&lt; O(h^2)</span></div></div><!-- fragment -->
</div>
</div>
<a id="a039c1e7c026255de9a9b3d99c990d36d"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_p1m_h4 = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^2) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00186">186</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_p1m_h4     = 1<span class="comment"> !&lt; O(h^2)</span></div></div><!-- fragment -->
</div>
</div>
<a id="a4e15f9dd8d3efba9829d7744832cfdda"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_p1m_ih4 = 2</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^2) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00187">187</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_p1m_ih4    = 2<span class="comment"> !&lt; O(h^2)</span></div></div><!-- fragment -->
</div>
</div>
<a id="a63511fbcf190d2e7e339c93b2e9719f4"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_p3m_ih4ih3 = 6</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^4) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00191">191</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_p3m_ih4ih3 = 6<span class="comment"> !&lt; O(h^4)</span></div></div><!-- fragment -->
</div>
</div>
<a id="abd33f3410142055d6ee03073d8c6a90e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_p3m_ih6ih5 = 7</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^4) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00192">192</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_p3m_ih6ih5 = 7<span class="comment"> !&lt; O(h^4)</span></div></div><!-- fragment -->
</div>
</div>
<a id="a53b032a6eaf0888d71c53b27e319fd2c"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_plm = 3</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^2) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00188">188</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_plm        = 3<span class="comment"> !&lt; O(h^2)</span></div></div><!-- fragment -->
</div>
</div>
<a id="a189db45b112ccae6ce5d5490c6918ed3"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_ppm_h4 = 4</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^3) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00189">189</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_ppm_h4     = 4<span class="comment"> !&lt; O(h^3)</span></div></div><!-- fragment -->
</div>
</div>
<a id="aaa80921eae24c6441c43d9bb21db4f00"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_ppm_ih4 = 5</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^3) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00190">190</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_ppm_ih4    = 5<span class="comment"> !&lt; O(h^3)</span></div></div><!-- fragment -->
</div>
</div>
<a id="aaa3636bd6128ccf9511d4efccc81e920"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_pqm_ih4ih3 = 8</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^4) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00193">193</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_pqm_ih4ih3 = 8<span class="comment"> !&lt; O(h^4)</span></div></div><!-- fragment -->
</div>
</div>
<a id="aaf9e92418c890836cf597f05dbae52b4"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::interpolation_pqm_ih6ih5 = 9</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>O(h^5) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00194">194</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01879">regridding_set_ppolys()</a>.</p>
<div class="fragment"><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: interpolation_pqm_ih6ih5 = 9<span class="comment"> !&lt; O(h^5)</span></div></div><!-- fragment -->
</div>
</div>
<a id="af80ba52a718b4b7436beec1e3a92f454"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::nb_regridding_iterations = 1</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Maximum number of regridding iterations. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00200">200</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00806">build_rho_grid()</a>.</p>
<div class="fragment"><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: nb_regridding_iterations = 1</div></div><!-- fragment -->
</div>
</div>
<a id="acb96fc79b15d793e517e0300168097ce"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer, parameter mom_regridding::nr_iterations = 8</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Maximum number of Newton-Raphson iterations. Newton-Raphson iterations are used to build the new grid by finding the coordinates associated with target densities and interpolations of degree larger than 1. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00206">206</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02097">get_polynomial_coordinate()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01484">rho_interfaces_col()</a>.</p>
<div class="fragment"><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: nr_iterations = 8</div></div><!-- fragment -->
</div>
</div>
<a id="a78720368751f79b0c7124203784c8d62"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real, parameter mom_regridding::nr_offset = 1e-6</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>When the N-R algorithm produces an estimate that lies outside [0,1], the estimate is set to be equal to the boundary location, 0 or 1, plus or minus an offset, respectively, when the derivative is zero at the boundary. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00212">212</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02097">get_polynomial_coordinate()</a>.</p>
<div class="fragment"><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>    :: nr_offset = 1e-6</div></div><!-- fragment -->
</div>
</div>
<a id="a87fc44e8cb46bda54d63605e01f1465a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">real, parameter mom_regridding::nr_tolerance = 1e-12</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Tolerance for Newton-Raphson iterations (stop when increment falls below this) </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00208">208</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l02097">get_polynomial_coordinate()</a>, and <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l01484">rho_interfaces_col()</a>.</p>
<div class="fragment"><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>    :: nr_tolerance = 1e-12</div></div><!-- fragment -->
</div>
</div>
<a id="aa3774cbe40d09c83979b47d1c65abb9e"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=320), parameter, public mom_regridding::regriddingcoordinatemodedoc = &quot; LAYER - Isopycnal or stacked shallow water layers\n&quot;// &quot; Z* - stetched geopotential z*\n&quot;// &quot; SIGMA - terrain following coordinates\n&quot;// &quot; RHO - continuous isopycnal\n&quot;// &quot; HYCOM1 - HyCOM-like hybrid coordinate\n&quot;// &quot; SLIGHT - stretched coordinates above continuous isopycnal&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Documentation for coordinate options. </p>

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00158">158</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">character(len=320), parameter, public :: regriddingCoordinateModeDoc = &amp;</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                 <span class="stringliteral">&quot; LAYER - Isopycnal or stacked shallow water layers\n&quot;</span>/<span class="comment">/&amp;</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">                 </span><span class="stringliteral">&quot; Z*    - stetched geopotential z*\n&quot;</span>//&amp;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;                 <span class="stringliteral">&quot; SIGMA - terrain following coordinates\n&quot;</span>//&amp;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;                 <span class="stringliteral">&quot; RHO   - continuous isopycnal\n&quot;</span>//&amp;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;                 <span class="stringliteral">&quot; HYCOM1 - HyCOM-like hybrid coordinate\n&quot;</span>//&amp;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;                 <span class="stringliteral">&quot; SLIGHT - stretched coordinates above continuous isopycnal&quot;</span></div></div><!-- fragment -->
</div>
</div>
<a id="ace083ec9749efc2bcb7d3a33b97c0678"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">logical, parameter, public mom_regridding::regriddingdefaultboundaryextrapolation = .false.</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00179">179</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>.</p>
<div class="fragment"><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span>, <span class="keywordtype">public</span> :: regriddingdefaultboundaryextrapolation = .false.</div></div><!-- fragment -->
</div>
</div>
<a id="a4c5f1f52df457e8ee30d68919e1de8e7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=6), parameter, public mom_regridding::regriddingdefaultinterpscheme = &quot;P1M_H2&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00178">178</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">character(len=6), parameter, public :: regriddingDefaultInterpScheme = &quot;P1M_H2&quot;</span></div></div><!-- fragment -->
</div>
</div>
<a id="a219230a6fd36ab9b6ec19109f60fdcee"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">real, parameter, public mom_regridding::regriddingdefaultminthickness = 1.e-3</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00180">180</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00221">initialize_regridding()</a>.</p>
<div class="fragment"><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>, <span class="keywordtype">public</span> :: regriddingdefaultminthickness = 1.e-3</div></div><!-- fragment -->
</div>
</div>
<a id="a027751c5d8c22c800460f8197df1f4c5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../dd/d60/version__variable_8h.html#acda997fe1761de4c6bca0f27dc786964">character</a>(len=338), parameter, public mom_regridding::regriddinginterpschemedoc = &quot; P1M_H2 (2nd-order accurate)\n&quot;// &quot; P1M_H4 (2nd-order accurate)\n&quot;// &quot; P1M_IH4 (2nd-order accurate)\n&quot;// &quot; PLM (2nd-order accurate)\n&quot;// &quot; PPM_H4 (3rd-order accurate)\n&quot;// &quot; PPM_IH4 (3rd-order accurate)\n&quot;// &quot; P3M_IH4IH3 (4th-order accurate)\n&quot;// &quot; P3M_IH6IH5 (4th-order accurate)\n&quot;// &quot; PQM_IH4IH3 (4th-order accurate)\n&quot;// &quot; PQM_IH6IH5 (5th-order accurate)&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html#l00167">167</a> of file <a class="el" href="../../d1/d10/MOM__regridding_8F90_source.html">MOM_regridding.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">character(len=338), parameter, public :: regriddingInterpSchemeDoc = &amp;</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                 <span class="stringliteral">&quot; P1M_H2     (2nd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;                 <span class="stringliteral">&quot; P1M_H4     (2nd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;                 <span class="stringliteral">&quot; P1M_IH4    (2nd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;                 <span class="stringliteral">&quot; PLM        (2nd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;                 <span class="stringliteral">&quot; PPM_H4     (3rd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;                 <span class="stringliteral">&quot; PPM_IH4    (3rd-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;                 <span class="stringliteral">&quot; P3M_IH4IH3 (4th-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;                 <span class="stringliteral">&quot; P3M_IH6IH5 (4th-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;                 <span class="stringliteral">&quot; PQM_IH4IH3 (4th-order accurate)\n&quot;</span>//&amp;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;                 <span class="stringliteral">&quot; PQM_IH6IH5 (5th-order accurate)&quot;</span></div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d7/d1b/namespacemom__regridding.html">mom_regridding</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
