<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_tracer_hor_diff Module Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,'Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('da/db2/namespacemom__tracer__hor__diff.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">mom_tracer_hor_diff Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Main routine for lateral (along surface or neutral) diffusion of tracers.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d50/structmom__tracer__hor__diff_1_1p2d.html">p2d</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../db/d6f/structmom__tracer__hor__diff_1_1p2di.html">p2di</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d7/d4b/structmom__tracer__hor__diff_1_1tracer__hor__diff__cs.html">tracer_hor_diff_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:ae8eba26c164a4e8e4ba1008cda9850e6"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#ae8eba26c164a4e8e4ba1008cda9850e6">tracer_hordiff</a> (h, dt, MEKE, VarMix, G, GV, CS, Reg, tv)</td></tr>
<tr class="memdesc:ae8eba26c164a4e8e4ba1008cda9850e6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Compute along-coordinate diffusion of all tracers using the diffusivity in CSKhTr, or using space-dependent diffusivity. Multiple iterations are used (if necessary) so that there is no limit on the acceptable time increment.  <a href="#ae8eba26c164a4e8e4ba1008cda9850e6">More...</a><br /></td></tr>
<tr class="separator:ae8eba26c164a4e8e4ba1008cda9850e6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3c96ca84172a944f6d8b15e4204228bb"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#a3c96ca84172a944f6d8b15e4204228bb">tracer_epipycnal_ml_diff</a> (h, dt, Tr, ntr, khdt_epi_x, khdt_epi_y, G, GV, CS, tv, num_itts)</td></tr>
<tr class="memdesc:a3c96ca84172a944f6d8b15e4204228bb"><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine does epipycnal diffusion of all tracers between the mixed and buffer layers and the interior, using the diffusivity in CSKhTr. Multiple iterations are used (if necessary) so that there is no limit on the acceptable time increment.  <a href="#a3c96ca84172a944f6d8b15e4204228bb">More...</a><br /></td></tr>
<tr class="separator:a3c96ca84172a944f6d8b15e4204228bb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2fc116afe7913994a8bfc9570efb4b9f"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#a2fc116afe7913994a8bfc9570efb4b9f">tracer_hor_diff_init</a> (Time, G, param_file, diag, CS, CSnd)</td></tr>
<tr class="memdesc:a2fc116afe7913994a8bfc9570efb4b9f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize lateral tracer diffusion module.  <a href="#a2fc116afe7913994a8bfc9570efb4b9f">More...</a><br /></td></tr>
<tr class="separator:a2fc116afe7913994a8bfc9570efb4b9f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a715439f7286842d78d2ce52b7e5371a4"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#a715439f7286842d78d2ce52b7e5371a4">tracer_hor_diff_end</a> (CS)</td></tr>
<tr class="separator:a715439f7286842d78d2ce52b7e5371a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ad2e47d2af24603c7e589ee65ad33901b"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#ad2e47d2af24603c7e589ee65ad33901b">id_clock_diffuse</a></td></tr>
<tr class="separator:ad2e47d2af24603c7e589ee65ad33901b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afb8e3e165b35c4b6e220afe5706cd69a"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#afb8e3e165b35c4b6e220afe5706cd69a">id_clock_epimix</a></td></tr>
<tr class="separator:afb8e3e165b35c4b6e220afe5706cd69a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac92a65798be694ec5a56720c56e38603"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#ac92a65798be694ec5a56720c56e38603">id_clock_pass</a></td></tr>
<tr class="separator:ac92a65798be694ec5a56720c56e38603"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a75364bb3145fbbf8bc8bffeaa4bc10fd"><td class="memItemLeft" align="right" valign="top">integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html#a75364bb3145fbbf8bc8bffeaa4bc10fd">id_clock_sync</a></td></tr>
<tr class="separator:a75364bb3145fbbf8bc8bffeaa4bc10fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Main routine for lateral (along surface or neutral) diffusion of tracers. </p>
<h1><a class="anchor" id="section_intro"></a>
Introduction to the module</h1>
<pre class="fragment">This module contains subroutines that handle horizontal     
</pre><p> diffusion (i.e., isoneutral or along layer) of tracers.</p>
<p>Each of the tracers are subject to Fickian along-coordinate diffusion if Khtr is defined and positive. The tracer diffusion can use a suitable number of iterations to guarantee stability with an arbitrarily large time step.</p>
<h1><a class="anchor" id="section_gridlayout"></a>
MOM grid layout</h1>
<p>A small fragment of the grid is shown below:</p>
<pre class="fragment">    j+1  x ^ x ^ x   

    j+1  &gt; o &gt; o &gt;  

    j    x ^ x ^ x  

    j    &gt; o &gt; o &gt;  

    j-1  x ^ x ^ x

        i-1  i  i+1

           i  i+1                                                    </pre><p>Fields at each point</p><ul>
<li>x = q, CoriolisBu</li>
<li>^ = v, PFv, CAv, vh, diffv, tauy, vbt, vhtr</li>
<li>&gt; = u, PFu, CAu, uh, diffu, taux, ubt, uhtr</li>
<li>o = h, bathyT, eta, T, S, tr</li>
</ul>
<p>The boundaries always run through q grid points (x). </p>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a3c96ca84172a944f6d8b15e4204228bb"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">subroutine mom_tracer_hor_diff::tracer_epipycnal_ml_diff </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_type), dimension(:), intent(inout)&#160;</td>
          <td class="paramname"><em>Tr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>ntr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>khdt_epi_x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>khdt_epi_y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d7/d4b/structmom__tracer__hor__diff_1_1tracer__hor__diff__cs.html">tracer_hor_diff_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer, intent(in)&#160;</td>
          <td class="paramname"><em>num_itts</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This subroutine does epipycnal diffusion of all tracers between the mixed and buffer layers and the interior, using the diffusivity in CSKhTr. Multiple iterations are used (if necessary) so that there is no limit on the acceptable time increment. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>layer thickness (m or kg m-2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time step</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">tr</td><td>tracer array</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ntr</td><td>number of tracers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">khdt_epi_x</td><td>needs a comment</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">khdt_epi_y</td><td>needs a comment</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">cs</td><td>module control structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>thermodynamic structure</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">num_itts</td><td>number of iterations (usually=1) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00462">462</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>References <a class="el" href="../../d0/d57/MOM__domains_8F90_source.html#l00812">mom_domains::do_group_pass()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_pass</a>.</p>

<p>Referenced by <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">tracer_hordiff()</a>.</p>
<div class="fragment"><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                    <span class="keywordtype">intent(inout)</span> :: g<span class="comment">          !&lt; ocean grid structure </span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                  <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">         !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>    :: h<span class="comment">          !&lt; layer thickness (m or kg m-2)</span></div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordtype">real</span>,                                     <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">         !&lt; time step </span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordtype">type</span>(tracer_type),                        <span class="keywordtype">intent(inout)</span> :: tr(:)<span class="comment">      !&lt; tracer array </span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: ntr<span class="comment">        !&lt; number of tracers </span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>,        <span class="keywordtype">intent(in)</span>    :: khdt_epi_x<span class="comment"> !&lt; needs a comment</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>,        <span class="keywordtype">intent(in)</span>    :: khdt_epi_y<span class="comment"> !&lt; needs a comment </span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keywordtype">type</span>(tracer_hor_diff_cs),                 <span class="keywordtype">intent(inout)</span> :: cs<span class="comment">         !&lt; module control structure </span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                    <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">         !&lt; thermodynamic structure </span></div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  <span class="keywordtype">integer</span>,                                  <span class="keywordtype">intent(in)</span>    :: num_itts<span class="comment">   !&lt; number of iterations (usually=1)</span></div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160; </div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    rml_max  <span class="comment">! The maximum coordinate density within the mixed layer, in kg m-3.</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G), max(1,GV%nk_rho_varies))</span> :: &amp;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    rho_coord <span class="comment">! The coordinate density that is used to mix along, in kg m-3.</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  <span class="comment">! The naming mnemnonic is a=above,b=below,L=Left,R=Right,u=u-point,v=v-point.</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  <span class="comment">! These are 1-D arrays of pointers to 2-d arrays to minimize memory usage.</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  <span class="keywordtype">type</span>(p2d), <span class="keywordtype">dimension(SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    deep_wt_lu, deep_wt_ru, &amp;  <span class="comment">! The relative weighting of the deeper of a pair, ND.</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    hp_lu, hp_ru       <span class="comment">! The total thickness on each side for each pair, in m or kg m-2.</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    </div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keywordtype">type</span>(p2d), <span class="keywordtype">dimension(SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    deep_wt_lv, deep_wt_rv, &amp; <span class="comment">! The relative weighting of the deeper of a pair, ND.</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    hp_lv, hp_rv       <span class="comment">! The total thickness on each side for each pair, in m or kg m-2.</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <span class="keywordtype">type</span>(p2di), <span class="keywordtype">dimension(SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    k0b_lu, k0a_lu, &amp;  <span class="comment">! The original k-indices of the layers that participate</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    k0b_ru, k0a_ru     <span class="comment">! in each pair of mixing at u-faces.</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keywordtype">type</span>(p2di), <span class="keywordtype">dimension(SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    k0b_lv, k0a_lv, &amp;  <span class="comment">! The original k-indices of the layers that participate</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    k0b_rv, k0a_rv     <span class="comment">! in each pair of mixing at v-faces.</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G), SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    tr_flux_conv  <span class="comment">! The flux convergence of tracers, in TR m3 or TR kg.</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G), SZK_(G))</span> :: tr_flux_3d, tr_adj_vert_l, tr_adj_vert_r</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160; </div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G), SZK_(G), SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    rho_srt, &amp; <span class="comment">! The density of each layer of the sorted columns, in kg m-3.</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    h_srt      <span class="comment">! The thickness of each layer of the sorted columns, in m or kg m-2.</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G), SZK_(G), SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    k0_srt     <span class="comment">! The original k-index that each layer of the sorted column</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;               <span class="comment">! corresponds to.</span></div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    h_demand_l, &amp; <span class="comment">! The thickness in the left (_L) or right (_R) column that</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    h_demand_r, &amp; <span class="comment">! is demanded to match the thickness in the counterpart, in H.</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    h_used_l, &amp;   <span class="comment">! The summed thickness from the left or right columns that</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    h_used_r, &amp;   <span class="comment">! have actually been used, in m or kg m-2 (H).</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    h_supply_frac_l, &amp;  <span class="comment">! The fraction of the demanded thickness that can</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    h_supply_frac_r     <span class="comment">! actually be supplied from a layer.</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    kbs_lp, &amp;   <span class="comment">! The sorted indicies of the Left and Right columns for</span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    kbs_rp      <span class="comment">! each pairing.</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G), SZJ_(G))</span>  :: &amp;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    num_srt, &amp;   <span class="comment">! The number of layers that are sorted in each column.</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    k_end_srt, &amp; <span class="comment">! The maximum index in each column that might need to be</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;                 <span class="comment">! sorted, based on neighboring values of max_kRho</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    max_krho     <span class="comment">! The index of the layer whose target density is just denser</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                 <span class="comment">! than the densest part of the mixed layer.</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZJ_(G))</span>           :: &amp;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    max_srt      <span class="comment">! The maximum value of num_srt in a k-row.</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZIB_(G), SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    npu          <span class="comment">! The number of epipycnal pairings at each u-point.</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(SZI_(G), SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    npv          <span class="comment">! The number of epipycnal pairings at each v-point.</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="keywordtype">real</span> :: h_exclude    <span class="comment">! A thickness that layers must attain to be considered</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                       <span class="comment">! for inclusion in mixing, in m.</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="keywordtype">real</span> :: idt        <span class="comment">! The inverse of the time step, in s-1.</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keywordtype">real</span> :: i_maxitt   <span class="comment">! The inverse of the maximum number of iterations.</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordtype">real</span> :: rho_pair, rho_a, rho_b  <span class="comment">! Temporary densities, in kg m-3.</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordtype">real</span> :: tr_min_face  <span class="comment">! The minimum and maximum tracer concentrations</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <span class="keywordtype">real</span> :: tr_max_face  <span class="comment">! associated with a pairing, in conc.</span></div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keywordtype">real</span> :: tr_la, tr_lb <span class="comment">! The 4 tracer concentrations that might be</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordtype">real</span> :: tr_ra, tr_rb <span class="comment">! associated with a pairing, in conc.</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  <span class="keywordtype">real</span> :: tr_av_l    <span class="comment">! The average tracer concentrations on the left and right</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  <span class="keywordtype">real</span> :: tr_av_r    <span class="comment">! sides of a pairing, in conc.</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">real</span> :: tr_flux    <span class="comment">! The tracer flux from left to right in a pair, in conc m3.</span></div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordtype">real</span> :: tr_adj_vert  <span class="comment">! A downward vertical adjustment to Tr_flux between the</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;                     <span class="comment">! two cells that make up one side of the pairing, in conc m3.</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  <span class="keywordtype">real</span> :: h_l, h_r   <span class="comment">! Thicknesses to the left and right, in m or kg m-2 (H).</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordtype">real</span> :: wt_a, wt_b <span class="comment">! Fractional weights of layers above and below, ND.</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;  <span class="keywordtype">real</span> :: vol        <span class="comment">! A cell volume or mass, in m3 or kg (H m2).</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    left_set, &amp;  <span class="comment">! If true, the left or right point determines the density of</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    right_set    <span class="comment">! of the trio.  If densities are exactly equal, both are true.</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;  <span class="keywordtype">real</span> :: tmp</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="keywordtype">real</span> :: p_ref_cv(szi_(g))</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordtype">integer</span> :: k_max, k_min, k_test, itmp</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, k2, m, is, ie, js, je, nz, nkmb</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordtype">integer</span> :: isd, ied, jsd, jed, isdb, iedb, k_size</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordtype">integer</span> :: kl, kr, kla, klb, kra, krb, np, itt, ns, max_itt</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;  <span class="keywordtype">integer</span> :: pemax_krho</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  <span class="keywordtype">integer</span> :: isv, iev, jsv, jev <span class="comment">! The valid range of the indices.</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  isd = g%isd ; ied = g%ied ; jsd = g%jsd ; jed = g%jed</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  isdb = g%IsdB ; iedb = g%IedB</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  idt = 1.0/dt</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  nkmb = gv%nk_rho_varies</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  <span class="keywordflow">if</span> (num_itts &lt;= 1) <span class="keywordflow">then</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    max_itt = 1 ; i_maxitt = 1.0</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    max_itt = num_itts ; i_maxitt = 1.0 / (<span class="keywordtype">real</span>(max_itt))</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="keywordflow">do</span> i=is-2,ie+2 ; p_ref_cv(i) = tv%P_Ref ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keyword">call </span>do_group_pass(cs%pass_t, g%Domain)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="comment">! Determine which layers the mixed- and buffer-layers map into...</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(nkmb,is,ie,js,je,tv,p_ref_cv,rho_coord)</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  <span class="keywordflow">do</span> k=1,nkmb </div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="keywordflow">do</span> j=js-2,je+2</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;       <span class="keyword">call </span>calculate_density(tv%T(:,j,k),tv%S(:,j,k), p_ref_cv, &amp;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                           rho_coord(:,j,k), is-2, ie-is+5, tv%eqn_of_state)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="keywordflow">    enddo</span> </div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordflow">do</span> j=js-2,je+2 ; <span class="keywordflow">do</span> i=is-2,ie+2</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    rml_max(i,j) = rho_coord(i,j,1)</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    num_srt(i,j) = 0 ; max_krho(i,j) = 0</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordflow">do</span> k=2,nkmb ; <span class="keywordflow">do</span> j=js-2,je+2 ; <span class="keywordflow">do</span> i=is-2,ie+2</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="keywordflow">if</span> (rml_max(i,j) &lt; rho_coord(i,j,k)) rml_max(i,j) = rho_coord(i,j,k)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="comment">!   Use bracketing and bisection to find the k-level that the densest of the</span></div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="comment">! mixed and buffer layer corresponds to, such that:</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  <span class="comment">!     GV%Rlay(max_kRho-1) &lt; Rml_max &lt;= GV%Rlay(max_kRho)</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,nkmb,G,GV,Rml_max,max_kRho) &amp;</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="comment">!$OMP                          private(k_min,k_max,k_test)</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  <span class="keywordflow">do</span> j=js-2,je+2 ; <span class="keywordflow">do</span> i=is-2,ie+2 ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">if</span> (rml_max(i,j) &gt; gv%Rlay(nz)) <span class="keywordflow">then</span> ; max_krho(i,j) = nz+1</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <span class="keywordflow">elseif</span> (rml_max(i,j) &lt;= gv%Rlay(nkmb+1)) <span class="keywordflow">then</span> ; max_krho(i,j) = nkmb+1</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      k_min = nkmb+2 ; k_max = nz</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      <span class="keywordflow">do</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        k_test = (k_min + k_max) / 2</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;        <span class="keywordflow">if</span> (rml_max(i,j) &lt;= gv%Rlay(k_test-1)) <span class="keywordflow">then</span> ; k_max = k_test-1</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;        <span class="keywordflow">elseif</span> (gv%Rlay(k_test) &lt; rml_max(i,j)) <span class="keywordflow">then</span> ; k_min = k_test+1</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;        <span class="keywordflow">else</span> ; max_krho(i,j) = k_test ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;        <span class="keywordflow">if</span> (k_min == k_max) <span class="keywordflow">then</span> ; max_krho(i,j) = k_max ; <span class="keywordflow">exit</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  pemax_krho = 0</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    k_end_srt(i,j) = max(max_krho(i,j), max_krho(i-1,j), max_krho(i+1,j), &amp;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;                         max_krho(i,j-1), max_krho(i,j+1))</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;    <span class="keywordflow">if</span> (pemax_krho &lt; k_end_srt(i,j)) pemax_krho = k_end_srt(i,j)</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  <span class="keywordflow">if</span> (pemax_krho &gt; nz) pemax_krho = nz <span class="comment">! PEmax_kRho could have been nz+1.</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  h_exclude = 10.0*(gv%Angstrom + gv%H_subroundoff)</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,nkmb,G,GV,h,h_exclude,num_srt,k0_srt, &amp;</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment">!$OMP                               rho_srt,h_srt,PEmax_kRho,k_end_srt,rho_coord,max_srt) &amp;</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment">!$OMP                       private(ns,tmp,itmp)</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1 </div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;    <span class="keywordflow">do</span> k=1,nkmb ; <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      <span class="keywordflow">if</span> (h(i,j,k) &gt; h_exclude) <span class="keywordflow">then</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        num_srt(i,j) = num_srt(i,j) + 1 ; ns = num_srt(i,j)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        k0_srt(i,ns,j) = k</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;        rho_srt(i,ns,j) = rho_coord(i,j,k)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        h_srt(i,ns,j) = h(i,j,k)</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="keywordflow">do</span> k=nkmb+1,pemax_krho ; <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">if</span> (g%mask2dT(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;      <span class="keywordflow">if</span> ((k&lt;=k_end_srt(i,j)) .and. (h(i,j,k) &gt; h_exclude)) <span class="keywordflow">then</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        num_srt(i,j) = num_srt(i,j) + 1 ; ns = num_srt(i,j)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        k0_srt(i,ns,j) = k</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        rho_srt(i,ns,j) = gv%Rlay(k)</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        h_srt(i,ns,j) = h(i,j,k)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="comment">! Sort each column by increasing density.  This should already be close, </span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="comment">! and the size of the arrays are small, so straight insertion is used.</span></div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;   <span class="keywordflow">do</span> j=js-1,je+1; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    <span class="keywordflow">do</span> k=2,num_srt(i,j) ; <span class="keywordflow">if</span> (rho_srt(i,k,j) &lt; rho_srt(i,k-1,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;      <span class="comment">! The last segment needs to be shuffled earlier in the list.</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      <span class="keywordflow">do</span> k2 = k,2,-1 ; <span class="keywordflow">if</span> (rho_srt(i,k2,j) &gt;= rho_srt(i,k2-1,j)) <span class="keywordflow">exit</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        itmp = k0_srt(i,k2-1,j) ; k0_srt(i,k2-1,j) = k0_srt(i,k2,j) ; k0_srt(i,k2,j) = itmp</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        tmp = rho_srt(i,k2-1,j) ; rho_srt(i,k2-1,j) = rho_srt(i,k2,j) ; rho_srt(i,k2,j) = tmp</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        tmp = h_srt(i,k2-1,j) ; h_srt(i,k2-1,j) = h_srt(i,k2,j) ; h_srt(i,k2,j) = tmp</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keywordflow">    endif</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keyword">  end</span>do; enddo</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    max_srt(j) = 0</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1 ; max_srt(j) = max(max_srt(j), num_srt(i,j)) ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    k_size = max(2*max_srt(j),1)</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    <span class="keyword">allocate</span>(deep_wt_lu(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    <span class="keyword">allocate</span>(deep_wt_ru(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    <span class="keyword">allocate</span>(hp_lu(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keyword">allocate</span>(hp_ru(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <span class="keyword">allocate</span>(k0a_lu(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keyword">allocate</span>(k0a_ru(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keyword">allocate</span>(k0b_lu(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    <span class="keyword">allocate</span>(k0b_ru(j)%p(isdb:iedb,k_size))</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,num_srt,rho_srt,k0b_Lu,k0_srt, &amp;</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment">!$OMP                                  k0b_Ru,k0a_Lu,k0a_Ru,deep_wt_Lu,deep_wt_Ru,  &amp;</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="comment">!$OMP                                  h_srt,nkmb,nPu,hP_Lu,hP_Ru)                  &amp;</span></div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="comment">!$OMP                          private(h_demand_L,h_used_L,h_demand_R,h_used_R,     &amp;</span></div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="comment">!$OMP                                  kR,kL,nP,rho_pair,kbs_Lp,kbs_Rp,rho_a,rho_b, &amp;</span></div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;<span class="comment">!$OMP                                  wt_b,left_set,right_set,h_supply_frac_R,     &amp;</span></div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">!$OMP                                  h_supply_frac_L)</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie ; <span class="keywordflow">if</span> (g%mask2dCu(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <span class="comment">! Set up the pairings for fluxes through the zonal faces.</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j)   ; h_demand_l(k) = 0.0 ; h_used_l(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i+1,j) ; h_demand_r(k) = 0.0 ; h_used_r(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    <span class="comment">! First merge the left and right lists into a single, sorted list.</span></div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;    <span class="comment">!   Discard any layers that are lighter than the lightest in the other</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;    <span class="comment">! column.  They can only participate in mixing as the lighter part of a</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    <span class="comment">! pair of points.</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <span class="keywordflow">if</span> (rho_srt(i,1,j) &lt; rho_srt(i+1,1,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;      kr = 1</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;      <span class="keywordflow">do</span> kl=2,num_srt(i,j) ; <span class="keywordflow">if</span> (rho_srt(i,kl,j) &gt;= rho_srt(i+1,1,j)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="keywordflow">elseif</span> (rho_srt(i+1,1,j) &lt; rho_srt(i,1,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;      kl = 1</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;      <span class="keywordflow">do</span> kr=2,num_srt(i+1,j) ; <span class="keywordflow">if</span> (rho_srt(i+1,kr,j) &gt;= rho_srt(i,1,j)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      kl = 1 ; kr = 1</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;    np = 0</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">do</span> <span class="comment">! Loop to accumulate pairs of columns.</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;      <span class="keywordflow">if</span> ((kl &gt; num_srt(i,j)) .or. (kr &gt; num_srt(i+1,j))) <span class="keywordflow">exit</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;      <span class="keywordflow">if</span> (rho_srt(i,kl,j) &gt; rho_srt(i+1,kr,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;      <span class="comment">! The right point is lighter and defines the density for this trio.</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        rho_pair = rho_srt(i+1,kr,j)</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;        k0b_lu(j)%p(i,k) = k0_srt(i,kl,j) ; k0b_ru(j)%p(i,k) = k0_srt(i+1,kr,j)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        k0a_lu(j)%p(i,k) = k0_srt(i,kl-1,j) ; k0a_ru(j)%p(i,k) = k0b_ru(j)%p(i,k)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        rho_a = rho_srt(i,kl-1,j) ; rho_b = rho_srt(i,kl,j)</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        wt_b = 1.0 ; <span class="keywordflow">if</span> (abs(rho_a - rho_b) &gt; abs(rho_pair - rho_a)) &amp;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;          wt_b = (rho_pair - rho_a) / (rho_b - rho_a)</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        deep_wt_lu(j)%p(i,k) = wt_b ; deep_wt_ru(j)%p(i,k) = 1.0</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i+1,kr,j) * wt_b</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        h_demand_l(kl-1) = h_demand_l(kl-1) + 0.5*h_srt(i+1,kr,j) * (1.0-wt_b)</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        kr = kr+1 ; left_set(k) = .false. ; right_set(k) = .true.</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;      <span class="keywordflow">elseif</span> (rho_srt(i,kl,j) &lt; rho_srt(i+1,kr,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;      <span class="comment">! The left point is lighter and defines the density for this trio.</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        rho_pair = rho_srt(i,kl,j)</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        k0b_lu(j)%p(i,k) = k0_srt(i,kl,j) ; k0b_ru(j)%p(i,k) = k0_srt(i+1,kr,j)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        k0a_lu(j)%p(i,k) = k0b_lu(j)%p(i,k) ; k0a_ru(j)%p(i,k) = k0_srt(i+1,kr-1,j)</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        rho_a = rho_srt(i+1,kr-1,j) ; rho_b = rho_srt(i+1,kr,j)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;        wt_b = 1.0 ; <span class="keywordflow">if</span> (abs(rho_a - rho_b) &gt; abs(rho_pair - rho_a)) &amp;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;          wt_b = (rho_pair - rho_a) / (rho_b - rho_a)</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        deep_wt_lu(j)%p(i,k) = 1.0 ; deep_wt_ru(j)%p(i,k) = wt_b</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j) * wt_b</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        h_demand_r(kr-1) = h_demand_r(kr-1) + 0.5*h_srt(i,kl,j) * (1.0-wt_b)</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;        kl = kl+1 ; left_set(k) = .true. ; right_set(k) = .false.</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;      <span class="keywordflow">elseif</span> ((k0_srt(i,kl,j) &lt;= nkmb) .or. (k0_srt(i+1,kr,j) &lt;= nkmb)) <span class="keywordflow">then</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;        <span class="comment">! The densities are exactly equal and one layer is above the interior.</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        k0b_lu(j)%p(i,k) = k0_srt(i,kl,j) ; k0b_ru(j)%p(i,k) = k0_srt(i+1,kr,j)</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        k0a_lu(j)%p(i,k) = k0b_lu(j)%p(i,k) ; k0a_ru(j)%p(i,k) = k0b_ru(j)%p(i,k)</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        deep_wt_lu(j)%p(i,k) = 1.0 ; deep_wt_ru(j)%p(i,k) = 1.0</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i+1,kr,j)</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j)</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        kl = kl+1 ; kr = kr+1 ; left_set(k) = .true. ; right_set(k) = .true.</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;      <span class="keywordflow">else</span> <span class="comment">! The densities are exactly equal and in the interior.</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        <span class="comment">! Mixing in this case has already occurred, so accumulate the thickness</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="comment">! demanded for that mixing and skip onward.</span></div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i+1,kr,j) </div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j)</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        kl = kl+1 ; kr = kr+1</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! Loop to accumulate pairs of columns.</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    npu(i,j) = np <span class="comment">! This is the number of active pairings.</span></div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="comment">! Determine what fraction of the thickness &quot;demand&quot; can be supplied.</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i+1,j)</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;      h_supply_frac_r(k) = 1.0</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      <span class="keywordflow">if</span> (h_demand_r(k) &gt; 0.5*h_srt(i+1,k,j)) &amp;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;        h_supply_frac_r(k) = 0.5*h_srt(i+1,k,j) / h_demand_r(k)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j)</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;      h_supply_frac_l(k) = 1.0</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;      <span class="keywordflow">if</span> (h_demand_l(k) &gt; 0.5*h_srt(i,k,j)) &amp;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        h_supply_frac_l(k) = 0.5*h_srt(i,k,j) / h_demand_l(k)</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    <span class="comment">!  Distribute the &quot;exported&quot; thicknesses proportionately.</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">do</span> k=1,npu(i,j)</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      kl = kbs_lp(k) ; kr = kbs_rp(k)</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      hp_lu(j)%p(i,k) = 0.0 ; hp_ru(j)%p(i,k) = 0.0</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <span class="keywordflow">if</span> (left_set(k)) <span class="keywordflow">then</span> <span class="comment">! Add the contributing thicknesses on the right.</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        <span class="keywordflow">if</span> (deep_wt_ru(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;          hp_ru(j)%p(i,k) = 0.5*h_srt(i,kl,j) * min(h_supply_frac_r(kr), h_supply_frac_r(kr-1))</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;          wt_b = deep_wt_ru(j)%p(i,k)</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          h_used_r(kr-1) = h_used_r(kr-1) + (1.0 - wt_b)*hp_ru(j)%p(i,k)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;          h_used_r(kr) = h_used_r(kr) + wt_b*hp_ru(j)%p(i,k)</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;          hp_ru(j)%p(i,k) = 0.5*h_srt(i,kl,j) * h_supply_frac_r(kr)</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;          h_used_r(kr) = h_used_r(kr) + hp_ru(j)%p(i,k)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;      <span class="keywordflow">if</span> (right_set(k)) <span class="keywordflow">then</span> <span class="comment">! Add the contributing thicknesses on the left.</span></div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="keywordflow">if</span> (deep_wt_lu(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;          hp_lu(j)%p(i,k) = 0.5*h_srt(i+1,kr,j) * min(h_supply_frac_l(kl), h_supply_frac_l(kl-1))</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;          wt_b = deep_wt_lu(j)%p(i,k)</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;          h_used_l(kl-1) = h_used_l(kl-1) + (1.0 - wt_b)*hp_lu(j)%p(i,k)</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;          h_used_l(kl) = h_used_l(kl) + wt_b*hp_lu(j)%p(i,k)</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;          hp_lu(j)%p(i,k) = 0.5*h_srt(i+1,kr,j) * h_supply_frac_l(kl)</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;          h_used_l(kl) = h_used_l(kl) + hp_lu(j)%p(i,k)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="comment">!   The left-over thickness (at least half the layer thickness) is now</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="comment">! added to the thicknesses of the importing columns.</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <span class="keywordflow">do</span> k=1,npu(i,j)</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;      <span class="keywordflow">if</span> (left_set(k)) hp_lu(j)%p(i,k) = hp_lu(j)%p(i,k) + &amp;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                           (h_srt(i,kbs_lp(k),j) - h_used_l(kbs_lp(k)))</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;      <span class="keywordflow">if</span> (right_set(k)) hp_ru(j)%p(i,k) = hp_ru(j)%p(i,k) + &amp;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                            (h_srt(i+1,kbs_rp(k),j) - h_used_r(kbs_rp(k)))</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i- &amp; j- loops over zonal faces.</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;  <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    k_size = max(max_srt(j)+max_srt(j+1),1)</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keyword">allocate</span>(deep_wt_lv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keyword">allocate</span>(deep_wt_rv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    <span class="keyword">allocate</span>(hp_lv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keyword">allocate</span>(hp_rv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keyword">allocate</span>(k0a_lv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keyword">allocate</span>(k0a_rv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keyword">allocate</span>(k0b_lv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    <span class="keyword">allocate</span>(k0b_rv(j)%p(isd:ied,k_size))</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,num_srt,rho_srt,k0b_Lv,k0b_Rv, &amp;</span></div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="comment">!$OMP                                  k0_srt,k0a_Lv,k0a_Rv,deep_wt_Lv,deep_wt_Rv,  &amp;</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">!$OMP                                  h_srt,nkmb,nPv,hP_Lv,hP_Rv)                  &amp;</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">!$OMP                          private(h_demand_L,h_used_L,h_demand_R,h_used_R,     &amp;</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">!$OMP                                  kR,kL,nP,rho_pair,kbs_Lp,kbs_Rp,rho_a,rho_b, &amp;</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;<span class="comment">!$OMP                                  wt_b,left_set,right_set,h_supply_frac_R,     &amp;</span></div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="comment">!$OMP                                  h_supply_frac_L)</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dCv(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="comment">! Set up the pairings for fluxes through the meridional faces.</span></div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j)   ; h_demand_l(k) = 0.0 ; h_used_l(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j+1) ; h_demand_r(k) = 0.0 ; h_used_r(k) = 0.0 ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    <span class="comment">! First merge the left and right lists into a single, sorted list.</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    <span class="comment">!   Discard any layers that are lighter than the lightest in the other</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    <span class="comment">! column.  They can only participate in mixing as the lighter part of a</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="comment">! pair of points.</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="keywordflow">if</span> (rho_srt(i,1,j) &lt; rho_srt(i,1,j+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;      kr = 1</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;      <span class="keywordflow">do</span> kl=2,num_srt(i,j) ; <span class="keywordflow">if</span> (rho_srt(i,kl,j) &gt;= rho_srt(i,1,j+1)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordflow">elseif</span> (rho_srt(i,1,j+1) &lt; rho_srt(i,1,j)) <span class="keywordflow">then</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      kl = 1</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;      <span class="keywordflow">do</span> kr=2,num_srt(i,j+1) ; <span class="keywordflow">if</span> (rho_srt(i,kr,j+1) &gt;= rho_srt(i,1,j)) <span class="keywordflow">exit</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;      kl = 1 ; kr = 1</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    np = 0</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordflow">do</span> <span class="comment">! Loop to accumulate pairs of columns.</span></div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      <span class="keywordflow">if</span> ((kl &gt; num_srt(i,j)) .or. (kr &gt; num_srt(i,j+1))) <span class="keywordflow">exit</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;      <span class="keywordflow">if</span> (rho_srt(i,kl,j) &gt; rho_srt(i,kr,j+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      <span class="comment">! The right point is lighter and defines the density for this trio.</span></div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        rho_pair = rho_srt(i,kr,j+1)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        k0b_lv(j)%p(i,k) = k0_srt(i,kl,j)   ; k0b_rv(j)%p(i,k) = k0_srt(i,kr,j+1)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;        k0a_lv(j)%p(i,k) = k0_srt(i,kl-1,j) ; k0a_rv(j)%p(i,k) = k0b_rv(j)%p(i,k)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        rho_a = rho_srt(i,kl-1,j) ; rho_b = rho_srt(i,kl,j)</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        wt_b = 1.0 ; <span class="keywordflow">if</span> (abs(rho_a - rho_b) &gt; abs(rho_pair - rho_a)) &amp;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;          wt_b = (rho_pair - rho_a) / (rho_b - rho_a)</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        deep_wt_lv(j)%p(i,k) = wt_b ; deep_wt_rv(j)%p(i,k) = 1.0</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i,kr,j+1) * wt_b</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        h_demand_l(kl-1) = h_demand_l(kl-1) + 0.5*h_srt(i,kr,j+1) * (1.0-wt_b)</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        kr = kr+1 ; left_set(k) = .false. ; right_set(k) = .true.</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;      <span class="keywordflow">elseif</span> (rho_srt(i,kl,j) &lt; rho_srt(i,kr,j+1)) <span class="keywordflow">then</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;      <span class="comment">! The left point is lighter and defines the density for this trio.</span></div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        rho_pair = rho_srt(i,kl,j)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        k0b_lv(j)%p(i,k) = k0_srt(i,kl,j) ; k0b_rv(j)%p(i,k) = k0_srt(i,kr,j+1)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        k0a_lv(j)%p(i,k) = k0b_lv(j)%p(i,k) ; k0a_rv(j)%p(i,k) = k0_srt(i,kr-1,j+1)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        rho_a = rho_srt(i,kr-1,j+1) ; rho_b = rho_srt(i,kr,j+1)</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        wt_b = 1.0 ; <span class="keywordflow">if</span> (abs(rho_a - rho_b) &gt; abs(rho_pair - rho_a)) &amp;</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;          wt_b = (rho_pair - rho_a) / (rho_b - rho_a)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        deep_wt_lv(j)%p(i,k) = 1.0 ; deep_wt_rv(j)%p(i,k) = wt_b</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j) * wt_b</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        h_demand_r(kr-1) = h_demand_r(kr-1) + 0.5*h_srt(i,kl,j) * (1.0-wt_b)</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        kl = kl+1 ; left_set(k) = .true. ; right_set(k) = .false.</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;      <span class="keywordflow">elseif</span> ((k0_srt(i,kl,j) &lt;= nkmb) .or. (k0_srt(i,kr,j+1) &lt;= nkmb)) <span class="keywordflow">then</span></div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        <span class="comment">! The densities are exactly equal and one layer is above the interior.</span></div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        np = np+1 ; k = np</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;        k0b_lv(j)%p(i,k) = k0_srt(i,kl,j) ; k0b_rv(j)%p(i,k) = k0_srt(i,kr,j+1)</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;        k0a_lv(j)%p(i,k) = k0b_lv(j)%p(i,k)  ; k0a_rv(j)%p(i,k) = k0b_rv(j)%p(i,k)</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;        kbs_lp(k) = kl ; kbs_rp(k) = kr</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        deep_wt_lv(j)%p(i,k) = 1.0 ; deep_wt_rv(j)%p(i,k) = 1.0</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i,kr,j+1)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j)</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        kl = kl+1 ; kr = kr+1 ; left_set(k) = .true. ; right_set(k) = .true.</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;      <span class="keywordflow">else</span> <span class="comment">! The densities are exactly equal and in the interior.</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;        <span class="comment">! Mixing in this case has already occurred, so accumulate the thickness</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="comment">! demanded for that mixing and skip onward.</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        h_demand_l(kl) = h_demand_l(kl) + 0.5*h_srt(i,kr,j+1) </div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;        h_demand_r(kr) = h_demand_r(kr) + 0.5*h_srt(i,kl,j)</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        kl = kl+1 ; kr = kr+1</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! Loop to accumulate pairs of columns.</span></div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    npv(i,j) = np <span class="comment">! This is the number of active pairings.</span></div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    <span class="comment">! Determine what fraction of the thickness &quot;demand&quot; can be supplied.</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j+1)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;      h_supply_frac_r(k) = 1.0</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;      <span class="keywordflow">if</span> (h_demand_r(k) &gt; 0.5*h_srt(i,k,j+1)) &amp;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        h_supply_frac_r(k) = 0.5*h_srt(i,k,j+1) / h_demand_r(k)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordflow">do</span> k=1,num_srt(i,j)</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;      h_supply_frac_l(k) = 1.0</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;      <span class="keywordflow">if</span> (h_demand_l(k) &gt; 0.5*h_srt(i,k,j)) &amp;</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        h_supply_frac_l(k) = 0.5*h_srt(i,k,j) / h_demand_l(k)</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="comment">!  Distribute the &quot;exported&quot; thicknesses proportionately.</span></div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    <span class="keywordflow">do</span> k=1,npv(i,j)</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;      kl = kbs_lp(k) ; kr = kbs_rp(k)</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;      hp_lv(j)%p(i,k) = 0.0 ; hp_rv(j)%p(i,k) = 0.0</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;      <span class="keywordflow">if</span> (left_set(k)) <span class="keywordflow">then</span> <span class="comment">! Add the contributing thicknesses on the right.</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="keywordflow">if</span> (deep_wt_rv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;          hp_rv(j)%p(i,k) = 0.5*h_srt(i,kl,j) * min(h_supply_frac_r(kr), h_supply_frac_r(kr-1))</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;          wt_b = deep_wt_rv(j)%p(i,k)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;          h_used_r(kr-1) = h_used_r(kr-1) + (1.0 - wt_b) * hp_rv(j)%p(i,k)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;          h_used_r(kr) = h_used_r(kr) + wt_b * hp_rv(j)%p(i,k)</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;          hp_rv(j)%p(i,k) = 0.5*h_srt(i,kl,j) * h_supply_frac_r(kr)</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;          h_used_r(kr) = h_used_r(kr) + hp_rv(j)%p(i,k)</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;      <span class="keywordflow">if</span> (right_set(k)) <span class="keywordflow">then</span> <span class="comment">! Add the contributing thicknesses on the left.</span></div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        <span class="keywordflow">if</span> (deep_wt_lv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;          hp_lv(j)%p(i,k) = 0.5*h_srt(i,kr,j+1) * min(h_supply_frac_l(kl), h_supply_frac_l(kl-1))</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;          wt_b = deep_wt_lv(j)%p(i,k)</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;          h_used_l(kl-1) = h_used_l(kl-1) + (1.0 - wt_b) * hp_lv(j)%p(i,k)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;          h_used_l(kl) = h_used_l(kl) + wt_b * hp_lv(j)%p(i,k)</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;          hp_lv(j)%p(i,k) = 0.5*h_srt(i,kr,j+1) * h_supply_frac_l(kl)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;          h_used_l(kl) = h_used_l(kl) + hp_lv(j)%p(i,k)</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="comment">!   The left-over thickness (at least half the layer thickness) is now</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="comment">! added to the thicknesses of the importing columns.</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="keywordflow">do</span> k=1,npv(i,j)</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;      <span class="keywordflow">if</span> (left_set(k)) hp_lv(j)%p(i,k) = hp_lv(j)%p(i,k) + &amp;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                            (h_srt(i,kbs_lp(k),j) - h_used_l(kbs_lp(k)))</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      <span class="keywordflow">if</span> (right_set(k)) hp_rv(j)%p(i,k) = hp_rv(j)%p(i,k) + &amp;</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                             (h_srt(i,kbs_rp(k),j+1) - h_used_r(kbs_rp(k)))</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i- &amp; j- loops over meridional faces.</span></div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;<span class="comment">! The tracer-specific calculations start here.</span></div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="comment">! Zero out tracer tendencies.</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <span class="keywordflow">do</span> k=1,pemax_krho ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;    tr_flux_conv(i,j,k) = 0.0</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  <span class="keywordflow">do</span> itt=1,max_itt</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordflow">if</span> (itt &gt; 1) <span class="keywordflow">then</span> <span class="comment">! The halos have already been filled if itt==1.</span></div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_t, g%Domain)</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,Tr,nkmb,nPu,m,max_kRho,nz,h,h_exclude, &amp;</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;<span class="comment">!$OMP                                  k0b_Lu,k0b_Ru,deep_wt_Lu,k0a_Lu,deep_wt_Ru,k0a_Ru,   &amp;</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="comment">!$OMP                                  hP_Lu,hP_Ru,I_maxitt,khdt_epi_x,tr_flux_conv,Idt) &amp;</span></div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;<span class="comment">!$OMP                          private(Tr_min_face,Tr_max_face,kLa,kLb,kRa,kRb,Tr_La, &amp;</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;<span class="comment">!$OMP                                     Tr_Lb,Tr_Ra,Tr_Rb,Tr_av_L,wt_b,Tr_av_R,h_L,h_R, &amp;</span></div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="comment">!$OMP                                     Tr_flux,Tr_adj_vert,wt_a,vol)</span></div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie ; <span class="keywordflow">if</span> (g%mask2dCu(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;        <span class="comment">! Determine the fluxes through the zonal faces.</span></div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;        <span class="comment">! Find the acceptable range of tracer concentration around this face.</span></div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        <span class="keywordflow">if</span> (npu(i,j) &gt;= 1) <span class="keywordflow">then</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;          tr_min_face = min(tr(m)%t(i,j,1), tr(m)%t(i+1,j,1))</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;          tr_max_face = max(tr(m)%t(i,j,1), tr(m)%t(i+1,j,1))</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;          <span class="keywordflow">do</span> k=2,nkmb</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;            tr_min_face = min(tr_min_face, tr(m)%t(i,j,k), tr(m)%t(i+1,j,k))</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;            tr_max_face = max(tr_max_face, tr(m)%t(i,j,k), tr(m)%t(i+1,j,k))</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;          <span class="comment">! Include the next two layers denser than the densest buffer layer.</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;          kla = nkmb+1 ; <span class="keywordflow">if</span> (max_krho(i,j) &lt; nz+1) kla = max_krho(i,j)</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;          klb = kla ; <span class="keywordflow">if</span> (max_krho(i,j) &lt; nz) klb = max_krho(i,j)+1</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;          kra = nkmb+1 ; <span class="keywordflow">if</span> (max_krho(i+1,j) &lt; nz+1) kra = max_krho(i+1,j)</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;          krb = kra ; <span class="keywordflow">if</span> (max_krho(i+1,j) &lt; nz) krb = max_krho(i+1,j)+1</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;          tr_la = tr_min_face ; tr_lb = tr_la ; tr_ra = tr_la ; tr_rb = tr_la</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;          <span class="keywordflow">if</span> (h(i,j,kla) &gt; h_exclude) tr_la = tr(m)%t(i,j,kla)</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;          <span class="keywordflow">if</span> (h(i,j,klb) &gt; h_exclude) tr_la = tr(m)%t(i,j,klb)</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;          <span class="keywordflow">if</span> (h(i+1,j,kra) &gt; h_exclude) tr_ra = tr(m)%t(i+1,j,kra)</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          <span class="keywordflow">if</span> (h(i+1,j,krb) &gt; h_exclude) tr_rb = tr(m)%t(i+1,j,krb)</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;          tr_min_face = min(tr_min_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;          tr_max_face = max(tr_max_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;          <span class="comment">! Include all points in diffusive pairings at this face.</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;          <span class="keywordflow">do</span> k=1,npu(i,j)</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;            tr_lb = tr(m)%t(i,j,k0b_lu(j)%p(i,k))</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;            tr_rb = tr(m)%t(i+1,j,k0b_ru(j)%p(i,k))</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;            tr_la = tr_lb ; tr_ra = tr_rb</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;            <span class="keywordflow">if</span> (deep_wt_lu(j)%p(i,k) &lt; 1.0) tr_la = tr(m)%t(i,j,k0a_lu(j)%p(i,k))</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;            <span class="keywordflow">if</span> (deep_wt_ru(j)%p(i,k) &lt; 1.0) tr_ra = tr(m)%t(i+1,j,k0a_ru(j)%p(i,k))</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;            tr_min_face = min(tr_min_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;            tr_max_face = max(tr_max_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        <span class="keywordflow">do</span> k=1,npu(i,j)</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;          klb = k0b_lu(j)%p(i,k) ; tr_lb = tr(m)%t(i,j,klb) ; tr_av_l = tr_lb</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;          <span class="keywordflow">if</span> (deep_wt_lu(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            kla = k0a_lu(j)%p(i,k) ; tr_la = tr(m)%t(i,j,kla)</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            wt_b = deep_wt_lu(j)%p(i,k)</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;            tr_av_l = wt_b*tr_lb + (1.0-wt_b)*tr_la</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;          krb = k0b_ru(j)%p(i,k) ; tr_rb = tr(m)%t(i+1,j,krb) ; tr_av_r = tr_rb</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;          <span class="keywordflow">if</span> (deep_wt_ru(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;            kra = k0a_ru(j)%p(i,k) ; tr_ra = tr(m)%t(i+1,j,kra)</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            wt_b = deep_wt_ru(j)%p(i,k)</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;            tr_av_r = wt_b*tr_rb + (1.0-wt_b)*tr_ra</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;          h_l = hp_lu(j)%p(i,k) ; h_r = hp_ru(j)%p(i,k)</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;          tr_flux = i_maxitt * khdt_epi_x(i,j) * (tr_av_l - tr_av_r) * &amp;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;            ((2.0 * h_l * h_r) / (h_l + h_r))</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                    </div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;          <span class="keywordflow">if</span> (deep_wt_lu(j)%p(i,k) &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            tr_flux_conv(i,j,klb) = tr_flux_conv(i,j,klb) - tr_flux</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;            tr_adj_vert = 0.0</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;            wt_b = deep_wt_lu(j)%p(i,k) ; wt_a = 1.0 - wt_b</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;            vol = hp_lu(j)%p(i,k) * g%areaT(i,j)</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;            <span class="comment">!   Ensure that the tracer flux does not drive the tracer values</span></div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;            <span class="comment">! outside of the range Tr_min_face &lt;= Tr &lt;= Tr_max_face, or if it</span></div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;            <span class="comment">! does that the concentration in both contributing peices exceed</span></div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="comment">! this range equally. With downgradient fluxes and the initial tracer</span></div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            <span class="comment">! concentrations determining the valid range, the latter condition</span></div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;            <span class="comment">! only enters for large values of the effective diffusive CFL number.</span></div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;            <span class="keywordflow">if</span> (tr_flux &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;              <span class="keywordflow">if</span> (tr_la &lt; tr_lb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol*(tr_la-tr_min_face) &lt; tr_flux) &amp;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                tr_adj_vert = -wt_a * min(tr_flux - vol * (tr_la-tr_min_face), &amp;</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                                          (vol*wt_b) * (tr_lb - tr_la))</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_lb-tr_min_face) &lt; tr_flux) &amp;</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                tr_adj_vert = wt_b * min(tr_flux - vol * (tr_lb-tr_min_face), &amp;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                                         (vol*wt_a) * (tr_la - tr_lb))</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            <span class="keywordflow">elseif</span> (tr_flux &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;              <span class="keywordflow">if</span> (tr_la &gt; tr_lb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_max_face-tr_la) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                tr_adj_vert = wt_a * min(-tr_flux - vol * (tr_max_face-tr_la), &amp;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                                         (vol*wt_b) * (tr_la - tr_lb))</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_max_face-tr_lb) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                tr_adj_vert = -wt_b * min(-tr_flux - vol * (tr_max_face-tr_lb), &amp;</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                                          (vol*wt_a)*(tr_lb - tr_la))</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            tr_flux_conv(i,j,kla) = tr_flux_conv(i,j,kla) - (wt_a*tr_flux + tr_adj_vert)</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;            tr_flux_conv(i,j,klb) = tr_flux_conv(i,j,klb) - (wt_b*tr_flux - tr_adj_vert)</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;          <span class="keywordflow">if</span> (deep_wt_ru(j)%p(i,k) &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            tr_flux_conv(i+1,j,krb) = tr_flux_conv(i+1,j,krb) + tr_flux</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            tr_adj_vert = 0.0</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;            wt_b = deep_wt_ru(j)%p(i,k) ; wt_a = 1.0 - wt_b</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;            vol = hp_ru(j)%p(i,k) * g%areaT(i+1,j)</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;            <span class="comment">!   Ensure that the tracer flux does not drive the tracer values</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;            <span class="comment">! outside of the range Tr_min_face &lt;= Tr &lt;= Tr_max_face, or if it</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;            <span class="comment">! does that the concentration in both contributing peices exceed</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            <span class="comment">! this range equally. With downgradient fluxes and the initial tracer</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;            <span class="comment">! concentrations determining the valid range, the latter condition</span></div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;            <span class="comment">! only enters for large values of the effective diffusive CFL number.</span></div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;            <span class="keywordflow">if</span> (tr_flux &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;              <span class="keywordflow">if</span> (tr_ra &lt; tr_rb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_ra-tr_min_face) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                tr_adj_vert = -wt_a * min(-tr_flux - vol * (tr_ra-tr_min_face), &amp;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                                          (vol*wt_b) * (tr_rb - tr_ra))</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_rb-tr_min_face) &lt; (-tr_flux)) &amp;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                tr_adj_vert = wt_b * min(-tr_flux - vol * (tr_rb-tr_min_face), &amp;</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                                         (vol*wt_a) * (tr_ra - tr_rb))</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;            <span class="keywordflow">elseif</span> (tr_flux &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;              <span class="keywordflow">if</span> (tr_ra &gt; tr_rb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_max_face-tr_ra) &lt; tr_flux) &amp;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                tr_adj_vert = wt_a * min(tr_flux - vol * (tr_max_face-tr_ra), &amp;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                                         (vol*wt_b) * (tr_ra - tr_rb))</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_max_face-tr_rb) &lt; tr_flux) &amp;</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;                tr_adj_vert = -wt_b * min(tr_flux - vol * (tr_max_face-tr_rb), &amp;</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;                                          (vol*wt_a)*(tr_rb - tr_ra))</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;            tr_flux_conv(i+1,j,kra) = tr_flux_conv(i+1,j,kra) + &amp;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                                            (wt_a*tr_flux - tr_adj_vert)</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;            tr_flux_conv(i+1,j,krb) = tr_flux_conv(i+1,j,krb) + &amp;</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;                                            (wt_b*tr_flux + tr_adj_vert)</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%df2d_x)) &amp;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;            tr(m)%df2d_x(i,j) = tr(m)%df2d_x(i,j) + tr_flux * idt</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! Loop over pairings at faces.</span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i- &amp; j- loops over zonal faces.</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,Tr,nkmb,nPv,m,max_kRho,nz,h,h_exclude, &amp;</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="comment">!$OMP                                  k0b_Lv,k0b_Rv,deep_wt_Lv,k0a_Lv,deep_wt_Rv,k0a_Rv,   &amp;</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="comment">!$OMP                                  hP_Lv,hP_Rv,I_maxitt,khdt_epi_y,Tr_flux_3d,          &amp;</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="comment">!$OMP                                  Tr_adj_vert_L,Tr_adj_vert_R,Idt)                     &amp;</span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="comment">!$OMP                          private(Tr_min_face,Tr_max_face,kLa,kLb,kRa,kRb,             &amp;</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment">!$OMP                                  Tr_La,Tr_Lb,Tr_Ra,Tr_Rb,Tr_av_L,wt_b,Tr_av_R,        &amp;</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment">!$OMP                                  h_L,h_R,Tr_flux,Tr_adj_vert,wt_a,vol)</span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">if</span> (g%mask2dCv(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;        <span class="comment">! Determine the fluxes through the meridional faces.</span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="comment">! Find the acceptable range of tracer concentration around this face.</span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="keywordflow">if</span> (npv(i,j) &gt;= 1) <span class="keywordflow">then</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;          tr_min_face = min(tr(m)%t(i,j,1), tr(m)%t(i,j+1,1))</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;          tr_max_face = max(tr(m)%t(i,j,1), tr(m)%t(i,j+1,1))</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;          <span class="keywordflow">do</span> k=2,nkmb</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;            tr_min_face = min(tr_min_face, tr(m)%t(i,j,k), tr(m)%t(i,j+1,k))</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;            tr_max_face = max(tr_max_face, tr(m)%t(i,j,k), tr(m)%t(i,j+1,k))</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;          <span class="comment">! Include the next two layers denser than the densest buffer layer.</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;          kla = nkmb+1 ; <span class="keywordflow">if</span> (max_krho(i,j) &lt; nz+1) kla = max_krho(i,j)</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;          klb = kla ; <span class="keywordflow">if</span> (max_krho(i,j) &lt; nz) klb = max_krho(i,j)+1</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;          kra = nkmb+1 ; <span class="keywordflow">if</span> (max_krho(i,j+1) &lt; nz+1) kra = max_krho(i,j+1)</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;          krb = kra ; <span class="keywordflow">if</span> (max_krho(i,j+1) &lt; nz) krb = max_krho(i,j+1)+1</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;          tr_la = tr_min_face ; tr_lb = tr_la ; tr_ra = tr_la ; tr_rb = tr_la</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;          <span class="keywordflow">if</span> (h(i,j,kla) &gt; h_exclude) tr_la = tr(m)%t(i,j,kla)</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;          <span class="keywordflow">if</span> (h(i,j,klb) &gt; h_exclude) tr_la = tr(m)%t(i,j,klb)</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;          <span class="keywordflow">if</span> (h(i,j+1,kra) &gt; h_exclude) tr_ra = tr(m)%t(i,j+1,kra)</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;          <span class="keywordflow">if</span> (h(i,j+1,krb) &gt; h_exclude) tr_rb = tr(m)%t(i,j+1,krb)</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;          tr_min_face = min(tr_min_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;          tr_max_face = max(tr_max_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;          <span class="comment">! Include all points in diffusive pairings at this face.</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;          <span class="keywordflow">do</span> k=1,npv(i,j)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;            tr_lb = tr(m)%t(i,j,k0b_lv(j)%p(i,k)) ; tr_rb = tr(m)%t(i,j+1,k0b_rv(j)%p(i,k))</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            tr_la = tr_lb ; tr_ra = tr_rb</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;            <span class="keywordflow">if</span> (deep_wt_lv(j)%p(i,k) &lt; 1.0) tr_la = tr(m)%t(i,j,k0a_lv(j)%p(i,k))</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;            <span class="keywordflow">if</span> (deep_wt_rv(j)%p(i,k) &lt; 1.0) tr_ra = tr(m)%t(i,j+1,k0a_rv(j)%p(i,k))</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;            tr_min_face = min(tr_min_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            tr_max_face = max(tr_max_face, tr_la, tr_lb, tr_ra, tr_rb)</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;        <span class="keywordflow">do</span> k=1,npv(i,j)</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;          klb = k0b_lv(j)%p(i,k) ; tr_lb = tr(m)%t(i,j,klb) ; tr_av_l = tr_lb</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;          <span class="keywordflow">if</span> (deep_wt_lv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;            kla = k0a_lv(j)%p(i,k) ; tr_la = tr(m)%t(i,j,kla)</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;            wt_b = deep_wt_lv(j)%p(i,k)</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;            tr_av_l = wt_b * tr_lb + (1.0-wt_b) * tr_la</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;          krb = k0b_rv(j)%p(i,k) ; tr_rb = tr(m)%t(i,j+1,krb) ; tr_av_r = tr_rb</div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;          <span class="keywordflow">if</span> (deep_wt_rv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;            kra = k0a_rv(j)%p(i,k) ; tr_ra = tr(m)%t(i,j+1,kra)</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;            wt_b = deep_wt_rv(j)%p(i,k)</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;            tr_av_r = wt_b * tr_rb + (1.0-wt_b) * tr_ra</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;          h_l = hp_lv(j)%p(i,k) ; h_r = hp_rv(j)%p(i,k)</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;          tr_flux = i_maxitt * ((2.0 * h_l * h_r) / (h_l + h_r)) * &amp;</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;                    khdt_epi_y(i,j) * (tr_av_l - tr_av_r)</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;          tr_flux_3d(i,j,k) = tr_flux</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;          <span class="keywordflow">if</span> (deep_wt_lv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;            tr_adj_vert = 0.0</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;            wt_b = deep_wt_lv(j)%p(i,k) ; wt_a = 1.0 - wt_b</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;            vol = hp_lv(j)%p(i,k) * g%areaT(i,j)</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;            <span class="comment">!   Ensure that the tracer flux does not drive the tracer values</span></div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;            <span class="comment">! outside of the range Tr_min_face &lt;= Tr &lt;= Tr_max_face.</span></div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            <span class="keywordflow">if</span> (tr_flux &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;              <span class="keywordflow">if</span> (tr_la &lt; tr_lb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_la-tr_min_face) &lt; tr_flux) &amp;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                tr_adj_vert = -wt_a * min(tr_flux - vol * (tr_la-tr_min_face), &amp;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;                                          (vol*wt_b) * (tr_lb - tr_la))</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_lb-tr_min_face) &lt; tr_flux) &amp;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;                tr_adj_vert = wt_b * min(tr_flux - vol * (tr_lb-tr_min_face), &amp;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;                                         (vol*wt_a) * (tr_la - tr_lb))</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;            <span class="keywordflow">elseif</span> (tr_flux &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;              <span class="keywordflow">if</span> (tr_la &gt; tr_lb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_max_face-tr_la) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;                tr_adj_vert = wt_a * min(-tr_flux - vol * (tr_max_face-tr_la), &amp;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;                                         (vol*wt_b) * (tr_la - tr_lb))</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_max_face-tr_lb) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                tr_adj_vert = -wt_b * min(-tr_flux - vol * (tr_max_face-tr_lb), &amp;</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                                          (vol*wt_a)*(tr_lb - tr_la))</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;            tr_adj_vert_l(i,j,k) = tr_adj_vert            </div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;          <span class="keywordflow">if</span> (deep_wt_rv(j)%p(i,k) &lt; 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;            tr_adj_vert = 0.0</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;            wt_b = deep_wt_rv(j)%p(i,k) ; wt_a = 1.0 - wt_b</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;            vol = hp_rv(j)%p(i,k) * g%areaT(i,j+1)</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;            <span class="comment">!   Ensure that the tracer flux does not drive the tracer values</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;            <span class="comment">! outside of the range Tr_min_face &lt;= Tr &lt;= Tr_max_face.</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;            <span class="keywordflow">if</span> (tr_flux &lt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;              <span class="keywordflow">if</span> (tr_ra &lt; tr_rb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_ra-tr_min_face) &lt; -tr_flux) &amp;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;                tr_adj_vert = -wt_a * min(-tr_flux - vol * (tr_ra-tr_min_face), &amp;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;                                          (vol*wt_b) * (tr_rb - tr_ra))</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_rb-tr_min_face) &lt; (-tr_flux)) &amp;</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                tr_adj_vert = wt_b * min(-tr_flux - vol * (tr_rb-tr_min_face), &amp;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;                                         (vol*wt_a) * (tr_ra - tr_rb))</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;            <span class="keywordflow">elseif</span> (tr_flux &gt; 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;              <span class="keywordflow">if</span> (tr_ra &gt; tr_rb) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (vol * (tr_max_face-tr_ra) &lt; tr_flux) &amp;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;                tr_adj_vert = wt_a * min(tr_flux - vol * (tr_max_face-tr_ra), &amp;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;                                         (vol*wt_b) * (tr_ra - tr_rb))</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;              <span class="keywordflow">else</span> ; <span class="keywordflow">if</span> (vol*(tr_max_face-tr_rb) &lt; tr_flux) &amp;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;                tr_adj_vert = -wt_b * min(tr_flux - vol * (tr_max_face-tr_rb), &amp;</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;                                          (vol*wt_a)*(tr_rb - tr_ra))</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;            tr_adj_vert_r(i,j,k) = tr_adj_vert</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(tr(m)%df2d_y)) &amp;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;            tr(m)%df2d_y(i,j) = tr(m)%df2d_y(i,j) + tr_flux * idt</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="keywordflow">        enddo</span> <span class="comment">! Loop over pairings at faces.</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span> <span class="comment">! i- &amp; j- loops over meridional faces.</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,G,nPv,k0b_Lv,k0b_Rv,deep_wt_Lv,  &amp;</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="comment">!$OMP                                  tr_flux_conv,Tr_flux_3d,k0a_Lv,Tr_adj_vert_L,&amp;</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="comment">!$OMP                                  deep_wt_Rv,k0a_Rv,Tr_adj_vert_R) &amp;</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment">!$OMP                          private(kLa,kLb,kRa,kRb,wt_b,wt_a)</span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;      <span class="keywordflow">do</span> i=is,ie ; <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">if</span> (g%mask2dCv(i,j) &gt; 0.5) <span class="keywordflow">then</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        <span class="keywordflow">do</span> k=1,npv(i,j)</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;          klb = k0b_lv(j)%p(i,k); krb = k0b_rv(j)%p(i,k)</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;          <span class="keywordflow">if</span> (deep_wt_lv(j)%p(i,k) &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;            tr_flux_conv(i,j,klb) = tr_flux_conv(i,j,klb) - tr_flux_3d(i,j,k)</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;            kla = k0a_lv(j)%p(i,k)</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;            wt_b = deep_wt_lv(j)%p(i,k) ; wt_a = 1.0 - wt_b </div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;            tr_flux_conv(i,j,kla) = tr_flux_conv(i,j,kla) - (wt_a*tr_flux_3d(i,j,k) + tr_adj_vert_l(i,j,k))</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;            tr_flux_conv(i,j,klb) = tr_flux_conv(i,j,klb) - (wt_b*tr_flux_3d(i,j,k) - tr_adj_vert_l(i,j,k))</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="keywordflow">          endif</span>            </div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;          <span class="keywordflow">if</span> (deep_wt_rv(j)%p(i,k) &gt;= 1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            tr_flux_conv(i,j+1,krb) = tr_flux_conv(i,j+1,krb) + tr_flux_3d(i,j,k)</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;          <span class="keywordflow">else</span>          </div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            kra = k0a_rv(j)%p(i,k) </div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            wt_b = deep_wt_rv(j)%p(i,k) ; wt_a = 1.0 - wt_b</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;            tr_flux_conv(i,j+1,kra) = tr_flux_conv(i,j+1,kra) + &amp;</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                                            (wt_a*tr_flux_3d(i,j,k) - tr_adj_vert_r(i,j,k))</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            tr_flux_conv(i,j+1,krb) = tr_flux_conv(i,j+1,krb) + &amp;</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                                            (wt_b*tr_flux_3d(i,j,k) + tr_adj_vert_r(i,j,k))</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="keywordflow">      endif</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(PEmax_kRho,is,ie,js,je,G,h,Tr,tr_flux_conv,m)</span></div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;      <span class="keywordflow">do</span> k=1,pemax_krho ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;        <span class="keywordflow">if</span> ((g%mask2dT(i,j) &gt; 0.5) .and. (h(i,j,k) &gt; 0.0)) <span class="keywordflow">then</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;          tr(m)%t(i,j,k) = tr(m)%t(i,j,k) + tr_flux_conv(i,j,k) / &amp;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;                                            (h(i,j,k)*g%areaT(i,j))</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;          tr_flux_conv(i,j,k) = 0.0</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! Loop over tracers</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="keywordflow">  enddo</span> <span class="comment">! Loop over iterations</span></div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;    <span class="keyword">deallocate</span>(deep_wt_lu(j)%p) ; <span class="keyword">deallocate</span>(deep_wt_ru(j)%p)</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    <span class="keyword">deallocate</span>(hp_lu(j)%p)  ; <span class="keyword">deallocate</span>(hp_ru(j)%p)</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    <span class="keyword">deallocate</span>(k0a_lu(j)%p) ; <span class="keyword">deallocate</span>(k0a_ru(j)%p)</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;    <span class="keyword">deallocate</span>(k0b_lu(j)%p) ; <span class="keyword">deallocate</span>(k0b_ru(j)%p)</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <span class="keyword">deallocate</span>(deep_wt_lv(j)%p) ; <span class="keyword">deallocate</span>(deep_wt_rv(j)%p)</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="keyword">deallocate</span>(hp_lv(j)%p)  ; <span class="keyword">deallocate</span>(hp_rv(j)%p)</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="keyword">deallocate</span>(k0a_lv(j)%p) ; <span class="keyword">deallocate</span>(k0a_rv(j)%p)</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keyword">deallocate</span>(k0b_lv(j)%p) ; <span class="keyword">deallocate</span>(k0b_rv(j)%p)</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../da/db2/namespacemom__tracer__hor__diff_a3c96ca84172a944f6d8b15e4204228bb_cgraph.svg" width="374" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../da/db2/namespacemom__tracer__hor__diff_a3c96ca84172a944f6d8b15e4204228bb_icgraph.svg" width="324" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe>
</div>
</div>

</div>
</div>
<a id="a715439f7286842d78d2ce52b7e5371a4"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_hor_diff::tracer_hor_diff_end </td>
          <td>(</td>
          <td class="paramtype">type(<a class="el" href="../../d7/d4b/structmom__tracer__hor__diff_1_1tracer__hor__diff__cs.html">tracer_hor_diff_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01405">1405</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;  <span class="keywordtype">type</span>(tracer_hor_diff_cs), <span class="keywordtype">pointer</span> :: cs</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  <span class="keyword">call </span>neutral_diffusion_end(cs%neutral_diffusion_CSp)</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keyword">deallocate</span>(cs)</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a2fc116afe7913994a8bfc9570efb4b9f"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_hor_diff::tracer_hor_diff_init </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in), target&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl), intent(inout), target&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d7/d4b/structmom__tracer__hor__diff_1_1tracer__hor__diff__cs.html">tracer_hor_diff_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(neutral_diffusion_cs), pointer&#160;</td>
          <td class="paramname"><em>CSnd</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize lateral tracer diffusion module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">g</td><td>ocean grid structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">diag</td><td>diagnostic control</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">param_file</td><td>parameter file</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>horz diffusion control structure</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">csnd</td><td>pointer to neutral diffusion CS </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01306">1306</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>References <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_diffuse</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_epimix</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_pass</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_sync</a>.</p>
<div class="fragment"><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">target</span>,    <span class="keywordtype">intent(in)</span>    :: time<span class="comment">       !&lt; current model time </span></div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),      <span class="keywordtype">intent(in)</span>    :: g<span class="comment">          !&lt; ocean grid structure </span></div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl), <span class="keywordtype">target</span>,    <span class="keywordtype">intent(inout)</span> :: diag<span class="comment">       !&lt; diagnostic control </span></div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="keywordtype">type</span>(param_file_type),      <span class="keywordtype">intent(in)</span>    :: param_file<span class="comment"> !&lt; parameter file </span></div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;  <span class="keywordtype">type</span>(tracer_hor_diff_cs),   <span class="keywordtype">pointer</span>       :: cs<span class="comment">         !&lt; horz diffusion control structure </span></div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="../../d6/d3e/structmom__neutral__diffusion_1_1neutral__diffusion__cs.html">neutral_diffusion_cs</a>), <span class="keywordtype">pointer</span>       :: csnd<span class="comment">       !&lt; pointer to neutral diffusion CS </span></div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">! This include declares and sets the variable &quot;version&quot;.</span></div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="preprocessor">#include &quot;version_variable.h&quot;</span></div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">character(len=40)</span>  :: mod = <span class="stringliteral">&quot;MOM_tracer_hor_diff&quot;</span> <span class="comment">! This module&#39;s name.</span></div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;  <span class="keywordtype">character(len=256)</span> :: mesg    <span class="comment">! Message for error messages.</span></div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;tracer_hor_diff_init called with associated control structure.&quot;</span>)</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  cs%diag =&gt; diag</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  cs%show_call_tree = calltree_showquery()</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;  <span class="comment">! Read all relevant parameters and write them to the model log.</span></div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;  <span class="keyword">call </span>log_version(param_file, mod, version, <span class="stringliteral">&quot;&quot;</span>)</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR&quot;</span>, cs%KhTr, &amp;</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                 <span class="stringliteral">&quot;The background along-isopycnal tracer diffusivity.&quot;</span>, &amp;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR_SLOPE_CFF&quot;</span>, cs%KhTr_Slope_Cff, &amp;</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                 <span class="stringliteral">&quot;The scaling coefficient for along-isopycnal tracer \n&quot;</span>//&amp;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;                 <span class="stringliteral">&quot;diffusivity using a shear-based (Visbeck-like) \n&quot;</span>//&amp;</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;                 <span class="stringliteral">&quot;parameterization.  A non-zero value enables this param.&quot;</span>, &amp;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR_MIN&quot;</span>, cs%KhTr_Min, &amp;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;                 <span class="stringliteral">&quot;The minimum along-isopycnal tracer diffusivity.&quot;</span>, &amp;</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR_MAX&quot;</span>, cs%KhTr_Max, &amp;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;                 <span class="stringliteral">&quot;The maximum along-isopycnal tracer diffusivity.&quot;</span>, &amp;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;                 units=<span class="stringliteral">&quot;m2 s-1&quot;</span>, default=0.0)</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR_PASSIVITY_COEFF&quot;</span>, cs%KhTr_passivity_coeff, &amp;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;               <span class="stringliteral">&quot;The coefficient that scales deformation radius over \n&quot;</span>//&amp;</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;               <span class="stringliteral">&quot;grid-spacing in passivity, where passiviity is the ratio \n&quot;</span>//&amp;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;               <span class="stringliteral">&quot;between along isopycnal mxiing of tracers to thickness mixing. \n&quot;</span>//&amp;</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;               <span class="stringliteral">&quot;A non-zero value enables this parameterization.&quot;</span>, &amp;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;               units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.0)</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;KHTR_PASSIVITY_MIN&quot;</span>, cs%KhTr_passivity_min, &amp;</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;               <span class="stringliteral">&quot;The minimum passivity which is the ratio between \n&quot;</span>//&amp;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;               <span class="stringliteral">&quot;along isopycnal mxiing of tracers to thickness mixing. \n&quot;</span>, &amp;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;               units=<span class="stringliteral">&quot;nondim&quot;</span>, default=0.5)</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;DT&quot;</span>, cs%dt, fail_if_missing=.true., &amp;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;          desc=<span class="stringliteral">&quot;The (baroclinic) dynamics time step.&quot;</span>, units=<span class="stringliteral">&quot;s&quot;</span>)</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;DIFFUSE_ML_TO_INTERIOR&quot;</span>, cs%Diffuse_ML_interior, &amp;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;                 <span class="stringliteral">&quot;If true, enable epipycnal mixing between the surface \n&quot;</span>//&amp;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                 <span class="stringliteral">&quot;boundary layer and the interior.&quot;</span>, default=.false.)</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;CHECK_DIFFUSIVE_CFL&quot;</span>, cs%check_diffusive_CFL, &amp;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;                 <span class="stringliteral">&quot;If true, use enough iterations the diffusion to ensure \n&quot;</span>//&amp;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;                 <span class="stringliteral">&quot;that the diffusive equivalent of the CFL limit is not \n&quot;</span>//&amp;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;                 <span class="stringliteral">&quot;violated.  If false, always use 1 iteration.&quot;</span>, default=.false.)</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  cs%ML_KhTR_scale = 1.0</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keywordflow">if</span> (cs%Diffuse_ML_interior) <span class="keywordflow">then</span></div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;ML_KHTR_SCALE&quot;</span>, cs%ML_KhTR_scale, &amp;</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;                 <span class="stringliteral">&quot;With Diffuse_ML_interior, the ratio of the truly \n&quot;</span>//&amp;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;                 <span class="stringliteral">&quot;horizontal diffusivity in the mixed layer to the \n&quot;</span>//&amp;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;                 <span class="stringliteral">&quot;epipycnal diffusivity.  The valid range is 0 to 1.&quot;</span>, &amp;</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;                 units=<span class="stringliteral">&quot;nondim&quot;</span>, default=1.0)</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  cs%use_neutral_diffusion = neutral_diffusion_init(time, g, param_file, diag, cs%neutral_diffusion_CSp)</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  csnd =&gt; cs%neutral_diffusion_CSp </div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  <span class="keywordflow">if</span> (cs%use_neutral_diffusion .and. cs%Diffuse_ML_interior) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_hor_diff: &quot;</span>// &amp;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;       <span class="stringliteral">&quot;USE_NEUTRAL_DIFFUSION and DIFFUSE_ML_TO_INTERIOR are mutually exclusive!&quot;</span>)</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;DEBUG&quot;</span>, cs%debug, default=.false.)</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;  id_clock_diffuse = cpu_clock_id(<span class="stringliteral">&#39;(Ocean diffuse tracer)&#39;</span>,          grain=clock_module)</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  id_clock_epimix  = cpu_clock_id(<span class="stringliteral">&#39;(Ocean epipycnal diffuse tracer)&#39;</span>,grain=clock_module)</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;  id_clock_pass    = cpu_clock_id(<span class="stringliteral">&#39;(Ocean tracer halo updates)&#39;</span>,     grain=clock_routine)</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  id_clock_sync    = cpu_clock_id(<span class="stringliteral">&#39;(Ocean tracer global synch)&#39;</span>,     grain=clock_routine)</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;  cs%id_KhTr_u = -1 </div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  cs%id_KhTr_v = -1 </div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;  cs%id_KhTr_h = -1</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  cs%id_CFL    = -1</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;  cs%id_KhTr_u = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KHTR_u&#39;</span>, diag%axesCu1, time, &amp;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;     <span class="stringliteral">&#39;Epipycnal tracer diffusivity at zonal faces of tracer cell&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  cs%id_KhTr_v = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KHTR_v&#39;</span>, diag%axesCv1, time, &amp;</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;     <span class="stringliteral">&#39;Epipycnal tracer diffusivity at meridional faces of tracer cell&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>)</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  cs%id_KhTr_h = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;KHTR_h&#39;</span>, diag%axesT1, time,&amp;</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;     <span class="stringliteral">&#39;Epipycnal tracer diffusivity at tracer cell center&#39;</span>, <span class="stringliteral">&#39;meter2 second-1&#39;</span>,   &amp;</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;     cmor_field_name=<span class="stringliteral">&#39;diftrelo&#39;</span>, cmor_units=<span class="stringliteral">&#39;m2 sec-1&#39;</span>,                         &amp;</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;     cmor_standard_name= <span class="stringliteral">&#39;ocean_tracer_epineutral_laplacian_diffusivity&#39;</span>,       &amp;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;     cmor_long_name = <span class="stringliteral">&#39;Ocean Tracer Epineutral Laplacian Diffusivity&#39;</span>) </div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  cs%id_CFL = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;CFL_lateral_diff&#39;</span>, diag%axesT1, time,&amp;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;     <span class="stringliteral">&#39;Grid CFL number for lateral/neutral tracer diffusion&#39;</span>, <span class="stringliteral">&#39;dimensionless&#39;</span>) </div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div><div class="ttc" id="structmom__neutral__diffusion_1_1neutral__diffusion__cs_html"><div class="ttname"><a href="../../d6/d3e/structmom__neutral__diffusion_1_1neutral__diffusion__cs.html">mom_neutral_diffusion::neutral_diffusion_cs</a></div><div class="ttdef"><b>Definition:</b> <a href="../../d8/da4/MOM__neutral__diffusion_8F90_source.html#l00030">MOM_neutral_diffusion.F90:30</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae8eba26c164a4e8e4ba1008cda9850e6"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_tracer_hor_diff::tracer_hordiff </td>
          <td>(</td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>dt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(meke_type), pointer&#160;</td>
          <td class="paramname"><em>MEKE</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(varmix_cs), pointer&#160;</td>
          <td class="paramname"><em>VarMix</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d7/d4b/structmom__tracer__hor__diff_1_1tracer__hor__diff__cs.html">tracer_hor_diff_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(tracer_registry_type), intent(inout)&#160;</td>
          <td class="paramname"><em>Reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(thermo_var_ptrs), intent(in)&#160;</td>
          <td class="paramname"><em>tv</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Compute along-coordinate diffusion of all tracers using the diffusivity in CSKhTr, or using space-dependent diffusivity. Multiple iterations are used (if necessary) so that there is no limit on the acceptable time increment. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">g</td><td>Grid type</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">h</td><td>Layer thickness (m or kg m-2)</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dt</td><td>time step (seconds)</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">meke</td><td>MEKE type</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">varmix</td><td>Variable mixing type</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">gv</td><td>ocean vertical grid structure</td></tr>
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>module control structure</td></tr>
    <tr><td class="paramdir">[in,out]</td><td class="paramname">reg</td><td>registered tracers</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">tv</td><td>A structure containing pointers to any available thermodynamic fields, including potential temp and salinity or mixed layer density. Absent fields have NULL ptrs, and these may (probably will) point to some of the same arrays as Tr does. tv is required for epipycnal mixing between mixed layer and the interior. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">86</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>References <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00125">mom_error_handler::calltree_enter()</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00146">mom_error_handler::calltree_leave()</a>, <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00156">mom_error_handler::calltree_waypoint()</a>, <a class="el" href="../../d0/d57/MOM__domains_8F90_source.html#l00812">mom_domains::do_group_pass()</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_diffuse</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_epimix</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_pass</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">id_clock_sync</a>, <a class="el" href="../../d9/d8f/MOM__tracer__registry_8F90_source.html#l00426">mom_tracer_registry::mom_tracer_chksum()</a>, <a class="el" href="../../d8/da4/MOM__neutral__diffusion_8F90_source.html#l00315">mom_neutral_diffusion::neutral_diffusion()</a>, <a class="el" href="../../d8/da4/MOM__neutral__diffusion_8F90_source.html#l00255">mom_neutral_diffusion::neutral_diffusion_calc_coeffs()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00462">tracer_epipycnal_ml_diff()</a>.</p>
<div class="fragment"><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                 <span class="keywordtype">intent(inout)</span> :: g<span class="comment">       !&lt; Grid type </span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span> :: h<span class="comment">       !&lt; Layer thickness (m or kg m-2)</span></div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordtype">real</span>,                                  <span class="keywordtype">intent(in)</span>    :: dt<span class="comment">      !&lt; time step (seconds)</span></div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">type</span>(meke_type),                       <span class="keywordtype">pointer</span>       :: meke<span class="comment">    !&lt; MEKE type </span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="keywordtype">type</span>(varmix_cs),                       <span class="keywordtype">pointer</span>       :: varmix<span class="comment">  !&lt; Variable mixing type </span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),               <span class="keywordtype">intent(in)</span>    :: gv<span class="comment">      !&lt; ocean vertical grid structure</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">type</span>(tracer_hor_diff_cs),              <span class="keywordtype">pointer</span>       :: cs<span class="comment">      !&lt; module control structure </span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">type</span>(tracer_registry_type),            <span class="keywordtype">intent(inout)</span> :: reg<span class="comment">     !&lt; registered tracers </span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordtype">type</span>(thermo_var_ptrs),                 <span class="keywordtype">intent(in)</span>    :: tv<span class="comment">      !&lt; A structure containing pointers to any available   </span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">                                                                  !! thermodynamic fields, including potential temp and</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">                                                                  !! salinity or mixed layer density. Absent fields have </span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">                                                                  !! NULL ptrs, and these may (probably will) point to </span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">                                                                  !! some of the same arrays as Tr does.  tv is required</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">                                                                  !! for epipycnal mixing between mixed layer and the interior.</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    ihdxdy, &amp;     <span class="comment">! The inverse of the volume or mass of fluid in a layer in a</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                  <span class="comment">! grid cell, in m-3 or kg-1.</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    kh_h, &amp;       <span class="comment">! The tracer diffusivity averaged to tracer points, in m2 s-1.</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    cfl, &amp;        <span class="comment">! A diffusive CFL number for each cell, nondim.</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    dtr           <span class="comment">! The change in a tracer&#39;s concentration, in units of</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;                  <span class="comment">! concentration.</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span> :: &amp;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    khdt_x, &amp;     <span class="comment">! The value of Khtr*dt times the open face width divided by</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;                  <span class="comment">! the distance between adjacent tracer points, in m2.</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    coef_x, &amp;     <span class="comment">! The coefficients relating zonal tracer differences</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                  <span class="comment">! to time-integrated fluxes, in m3 or kg.</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    kh_u          <span class="comment">! Tracer mixing coefficient at u-points, in m2 s-1.</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span> :: &amp;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    khdt_y, &amp;     <span class="comment">! The value of Khtr*dt times the open face width divided by</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                  <span class="comment">! the distance between adjacent tracer points, in m2.</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    coef_y, &amp;     <span class="comment">! The coefficients relating meridional tracer differences</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;                  <span class="comment">! to time-integrated fluxes, in m3 or kg.</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    kh_v          <span class="comment">! Tracer mixing coefficient at u-points, in m2 s-1.</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordtype">real</span> :: max_cfl <span class="comment">! The global maximum of the diffusive CFL number.</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordtype">logical</span> :: use_varmix, resoln_scaled</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz, ntr, itt, num_itts</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="keywordtype">real</span> :: i_numitts  <span class="comment">! The inverse of the number of iterations, num_itts.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordtype">real</span> :: scale      <span class="comment">! The fraction of khdt_x or khdt_y that is applied in this</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;                     <span class="comment">! layer for this iteration, nondim.</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="keywordtype">real</span> :: idt        <span class="comment">! The inverse of the time step, in s-1.</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keywordtype">real</span> :: h_neglect  <span class="comment">! A thickness that is so small it is usually lost</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                     <span class="comment">! in roundoff and can be neglected, in m.</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordtype">real</span> :: kh_loc     <span class="comment">! The local value of Kh, in m2 s-1.</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keywordtype">real</span> :: res_fn     <span class="comment">! The local value of the resolution function, nondim.</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordtype">real</span> :: rd_dx      <span class="comment">! The local value of deformation radius over grid-spacing, nondim.</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keywordtype">real</span> :: normalize  <span class="comment">! normalization used for diagnostic Kh_h; diffusivity averaged to h-points. </span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  is = g%isc ; ie = g%iec ; js = g%jsc ; je = g%jec ; nz = gv%ke</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="keywordflow">if</span> (.not. <span class="keyword">associated</span>(cs)) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_hor_diff: &quot;</span>// &amp;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;       <span class="stringliteral">&quot;register_tracer must be called before tracer_hordiff.&quot;</span>)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="keywordflow">if</span> (loc(reg)==0) <span class="keyword">call </span>mom_error(fatal, <span class="stringliteral">&quot;MOM_tracer_hor_diff: &quot;</span>// &amp;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;       <span class="stringliteral">&quot;register_tracer must be called before tracer_hordiff.&quot;</span>)</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <span class="keywordflow">if</span> ((reg%ntr==0) .or. ((cs%KhTr &lt;= 0.0) .and. .not.<span class="keyword">associated</span>(varmix)) ) <span class="keywordflow">return</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;tracer_hordiff(), MOM_tracer_hor_diff.F90&quot;</span>)</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_diffuse)</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  ntr = reg%ntr</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  idt = 1.0/dt</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  h_neglect = gv%H_subroundoff</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="keywordflow">if</span> (cs%Diffuse_ML_interior .and. cs%first_call) <span class="keywordflow">then</span> ; <span class="keywordflow">if</span> (is_root_pe()) <span class="keywordflow">then</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">do</span> m=1,ntr ; <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df_x) .or. <span class="keyword">associated</span>(reg%Tr(m)%df_y)) &amp;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;tracer_hordiff: Tracer &quot;</span>//trim(reg%Tr(m)%name)// &amp;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;          <span class="stringliteral">&quot; has associated 3-d diffusive flux diagnostics.  These are not &quot;</span>//&amp;</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;          <span class="stringliteral">&quot;valid when DIFFUSE_ML_TO_INTERIOR is defined. Use 2-d tracer &quot;</span>//&amp;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;          <span class="stringliteral">&quot;diffusion diagnostics instead to get accurate total fluxes.&quot;</span>)</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keywordflow">  endif</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  cs%first_call = .false.</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;Before tracer diffusion &quot;</span>, reg%Tr, ntr, g)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  use_varmix = .false. ; resoln_scaled = .false.</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">Associated</span>(varmix)) <span class="keywordflow">then</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    use_varmix = varmix%use_variable_mixing</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    resoln_scaled = varmix%Resoln_scaled_KhTr</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keyword">call </span>create_group_pass(cs%pass_t, reg%Tr(m)%t(:,:,:), g%Domain)</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Calculating diffusivity (tracer_hordiff)&quot;</span>)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="keywordflow">if</span> (use_varmix) <span class="keywordflow">then</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,CS,VarMix,MEKE,Resoln_scaled, &amp;</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">!$OMP                               Kh_u,Kh_v,khdt_x,dt,G,khdt_y)                        &amp;</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">!$OMP                       private(Kh_loc,Rd_dx) </span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;      kh_loc = cs%KhTr + cs%KhTr_Slope_Cff*varmix%L2u(i,j)*varmix%SN_u(i,j)</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) &amp;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;        kh_loc = kh_loc + meke%KhTr_fac*sqrt(meke%Kh(i,j)*meke%Kh(i+1,j))</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;      <span class="keywordflow">if</span> (cs%KhTr_max &gt; 0.) kh_loc = min(kh_loc, cs%KhTr_max)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;      <span class="keywordflow">if</span> (resoln_scaled) &amp;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        kh_loc = kh_loc * 0.5*(varmix%Res_fn_h(i,j) + varmix%Res_fn_h(i+1,j))</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      kh_u(i,j) = max(kh_loc, cs%KhTr_min)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      <span class="keywordflow">if</span> (cs%KhTr_passivity_coeff&gt;0.) <span class="keywordflow">then</span> <span class="comment">! Apply passivity</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        rd_dx=0.5*( varmix%Rd_dx_h(i,j)+varmix%Rd_dx_h(i+1,j) ) <span class="comment">! Rd/dx at u-points</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        kh_loc=kh_u(i,j)*max( cs%KhTr_passivity_min, cs%KhTr_passivity_coeff*rd_dx )</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        <span class="keywordflow">if</span> (cs%KhTr_max &gt; 0.) kh_loc = min(kh_loc, cs%KhTr_max) <span class="comment">! Re-apply max</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        kh_u(i,j) = max(kh_loc, cs%KhTr_min) <span class="comment">! Re-apply min</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;      kh_loc = cs%KhTr + cs%KhTr_Slope_Cff*varmix%L2v(i,j)*varmix%SN_v(i,j)</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <span class="keywordflow">if</span> (<span class="keyword">associated</span>(meke%Kh)) &amp;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;        kh_loc = kh_loc + meke%KhTr_fac*sqrt(meke%Kh(i,j)*meke%Kh(i,j+1))</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="keywordflow">if</span> (cs%KhTr_max &gt; 0.) kh_loc = min(kh_loc, cs%KhTr_max)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="keywordflow">if</span> (resoln_scaled) &amp;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        kh_loc = kh_loc * 0.5*(varmix%Res_fn_h(i,j) + varmix%Res_fn_h(i,j+1))</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      kh_v(i,j) = max(kh_loc, cs%KhTr_min)</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;      <span class="keywordflow">if</span> (cs%KhTr_passivity_coeff&gt;0.) <span class="keywordflow">then</span> <span class="comment">! Apply passivity</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        rd_dx=0.5*( varmix%Rd_dx_h(i,j)+varmix%Rd_dx_h(i,j+1) ) <span class="comment">! Rd/dx at v-points</span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        kh_loc=kh_v(i,j)*max( cs%KhTr_passivity_min, cs%KhTr_passivity_coeff*rd_dx )</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        <span class="keywordflow">if</span> (cs%KhTr_max &gt; 0.) kh_loc = min(kh_loc, cs%KhTr_max) <span class="comment">! Re-apply max</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        kh_v(i,j) = max(kh_loc, cs%KhTr_min) <span class="comment">! Re-apply min</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      khdt_x(i,j) = dt*(kh_u(i,j)*(g%dy_Cu(i,j)*g%IdxCu(i,j)))</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      khdt_y(i,j) = dt*(kh_v(i,j)*(g%dx_Cv(i,j)*g%IdyCv(i,j)))</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="keywordflow">elseif</span> (resoln_scaled) <span class="keywordflow">then</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,VarMix,Kh_u,Kh_v,khdt_x,khdt_y,CS,dt,G) &amp;</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">!$OMP                       private(Res_fn)</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      res_fn = 0.5 * (varmix%Res_fn_h(i,j) + varmix%Res_fn_h(i+1,j))</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      kh_u(i,j) = max(cs%KhTr * res_fn, cs%KhTr_min)</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;      khdt_x(i,j) = dt*(cs%KhTr*(g%dy_Cu(i,j)*g%IdxCu(i,j))) * res_fn</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;      res_fn = 0.5*(varmix%Res_fn_h(i,j) + varmix%Res_fn_h(i,j+1))</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;      kh_v(i,j) = max(cs%KhTr * res_fn, cs%KhTr_min)</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;      khdt_y(i,j) = dt*(cs%KhTr*(g%dx_Cv(i,j)*g%IdyCv(i,j))) * res_fn</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">!$OMP parallel default(none) shared(is,ie,js,je,Kh_u,Kh_v,khdt_x,khdt_y,CS,G,dt)</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">if</span> (cs%id_KhTr_u &gt; 0) <span class="keywordflow">then</span> </div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        kh_u(i,j) = cs%KhTr</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        khdt_x(i,j) = dt*(cs%KhTr*(g%dy_Cu(i,j)*g%IdxCu(i,j)))</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> </div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">!$OMP do </span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;        khdt_x(i,j) = dt*(cs%KhTr*(g%dy_Cu(i,j)*g%IdxCu(i,j)))</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> </div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keywordflow">if</span> (cs%id_KhTr_v &gt; 0) <span class="keywordflow">then</span> </div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        kh_v(i,j) = cs%KhTr</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;        khdt_y(i,j) = dt*(cs%KhTr*(g%dx_Cv(i,j)*g%IdyCv(i,j)))</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> </div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordflow">else</span> </div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">!$OMP do</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;        khdt_y(i,j) = dt*(cs%KhTr*(g%dx_Cv(i,j)*g%IdyCv(i,j)))</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> </div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">!$OMP end parallel</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="keywordflow">if</span> (cs%check_diffusive_CFL) <span class="keywordflow">then</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Checking diffusive CFL (tracer_hordiff)&quot;</span>)</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    max_cfl = 0.0</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      cfl(i,j) = 2.0*((khdt_x(i-1,j) + khdt_x(i,j)) + &amp;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                      (khdt_y(i,j-1) + khdt_y(i,j))) * g%IareaT(i,j)</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      <span class="keywordflow">if</span> (max_cfl &lt; cfl(i,j)) max_cfl = cfl(i,j)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_sync)</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="keyword">call </span>max_across_pes(max_cfl)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_sync)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    num_itts = max(1,ceiling(max_cfl))</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    i_numitts = 1.0 ; <span class="keywordflow">if</span> (num_itts &gt; 1) i_numitts = 1.0 / (<span class="keywordtype">real</span>(num_itts))</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">if</span>(cs%id_CFL &gt; 0) <span class="keyword">call </span>post_data(cs%id_CFL, cfl, cs%diag, mask=g%mask2dT)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    num_itts = 1 ; i_numitts = 1.0</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df_x)) <span class="keywordflow">then</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        reg%Tr(m)%df_x(i,j,k) = 0.0</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df_y)) <span class="keywordflow">then</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        reg%Tr(m)%df_y(i,j,k) = 0.0</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="keywordflow">      enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df2d_x)) <span class="keywordflow">then</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;      <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie ; reg%Tr(m)%df2d_x(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df2d_y)) <span class="keywordflow">then</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;      <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie ; reg%Tr(m)%df2d_y(i,j) = 0.0 ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  <span class="keywordflow">if</span> (cs%use_neutral_diffusion) <span class="keywordflow">then</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Calling neutral diffusion coeffs (tracer_hordiff)&quot;</span>)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_t, g%Domain)</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="comment">! We are assuming that neutral surfaces do not evolve (much) as a result of multiple</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <span class="comment">! lateral diffusion iterations. Otherwise the call to neutral_diffusion_calc_coeffs()</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">! would be inside the itt-loop. -AJA</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keyword">call </span>neutral_diffusion_calc_coeffs(g, gv, h, tv%T, tv%S, tv%eqn_of_state, &amp;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                       cs%neutral_diffusion_CSp)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      coef_y(i,j) = i_numitts * khdt_y(i,j)</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        coef_x(i,j) = i_numitts * khdt_x(i,j)</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">do</span> itt=1,num_itts</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Calling neutral diffusion (tracer_hordiff)&quot;</span>,itt)</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      <span class="keywordflow">if</span> (itt&gt;1) <span class="keywordflow">then</span> <span class="comment">! Update halos for subsequent iterations</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;        <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keyword">call </span>do_group_pass(cs%pass_t, g%Domain)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      <span class="keywordflow">do</span> m=1,ntr <span class="comment">! for each tracer</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        <span class="keyword">call </span>neutral_diffusion(g, gv,  h, coef_x, coef_y, reg%Tr(m)%t, m, i_numitts*dt, &amp;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                               reg%Tr(m)%name, cs%neutral_diffusion_CSp)</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! m</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! itt</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  <span class="keywordflow">else</span>    <span class="comment">! following if not using neutral diffusion, but instead along-surface diffusion </span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Calculating horizontal diffusion (tracer_hordiff)&quot;</span>)</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">do</span> itt=1,num_itts</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_t, g%Domain)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,I_numitts,CS,G,GV,khdt_y,h, &amp;</span></div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">!$OMP                                    h_neglect,khdt_x,ntr,Idt,Reg)           &amp;</span></div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">!$OMP                            private(scale,Coef_y,Coef_x,Ihdxdy,dTr)</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        scale = i_numitts</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        <span class="keywordflow">if</span> (cs%Diffuse_ML_interior) <span class="keywordflow">then</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;          <span class="keywordflow">if</span> (k&lt;=gv%nkml) <span class="keywordflow">then</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;            <span class="keywordflow">if</span> (cs%ML_KhTr_scale &lt;= 0.0) cycle</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            scale = i_numitts * cs%ML_KhTr_scale</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;          <span class="keywordflow">if</span> ((k&gt;gv%nkml) .and. (k&lt;=gv%nk_rho_varies)) cycle</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;          coef_y(i,j) = ((scale * khdt_y(i,j))*2.0*(h(i,j,k)*h(i,j+1,k))) / &amp;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                                                   (h(i,j,k)+h(i,j+1,k)+h_neglect)</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keywordflow">        enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;          <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;            coef_x(i,j) = ((scale * khdt_x(i,j))*2.0*(h(i,j,k)*h(i+1,j,k))) / &amp;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                                                     (h(i,j,k)+h(i+1,j,k)+h_neglect)</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;          <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            ihdxdy(i,j) = g%IareaT(i,j) / (h(i,j,k)+h_neglect)</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;        <span class="keywordflow">do</span> m=1,ntr</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;          <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            dtr(i,j) = ihdxdy(i,j) * &amp;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;              ((coef_x(i-1,j) * (reg%Tr(m)%t(i-1,j,k) - reg%Tr(m)%t(i,j,k)) - &amp;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                coef_x(i,j) * (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i+1,j,k))) + &amp;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;               (coef_y(i,j-1) * (reg%Tr(m)%t(i,j-1,k) - reg%Tr(m)%t(i,j,k)) - &amp;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                coef_y(i,j) * (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i,j+1,k))))</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df_x)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=g%IscB,g%IecB</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            reg%Tr(m)%df_x(i,j,k) = reg%Tr(m)%df_x(i,j,k) + coef_x(i,j) * &amp;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                                (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i+1,j,k))*idt</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df_y)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=g%JscB,g%JecB ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            reg%Tr(m)%df_y(i,j,k) = reg%Tr(m)%df_y(i,j,k) + coef_y(i,j) * &amp;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                                (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i,j+1,k))*idt</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df2d_x)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=g%IscB,g%IecB</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            reg%Tr(m)%df2d_x(i,j) = reg%Tr(m)%df2d_x(i,j) + coef_x(i,j) * &amp;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                                (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i+1,j,k))*idt</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;          <span class="keywordflow">if</span> (<span class="keyword">associated</span>(reg%Tr(m)%df2d_y)) <span class="keywordflow">then</span> ; <span class="keywordflow">do</span> j=g%JscB,g%JecB ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            reg%Tr(m)%df2d_y(i,j) = reg%Tr(m)%df2d_y(i,j) + coef_y(i,j) * &amp;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                                (reg%Tr(m)%t(i,j,k) - reg%Tr(m)%t(i,j+1,k))*idt</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> endif</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;          <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            reg%Tr(m)%t(i,j,k) = reg%Tr(m)%t(i,j,k) + dtr(i,j)</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="keywordflow">          enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">      enddo</span> <span class="comment">! End of k loop.</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">    enddo</span> <span class="comment">! End of &quot;while&quot; loop.</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordflow">  endif</span>   <span class="comment">! endif for CS%use_neutral_diffusion </span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_diffuse)</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordflow">if</span> (cs%Diffuse_ML_interior) <span class="keywordflow">then</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;Calling epipycnal_ML_diff (tracer_hordiff)&quot;</span>)</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;Before epipycnal diff &quot;</span>, reg%Tr, ntr, g)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_epimix)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keyword">call </span>tracer_epipycnal_ml_diff(h, dt, reg%Tr, ntr, khdt_x, khdt_y, g, gv, &amp;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                                  cs, tv, num_itts)</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_epimix)</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keyword">call </span>mom_tracer_chksum(<span class="stringliteral">&quot;After tracer diffusion &quot;</span>, reg%Tr, ntr, g)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="comment">! post diagnostics for 2d tracer diffusivity </span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  <span class="keywordflow">if</span> (cs%id_KhTr_u &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      kh_u(i,j) = g%mask2dCu(i,j)*kh_u(i,j)</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="keyword">call </span>post_data(cs%id_KhTr_u, kh_u, cs%diag, mask=g%mask2dCu)</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordflow">if</span> (cs%id_KhTr_v &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      kh_v(i,j) = g%mask2dCv(i,j)*kh_v(i,j)</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keyword">call </span>post_data(cs%id_KhTr_v, kh_v, cs%diag, mask=g%mask2dCv)</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keywordflow">if</span> (cs%id_KhTr_h &gt; 0) <span class="keywordflow">then</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    kh_h(:,:) = 0.0</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;      kh_u(i,j) = g%mask2dCu(i,j)*kh_u(i,j)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      kh_v(i,j) = g%mask2dCv(i,j)*kh_v(i,j)</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;      <span class="comment">!### Add parentheses.</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      normalize = 1.0 / (g%mask2dCu(i-1,j)+g%mask2dCu(i,j) + &amp;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                  g%mask2dCv(i,j-1)+g%mask2dCv(i,j) + gv%H_subroundoff)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      kh_h(i,j) = normalize*g%mask2dT(i,j)*(kh_u(i-1,j)+kh_u(i,j) + &amp;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;                                            kh_v(i,j-1)+kh_v(i,j))</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keyword">call </span>post_data(cs%id_KhTr_h, kh_h, cs%diag, mask=g%mask2dT)</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="keywordflow">  endif</span> </div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordflow">if</span> (cs%show_call_tree) <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;tracer_hordiff()&quot;</span>)</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../da/db2/namespacemom__tracer__hor__diff_ae8eba26c164a4e8e4ba1008cda9850e6_cgraph.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ad2e47d2af24603c7e589ee65ad33901b"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_hor_diff::id_clock_diffuse</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">77</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01306">tracer_hor_diff_init()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">tracer_hordiff()</a>.</p>
<div class="fragment"><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keywordtype">integer</span> :: id_clock_diffuse, id_clock_epimix, id_clock_pass, id_clock_sync</div></div><!-- fragment -->
</div>
</div>
<a id="afb8e3e165b35c4b6e220afe5706cd69a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_hor_diff::id_clock_epimix</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">77</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01306">tracer_hor_diff_init()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">tracer_hordiff()</a>.</p>

</div>
</div>
<a id="ac92a65798be694ec5a56720c56e38603"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_hor_diff::id_clock_pass</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">77</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00462">tracer_epipycnal_ml_diff()</a>, <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01306">tracer_hor_diff_init()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">tracer_hordiff()</a>.</p>

</div>
</div>
<a id="a75364bb3145fbbf8bc8bffeaa4bc10fd"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">integer mom_tracer_hor_diff::id_clock_sync</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">private</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Definition at line <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00077">77</a> of file <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html">MOM_tracer_hor_diff.F90</a>.</p>

<p>Referenced by <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l01306">tracer_hor_diff_init()</a>, and <a class="el" href="../../d7/dbb/MOM__tracer__hor__diff_8F90_source.html#l00086">tracer_hordiff()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../da/db2/namespacemom__tracer__hor__diff.html">mom_tracer_hor_diff</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
